{% extends "base.html" %}

{% block title %}Products - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-4 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg rounded-xl p-4 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="mb-2 md:mb-0">
                <h1 class="text-xl md:text-2xl font-bold">Product Management</h1>
                <p class="text-blue-100 text-sm">Manage your inventory products and categories</p>
            </div>
            {% if user and (user.role == 'admin' or user.role == 'manager') %}
            <button onclick="openAddProductModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm">
                <i class="fas fa-plus"></i>
                <span class="font-medium">Add Product</span>
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <!-- Total Products -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-boxes text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Total Products</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-products">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-blue-700 font-medium">In inventory</span>
                </div>
            </div>
        </div>

        <!-- In Stock -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-check-circle text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">In Stock</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="in-stock">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-green-700 font-medium">Available for sale</span>
                </div>
            </div>
        </div>

        <!-- Low Stock -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-exclamation-triangle text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Low Stock</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="low-stock">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-yellow-50 to-orange-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-orange-700 font-medium">Needs restocking</span>
                </div>
            </div>
        </div>

        <!-- Out of Stock -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-red-400 to-red-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-times-circle text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Out of Stock</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="out-of-stock">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-red-50 to-red-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-red-700 font-medium">Immediate attention</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300">
        <!-- Table Header with Search & Filters -->
        <div class="px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-table text-white text-xs"></i>
                    </div>
                    <h3 class="text-base font-semibold text-gray-900">Products Inventory</h3>
                </div>

                <!-- Compact Search & Filter Controls -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <div class="relative">
                        <input type="text" id="search-products" placeholder="Search products..."
                               class="pl-7 pr-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-40 text-xs transition-all duration-200">
                        <i class="fas fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                    </div>
                    <select id="category-filter" class="px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs transition-all duration-200">
                        <option value="">All Categories</option>
                    </select>
                    <select id="stock-filter" class="px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs transition-all duration-200">
                        <option value="">All Stock</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                        <option value="out-of-stock">Out of Stock</option>
                    </select>
                    <div class="flex space-x-1">
                        <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1.5 rounded-lg flex items-center space-x-1 text-xs transition-all duration-200">
                            <i class="fas fa-refresh text-xs"></i>
                            <span>Refresh</span>
                        </button>
                        <button onclick="exportProducts()" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1.5 rounded-lg flex items-center space-x-1 text-xs transition-all duration-200">
                            <i class="fas fa-download text-xs"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Product</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Price</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table-body" class="bg-white divide-y divide-gray-100">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Products Status Section -->
        <div id="products-status-container" class="mt-4 px-4 py-3 bg-white border-t border-gray-200">
            <div class="flex flex-col items-center space-y-3">
                <!-- Results info -->
                <div class="text-sm text-gray-700">
                    Showing <span id="showing-products-count" class="font-medium">0</span> of <span id="total-products-count" class="font-medium">0</span> products
                </div>

                <!-- Auto-loading indicator -->
                <div id="auto-loading-products-indicator" class="hidden flex items-center justify-center space-x-3 py-4 text-gray-600 bg-blue-50 rounded-lg border border-blue-200 transition-all duration-300">
                    <div class="animate-spin rounded-full h-5 w-5 border-2 border-blue-600 border-t-transparent"></div>
                    <span class="text-sm font-medium">Loading more products...</span>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>

                <!-- End of results message -->
                <div id="end-of-products" class="hidden text-center py-6">
                    <div class="inline-flex items-center justify-center space-x-3 px-6 py-3 bg-green-50 border border-green-200 rounded-lg text-green-700">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-500 text-lg"></i>
                        </div>
                        <div class="text-sm font-medium">
                            You've reached the end of all products
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-plus text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Add New Product</h3>
                    </div>
                    <button type="button" onclick="closeAddProductModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <form id="add-product-form" method="POST" action="/products/" class="p-4 space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-tag text-gray-400 mr-1"></i>Product Name
                    </label>
                    <input type="text" name="name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Enter product name">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-folder text-gray-400 mr-1"></i>Category
                    </label>
                    <select name="category_id" id="category-select" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" onchange="togglePerfumeSettings()">
                        <option value="">Select Category</option>
                        <!-- Categories will be loaded here -->
                    </select>
                    <div class="mt-2 flex items-center justify-between">
                        <p class="text-xs text-gray-500">
                            Don't see your category? <a href="/categories" target="_blank" class="text-blue-600 hover:text-blue-500 underline font-medium">Create new category</a>
                        </p>
                        <button type="button" onclick="loadCategories()" class="text-xs text-gray-500 hover:text-gray-700 flex items-center transition-colors duration-200">
                            <i class="fas fa-refresh mr-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>


                <!-- Product Image Upload -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-image text-gray-400 mr-1"></i>Product Image
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-purple-400 transition-colors duration-200">
                        <input type="file" id="product-image" name="product_image" accept="image/*" class="hidden" onchange="handleImagePreview(this, 'add-image-preview')">
                        <div id="add-image-preview" class="mb-2">
                            <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Click to upload product image</p>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP up to 10MB</p>
                        </div>
                        <button type="button" onclick="document.getElementById('product-image').click()" class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                            Choose Image
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-dollar-sign text-gray-400 mr-1"></i>Cost Price (UGX)
                        </label>
                        <input type="number" id="add-cost-price" name="cost_price" step="0.01" min="0" placeholder="1200" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" onchange="calculateProfitMargin()">
                        <p class="text-xs text-gray-500 mt-1">What you buy it for</p>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-money-bill text-gray-400 mr-1"></i>Selling Price (UGX)
                        </label>
                        <input type="number" id="add-selling-price" name="price" step="0.01" min="0" placeholder="2000" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" onchange="calculateProfitMargin()">
                        <p class="text-xs text-gray-500 mt-1">What you sell it for</p>
                    </div>
                </div>
                <!-- Profit Margin Display -->
                <div id="profit-margin-display" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-chart-line text-green-600 mr-2"></i>
                            <span class="text-sm font-medium text-green-800">Profit Analysis</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-green-800" id="profit-amount">+UGX 0</div>
                            <div class="text-xs text-green-600" id="profit-percentage">0% margin</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-boxes text-gray-400 mr-1"></i>Stock Quantity
                        </label>
                        <input type="number" name="stock_quantity" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="100">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-exclamation-triangle text-gray-400 mr-1"></i>Min Stock Level
                        </label>
                        <input type="number" name="min_stock_level" min="0" value="4" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="4">
                        <p class="text-xs text-gray-500 mt-1">Alert when stock falls to this level</p>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-cube text-gray-400 mr-1"></i>Unit
                        </label>
                        <input type="text" name="unit" value="pcs" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="pcs, kg, liters">
                    </div>
                </div>
                <!-- Supplier -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-truck text-gray-400 mr-1"></i>Supplier
                    </label>
                    <select name="supplier" id="supplier-select" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="">Select Supplier (Optional)</option>
                        <!-- Suppliers will be loaded here -->
                    </select>
                    <div class="mt-1 flex items-center justify-between">
                        <p class="text-xs text-gray-500">
                            Don't see your supplier? <a href="/suppliers" target="_blank" class="text-blue-600 hover:text-blue-500 underline font-medium">Manage suppliers</a>
                        </p>
                        <button type="button" onclick="loadSuppliers()" class="text-xs text-gray-500 hover:text-gray-700 flex items-center transition-colors duration-200">
                            <i class="fas fa-refresh mr-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <!-- Barcode -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-qrcode text-gray-400 mr-1"></i>Barcode
                    </label>
                    <input type="text" name="barcode" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Optional">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-align-left text-gray-400 mr-1"></i>Description
                    </label>
                    <textarea name="description" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none" placeholder="Enter product description (optional)"></textarea>
                </div>

                <!-- Perfume Toggle Button -->
                <div class="border-t border-gray-200 pt-3">
                    <button type="button" onclick="manualTogglePerfumeSettings()" class="flex items-center justify-between w-full p-3 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200 transition-all duration-200" style="display: none;">
                        <div class="flex items-center">
                            <i class="fas fa-spray-can text-purple-600 mr-2"></i>
                            <span class="text-sm font-semibold text-gray-700">Perfume Product Settings</span>
                            <span class="ml-2 text-xs text-gray-500">(Click to configure decants)</span>
                        </div>
                        <i id="perfume-toggle-icon" class="fas fa-chevron-down text-purple-600 transition-transform duration-200"></i>
                    </button>

                    <!-- Perfume-Specific Fields (Hidden by default) -->
                    <div id="perfume-settings" class="hidden mt-3 p-4 bg-white rounded-lg border border-purple-200">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-flask text-gray-400 mr-1"></i>Bottle Size (ml)
                                </label>
                                <input type="number" name="bottle_size_ml" step="0.1" min="0" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="e.g., 100">
                                <p class="text-xs text-gray-500 mt-1">Size of each bottle in ml</p>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-spray-can text-gray-400 mr-1"></i>Scents
                                </label>
                                <select name="scent_ids" id="scent-select" multiple class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200 min-h-[80px]">
                                    <!-- Scents will be loaded here -->
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple scents</p>
                            </div>
                        </div>

                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="is-decantable" name="is_decantable" class="h-3 w-3 text-purple-600 focus:ring-purple-500 border-gray-300 rounded" onchange="toggleDecantFields()">
                            <label for="is-decantable" class="ml-2 block text-xs font-medium text-gray-700">
                                <i class="fas fa-cut text-purple-600 mr-1"></i>Enable Decants
                            </label>
                        </div>

                        <div id="decant-fields" class="hidden p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-vial text-gray-400 mr-1"></i>Decant Size (ml)
                                    </label>
                                    <input type="number" name="decant_size_ml" step="0.1" min="0" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="e.g., 10">
                                    <p class="text-xs text-gray-500 mt-1">Size of each decant</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-money-bill text-gray-400 mr-1"></i>Decant Price (UGX)
                                    </label>
                                    <input type="number" name="decant_price" step="0.01" min="0" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" placeholder="e.g., 30000">
                                    <p class="text-xs text-gray-500 mt-1">Price per decant</p>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-purple-100 rounded border border-purple-300">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-purple-600 mr-2 mt-0.5"></i>
                                    <div class="text-xs text-purple-800">
                                        <strong>Decant Info:</strong> When enabled, you can sell smaller portions (decants) from opened bottles. The system will track ml remaining in opened bottles and automatically open new bottles when needed.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <input type="checkbox" name="is_active" checked class="h-3 w-3 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label class="ml-2 block text-xs font-medium text-blue-900">
                        <i class="fas fa-toggle-on text-blue-600 mr-1"></i>Product is active
                    </label>
                    <span class="ml-2 text-xs text-blue-600">Product will be available for sale</span>
                </div>

                <!-- Expense Creation Section -->
                <div class="border-t border-gray-200 pt-3">
                    <div class="flex items-center p-3 bg-green-50 rounded-lg border border-green-200 mb-3">
                        <input type="checkbox" id="create-expense" name="create_expense" checked disabled class="h-3 w-3 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        <label class="ml-2 block text-xs font-medium text-green-900">
                            <i class="fas fa-receipt text-green-600 mr-1"></i>Create stocking expense
                        </label>
                        <span class="ml-2 text-xs text-green-600">Automatically track the cost of this initial stock (Required)</span>
                    </div>

                    <!-- Expense Fields (Always visible now) -->
                    <div id="expense-fields" class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-credit-card text-gray-400 mr-1"></i>Payment Method
                            </label>
                            <select name="payment_method" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                                <option value="">Select Payment Method</option>
                                <option value="pending">Pending Payment</option>
                                <option value="cash">Cash</option>
                                <option value="mobile_money">Mobile Money</option>
                            </select>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-2 mt-0.5"></i>
                                <div class="text-xs text-blue-800">
                                    <strong>Expense Details:</strong><br>
                                    • Unit cost will be taken from "Cost Price" field above<br>
                                    • Total cost = Cost Price × Stock Quantity<br>
                                    • Expense will be categorized as "Stocking"<br>
                                    • Supplier will be used as vendor if selected<br>
                                    • Payment method will be saved with the product
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="closeAddProductModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-plus mr-1"></i>Add Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <!-- Modal Header -->
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-edit text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Edit Product</h3>
                    </div>
                    <button type="button" onclick="closeEditProductModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="edit-modal-loading" class="p-4 space-y-3">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-1/4 mb-2"></div>
                    <div class="h-10 bg-gray-200 rounded mb-4"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="h-4 bg-gray-200 rounded w-1/3 mb-2"></div>
                            <div class="h-10 bg-gray-200 rounded"></div>
                        </div>
                        <div>
                            <div class="h-4 bg-gray-200 rounded w-1/3 mb-2"></div>
                            <div class="h-10 bg-gray-200 rounded"></div>
                        </div>
                    </div>
                </div>
            </div>

            <form id="edit-product-form" class="p-4 space-y-3 hidden">
                <!-- Product Name -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-tag text-gray-400 mr-1"></i>Product Name
                    </label>
                    <input type="text" id="edit-name" name="name" required
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                           placeholder="Enter product name">
                </div>

                <!-- Category -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-folder text-gray-400 mr-1"></i>Category
                    </label>
                    <select id="edit-category-id" name="category_id" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="">Select Category</option>
                    </select>
                    <div class="mt-2 flex items-center justify-between">
                        <p class="text-xs text-gray-500">
                            Don't see your category? <a href="/categories" target="_blank" class="text-blue-600 hover:text-blue-500 underline font-medium">Create new category</a>
                        </p>
                        <button type="button" onclick="loadCategoriesForEdit()" class="text-xs text-gray-500 hover:text-gray-700 flex items-center transition-colors duration-200">
                            <i class="fas fa-refresh mr-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Product Image Upload -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-image text-gray-400 mr-1"></i>Product Image
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-purple-400 transition-colors duration-200">
                        <input type="file" id="edit-product-image" name="product_image" accept="image/*" class="hidden" onchange="handleImagePreview(this, 'edit-image-preview')">
                        <div id="edit-image-preview" class="mb-2">
                            <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
                            <p class="text-sm text-gray-600">Click to upload or change product image</p>
                            <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP up to 10MB</p>
                        </div>
                        <div class="flex gap-2 justify-center">
                            <button type="button" onclick="document.getElementById('edit-product-image').click()" class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                                Choose Image
                            </button>
                            <button type="button" id="delete-image-btn" onclick="deleteProductImage()" class="text-red-600 hover:text-red-700 text-sm font-medium hidden">
                                Delete Image
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pricing Section -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-dollar-sign text-gray-400 mr-1"></i>Cost Price (UGX)
                        </label>
                        <input type="number" id="edit-cost-price" name="cost_price" step="0.01" min="0" placeholder="1200"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               onchange="calculateEditProfitMargin()">
                        <p class="text-xs text-gray-500 mt-1">What you buy it for</p>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-money-bill text-gray-400 mr-1"></i>Selling Price (UGX)
                        </label>
                        <input type="number" id="edit-price" name="price" step="0.01" min="0" placeholder="2000" required
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               onchange="calculateEditProfitMargin()">
                        <p class="text-xs text-gray-500 mt-1">What you sell it for</p>
                    </div>
                </div>

                <!-- Profit Margin Display -->
                <div id="edit-profit-margin-display" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-chart-line text-green-600 mr-2"></i>
                            <span class="text-sm font-medium text-green-800">Profit Analysis</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-green-800" id="edit-profit-amount">+UGX 0</div>
                            <div class="text-xs text-green-600" id="edit-profit-percentage">0% margin</div>
                        </div>
                    </div>
                </div>

                <!-- Stock Management -->
                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-boxes text-gray-400 mr-1"></i>Stock Quantity
                        </label>
                        <input type="number" id="edit-stock-quantity" name="stock_quantity" min="0" required
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="100">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-exclamation-triangle text-gray-400 mr-1"></i>Min Stock Level
                        </label>
                        <input type="number" id="edit-min-stock-level" name="min_stock_level" min="0" value="10"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="4">
                        <p class="text-xs text-gray-500 mt-1">Alert when stock falls to this level</p>
                    </div>

                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-cube text-gray-400 mr-1"></i>Unit
                        </label>
                        <input type="text" id="edit-unit" name="unit" value="pcs"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="pcs, kg, liters">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-truck text-gray-400 mr-1"></i>Supplier
                        </label>
                        <select id="edit-supplier" name="supplier" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            <option value="">Select Supplier (Optional)</option>
                            <!-- Suppliers will be loaded here -->
                        </select>
                        <div class="mt-1 flex items-center justify-between">
                            <p class="text-xs text-gray-500">
                                Don't see your supplier? <a href="/suppliers" target="_blank" class="text-blue-600 hover:text-blue-500 underline font-medium">Manage suppliers</a>
                            </p>
                            <button type="button" onclick="loadSuppliersForEdit()" class="text-xs text-gray-500 hover:text-gray-700 flex items-center transition-colors duration-200">
                                <i class="fas fa-refresh mr-1"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-qrcode text-gray-400 mr-1"></i>Barcode
                        </label>
                        <input type="text" id="edit-barcode" name="barcode"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                               placeholder="Optional">
                    </div>

                </div>

                <!-- Description -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-align-left text-gray-400 mr-1"></i>Description
                    </label>
                    <textarea id="edit-description" name="description" rows="2"
                              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"
                              placeholder="Enter product description (optional)"></textarea>
                </div>

                <!-- Payment Method -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-credit-card text-gray-400 mr-1"></i>Payment Method
                    </label>
                    <select id="edit-payment-method" name="payment_method" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                        <option value="">Not specified</option>
                        <option value="pending">Pending Payment</option>
                        <option value="cash">Cash</option>
                        <option value="mobile_money">Mobile Money</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Payment method used for this product</p>
                </div>



                <!-- Perfume Toggle Button -->
                <div class="border-t border-gray-200 pt-3">
                    <button type="button" onclick="toggleEditPerfumeSettings()" class="flex items-center justify-between w-full p-3 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200 transition-all duration-200">
                        <div class="flex items-center">
                            <i class="fas fa-spray-can text-purple-600 mr-2"></i>
                            <span class="text-sm font-semibold text-gray-700">Perfume Product Settings</span>
                            <span class="ml-2 text-xs text-gray-500">(Click to configure decants)</span>
                        </div>
                        <i id="edit-perfume-toggle-icon" class="fas fa-chevron-down text-purple-600 transition-transform duration-200"></i>
                    </button>

                    <!-- Perfume-Specific Fields (Hidden by default) -->
                    <div id="edit-perfume-settings" class="hidden mt-3 p-4 bg-white rounded-lg border border-purple-200">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-flask text-gray-400 mr-1"></i>Bottle Size (ml)
                                </label>
                                <input type="number" id="edit-bottle-size-ml" name="bottle_size_ml" step="0.1" min="0"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                                       placeholder="e.g., 100">
                                <p class="text-xs text-gray-500 mt-1">Size of each bottle in ml</p>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-spray-can text-gray-400 mr-1"></i>Available Scents
                                </label>
                                <div id="edit-scents-container" class="border border-gray-300 rounded-lg p-2 max-h-[120px] overflow-y-auto bg-gray-50">
                                    <div class="text-xs text-gray-500 text-center py-2">
                                        <i class="fas fa-spinner fa-spin mr-1"></i>Loading scents...
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Select scents available for this product</p>
                            </div>
                        </div>

                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="edit-is-decantable" name="is_decantable"
                                   class="h-3 w-3 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                   onchange="toggleEditDecantFields()">
                            <label for="edit-is-decantable" class="ml-2 block text-xs font-medium text-gray-700">
                                <i class="fas fa-cut text-purple-600 mr-1"></i>Enable Decants
                            </label>
                        </div>

                        <div id="edit-decant-fields" class="hidden p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-vial text-gray-400 mr-1"></i>Decant Size (ml)
                                    </label>
                                    <input type="number" id="edit-decant-size-ml" name="decant_size_ml" step="0.1" min="0"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                                           placeholder="e.g., 10">
                                    <p class="text-xs text-gray-500 mt-1">Size of each decant</p>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-money-bill text-gray-400 mr-1"></i>Decant Price (UGX)
                                    </label>
                                    <input type="number" id="edit-decant-price" name="decant_price" step="0.01" min="0"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200"
                                           placeholder="e.g., 30000">
                                    <p class="text-xs text-gray-500 mt-1">Price per decant</p>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-purple-100 rounded border border-purple-300">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-purple-600 mr-2 mt-0.5"></i>
                                    <div class="text-xs text-purple-800">
                                        <strong>Decant Info:</strong> When enabled, you can sell smaller portions (decants) from opened bottles. The system will track ml remaining in opened bottles and automatically open new bottles when needed.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Status -->
                <div class="flex items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <input type="checkbox" id="edit-is-active" name="is_active" checked
                           class="h-3 w-3 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label class="ml-2 block text-xs font-medium text-blue-900">
                        <i class="fas fa-toggle-on text-blue-600 mr-1"></i>Product is active
                    </label>
                    <span class="ml-2 text-xs text-blue-600">Product will be available for sale</span>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="closeEditProductModal()"
                            class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-save mr-1"></i>Update Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restock Product Modal -->
<div id="restock-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-teal-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-plus-circle text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Restock Product</h3>
                    </div>
                    <button type="button" onclick="closeRestockModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <form id="restock-form" class="p-4 space-y-3">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        <div>
                            <h4 class="text-sm font-semibold text-blue-900" id="restock-product-name">Product Name</h4>
                            <p class="text-xs text-blue-700">Current Stock: <span id="restock-current-stock" class="font-medium">0</span> units</p>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-plus text-gray-400 mr-1"></i>Quantity to Add
                    </label>
                    <input type="number" id="restock-quantity" min="1" required
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                           placeholder="Enter quantity to add">
                    <p class="text-xs text-gray-500 mt-1">Enter the number of units to add to current stock</p>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-comment text-gray-400 mr-1"></i>Reason (Optional)
                    </label>
                    <textarea id="restock-reason" rows="2"
                              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 resize-none"
                              placeholder="e.g., New stock received from supplier, Inventory adjustment, etc."></textarea>
                </div>

                <!-- Cost Information for Automatic Expense Creation -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-receipt text-blue-500 mr-2"></i>
                        <h4 class="text-xs font-semibold text-blue-900">Cost Information (Optional)</h4>
                        <span class="ml-2 text-xs text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">Auto-creates expense</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-blue-700 mb-1">Unit Cost (UGX)</label>
                            <input type="number" id="restock-unit-cost" min="0" step="0.01"
                                   class="w-full px-3 py-2 text-sm border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                                   placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-blue-700 mb-1">Total Cost</label>
                            <input type="text" id="restock-total-cost" readonly
                                   class="w-full px-3 py-2 text-sm bg-blue-50 border border-blue-300 rounded-lg text-blue-900 font-medium"
                                   placeholder="UGX 0.00">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                        <div>
                            <label class="block text-xs font-medium text-blue-700 mb-1">Supplier</label>
                            <div class="relative">
                                <select id="restock-supplier-select"
                                        class="w-full px-3 py-2 text-sm border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                    <option value="">Select supplier</option>
                                    <!-- Suppliers will be loaded dynamically -->
                                </select>
                                <div class="absolute inset-y-0 right-8 flex items-center">
                                    <button type="button" onclick="toggleCustomSupplier()" class="text-blue-600 hover:text-blue-800 text-xs" title="Add new supplier">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-blue-700 mb-1">Payment Method</label>
                            <select id="restock-payment-method"
                                    class="w-full px-3 py-2 text-sm border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                <option value="">Select method</option>
                                <option value="cash">💵 Cash</option>
                                <option value="mobile_money">📱 Mobile Money</option>
                                <option value="card">💳 Card</option>
                            </select>
                        </div>
                    </div>

                    <p class="text-xs text-blue-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Providing cost information will automatically create an expense record for this restocking.
                    </p>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-medium text-green-700">New Stock Total:</span>
                        <span class="text-sm font-bold text-green-900" id="restock-new-total">0 units</span>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="closeRestockModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-plus-circle mr-1"></i>Restock Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div id="product-details-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-3">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full transform transition-all duration-300 max-h-[96vh] overflow-hidden">
            <!-- Compact Header -->
            <div class="px-4 py-3 bg-gradient-to-r from-slate-800 to-slate-900 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-white bg-opacity-10 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-box text-white"></i>
                        </div>
                        <h3 id="product-details-title" class="text-lg font-bold text-white">Product Details</h3>
                    </div>
                    <button type="button" onclick="closeProductDetailsModal()" class="text-white hover:text-slate-300 transition-colors duration-200 p-1 hover:bg-white hover:bg-opacity-10 rounded">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>
            </div>
            <!-- Content -->
            <div class="overflow-y-auto max-h-[calc(96vh-60px)]">
                <div id="product-details-content" class="p-4">
                    <!-- Product details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Product Modal -->
<div id="delete-product-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300" style="transform: scale(0.95); opacity: 0;">
            <div class="px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-exclamation-triangle text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Delete Product</h3>
                    </div>
                    <button type="button" onclick="closeDeleteModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <div class="p-4">
                <!-- Warning Icon -->
                <div class="flex justify-center mb-3">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-trash-alt text-red-600 text-lg"></i>
                    </div>
                </div>

                <!-- Warning Message -->
                <div class="text-center mb-4">
                    <h4 class="text-base font-semibold text-gray-900 mb-2">Are you sure?</h4>
                    <p class="text-sm text-gray-600 mb-3">You are about to permanently delete:</p>

                    <!-- Product Info -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="font-semibold text-gray-900" id="delete-product-name">Product Name</div>
                        <div class="text-sm text-gray-600" id="delete-product-category">Category: Unknown</div>
                    </div>

                    <!-- Warning Details -->
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3"></i>
                            <div class="text-left">
                                <p class="text-sm font-semibold text-red-800 mb-2">This action cannot be undone!</p>
                                <ul class="text-sm text-red-700 space-y-1">
                                    <li>• All restock history will be deleted</li>
                                    <li>• Product will be removed from inventory</li>
                                    <li>• Cannot be recovered after deletion</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Info Note -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                            <p class="text-sm text-blue-800">Existing orders containing this product will not be affected.</p>
                        </div>
                    </div>
                </div>

                <!-- Confirmation Input -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Type <span class="text-red-600 font-bold">DELETE</span> to confirm:
                    </label>
                    <input type="text" id="delete-confirmation-input"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                           placeholder="Type DELETE here"
                           autocomplete="off">
                    <div id="delete-input-error" class="text-red-600 text-sm mt-1 hidden">
                        Please type "DELETE" exactly to confirm
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeDeleteModal()"
                            class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="button" id="confirm-delete-btn" onclick="confirmDelete()"
                            class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-trash-alt mr-1"></i>Delete Product
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Product management functionality
function openAddProductModal() {
    loadCategories();
    loadSuppliers();
    loadScents(); // Load scents for the add product form
    document.getElementById('add-product-modal').classList.remove('hidden');
}

function closeAddProductModal() {
    document.getElementById('add-product-modal').classList.add('hidden');
    document.getElementById('add-product-form').reset();
    // Hide profit margin display
    document.getElementById('profit-margin-display').classList.add('hidden');
    // Hide perfume settings
    document.getElementById('perfume-settings').classList.add('hidden');
    document.getElementById('perfume-toggle-icon').classList.remove('fa-chevron-up');
    document.getElementById('perfume-toggle-icon').classList.add('fa-chevron-down');
    // Hide decant fields
    document.getElementById('decant-fields').classList.add('hidden');
    document.getElementById('is-decantable').checked = false;
}

// Toggle perfume settings section visibility based on category selection
function togglePerfumeSettings() {
    const categorySelect = document.getElementById('category-select');
    const perfumeSettings = document.getElementById('perfume-settings');
    const toggleIcon = document.getElementById('perfume-toggle-icon');
    const perfumeToggleButton = perfumeSettings.parentElement.querySelector('button');

    if (!categorySelect || !perfumeSettings) return;

    // Get selected category name
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    const categoryName = selectedOption ? selectedOption.text.toLowerCase() : '';

    // Check if category contains "perfume" (case-insensitive)
    const isPerfumeCategory = categoryName.includes('perfume');

    console.log('Category detection:', { categoryName, isPerfumeCategory });

    if (isPerfumeCategory) {
        // Show perfume settings automatically for perfume category
        perfumeSettings.classList.remove('hidden');
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');
        perfumeToggleButton.style.display = 'flex';

        // Load scents when perfume settings are opened
        loadScents();
    } else {
        // Hide perfume settings for non-perfume categories
        perfumeSettings.classList.add('hidden');
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');
        perfumeToggleButton.style.display = 'none';

        // Reset perfume fields when hiding
        document.querySelector('input[name="bottle_size_ml"]').value = '';
        const scentSelect = document.getElementById('scent-select');
        if (scentSelect) {
            Array.from(scentSelect.options).forEach(option => option.selected = false);
        }
        document.getElementById('is-decantable').checked = false;
        toggleDecantFields(); // This will hide decant fields and clear them
    }
}

// Manual toggle function for the button click
function manualTogglePerfumeSettings() {
    const perfumeSettings = document.getElementById('perfume-settings');
    const toggleIcon = document.getElementById('perfume-toggle-icon');

    if (perfumeSettings.classList.contains('hidden')) {
        perfumeSettings.classList.remove('hidden');
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');

        // Load scents when perfume settings are opened
        loadScents();
    } else {
        perfumeSettings.classList.add('hidden');
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');

        // Reset perfume fields when hiding
        document.querySelector('input[name="bottle_size_ml"]').value = '';
        const scentSelect = document.getElementById('scent-select');
        if (scentSelect) {
            Array.from(scentSelect.options).forEach(option => option.selected = false);
        }
        document.getElementById('is-decantable').checked = false;
        toggleDecantFields(); // This will hide decant fields and clear them
    }
}

// Toggle perfume settings for edit modal
function toggleEditPerfumeSettings() {
    const perfumeSettings = document.getElementById('edit-perfume-settings');
    const toggleIcon = document.getElementById('edit-perfume-toggle-icon');

    if (perfumeSettings.classList.contains('hidden')) {
        perfumeSettings.classList.remove('hidden');
        toggleIcon.classList.remove('fa-chevron-down');
        toggleIcon.classList.add('fa-chevron-up');

        // Add smooth animation
        perfumeSettings.style.opacity = '0';
        perfumeSettings.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            perfumeSettings.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            perfumeSettings.style.opacity = '1';
            perfumeSettings.style.transform = 'translateY(0)';
        }, 10);

        // Load scents with checkboxes when perfume settings are opened
        console.log('Manual toggle - Function exists?', typeof loadScentsForEditWithCheckboxes);
        if (typeof loadScentsForEditWithCheckboxes === 'function') {
            loadScentsForEditWithCheckboxes().then(() => {
                // Focus on bottle size field
                setTimeout(() => {
                    const bottleSizeField = document.getElementById('edit-bottle-size-ml');
                    if (bottleSizeField) bottleSizeField.focus();
                }, 100);
            });
        } else {
            console.error('loadScentsForEditWithCheckboxes function not found in manual toggle!');
        }
    } else {
        perfumeSettings.classList.add('hidden');
        toggleIcon.classList.remove('fa-chevron-up');
        toggleIcon.classList.add('fa-chevron-down');

        // Reset perfume fields when hiding
        document.getElementById('edit-bottle-size-ml').value = '';
        document.getElementById('edit-is-decantable').checked = false;
        toggleEditDecantFields(); // This will hide decant fields and clear them

        // Clear scents container
        const scentsContainer = document.getElementById('edit-scents-container');
        if (scentsContainer) {
            scentsContainer.innerHTML = `
                <div class="text-xs text-gray-500 text-center py-2">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Loading scents...
                </div>
            `;
        }

        // Clear validation errors for perfume fields
        clearEditFieldError('edit-bottle-size-ml');
        clearEditFieldError('edit-decant-size-ml');
        clearEditFieldError('edit-decant-price');
    }
}

// Toggle decant fields for edit modal
function toggleEditDecantFields() {
    const decantFields = document.getElementById('edit-decant-fields');
    const isDecantable = document.getElementById('edit-is-decantable').checked;

    if (isDecantable) {
        decantFields.classList.remove('hidden');

        // Add smooth animation
        decantFields.style.opacity = '0';
        decantFields.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            decantFields.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            decantFields.style.opacity = '1';
            decantFields.style.transform = 'translateY(0)';
        }, 10);

        // Focus on first decant field
        setTimeout(() => {
            const firstField = document.getElementById('edit-decant-size-ml');
            if (firstField) firstField.focus();
        }, 100);
    } else {
        decantFields.classList.add('hidden');
        // Clear decant fields when hiding
        document.getElementById('edit-decant-size-ml').value = '';
        document.getElementById('edit-decant-price').value = '';

        // Clear any validation errors for decant fields
        clearEditFieldError('edit-decant-size-ml');
        clearEditFieldError('edit-decant-price');
    }
}

// Toggle decant fields visibility
function toggleDecantFields() {
    const isDecantable = document.getElementById('is-decantable').checked;
    const decantFields = document.getElementById('decant-fields');

    if (isDecantable) {
        decantFields.classList.remove('hidden');
    } else {
        decantFields.classList.add('hidden');
        // Clear decant field values when hiding
        document.querySelector('input[name="decant_size_ml"]').value = '';
        document.querySelector('input[name="decant_price"]').value = '';
    }
}

// Restock modal functions
let currentRestockProductId = null;
let currentRestockStock = 0;

function openRestockModal(productId, productName, currentStock) {
    console.log('Opening restock modal for:', productId, productName, currentStock);

    currentRestockProductId = productId;
    currentRestockStock = parseInt(currentStock) || 0;

    // Update modal content
    document.getElementById('restock-product-name').textContent = productName;
    document.getElementById('restock-current-stock').textContent = currentRestockStock;
    document.getElementById('restock-quantity').value = '';
    document.getElementById('restock-reason').value = '';
    document.getElementById('restock-unit-cost').value = '';
    document.getElementById('restock-total-cost').value = '';
    document.getElementById('restock-supplier-select').value = '';
    document.getElementById('restock-payment-method').value = '';
    document.getElementById('restock-new-total').textContent = currentRestockStock + ' units';

    // Load suppliers for dropdown
    loadSuppliersForRestock();

    // Show modal
    document.getElementById('restock-modal').classList.remove('hidden');

    // Focus on quantity input
    setTimeout(() => {
        document.getElementById('restock-quantity').focus();
    }, 100);
}

function closeRestockModal() {
    document.getElementById('restock-modal').classList.add('hidden');
    document.getElementById('restock-form').reset();
    currentRestockProductId = null;
    currentRestockStock = 0;
}

function loadSuppliersForRestock() {
    fetch('/api/suppliers/', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        const supplierSelect = document.getElementById('restock-supplier-select');
        supplierSelect.innerHTML = '<option value="">Select supplier</option>';

        if (data.suppliers && data.suppliers.length > 0) {
            data.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.name;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error loading suppliers:', error);
    });
}

function toggleCustomSupplier() {
    // Open supplier creation modal
    openSupplierModal();
}

function openSupplierModal() {
    // Create and show supplier modal
    const modalHtml = `
        <div id="supplier-creation-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
                    <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                                    <i class="fas fa-truck text-white text-xs"></i>
                                </div>
                                <h3 class="text-base font-semibold text-white">Add New Supplier</h3>
                            </div>
                            <button type="button" onclick="closeSupplierModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                    </div>
                    <form id="supplier-creation-form" class="p-4 space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-building text-gray-400 mr-1"></i>Company Name
                            </label>
                            <input type="text" name="name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Enter company name">
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-user text-gray-400 mr-1"></i>Contact Person
                            </label>
                            <input type="text" name="contact_person" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Enter contact person name">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-phone text-gray-400 mr-1"></i>Phone Number
                                </label>
                                <input type="tel" name="phone" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="+256 700 000 000">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-envelope text-gray-400 mr-1"></i>Email Address
                                </label>
                                <input type="email" name="email" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="supplier@example.com">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>Address
                            </label>
                            <textarea name="address" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none" placeholder="Enter supplier address"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-sticky-note text-gray-400 mr-1"></i>Notes
                            </label>
                            <textarea name="notes" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none" placeholder="Additional notes about the supplier"></textarea>
                        </div>

                        <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                            <button type="button" onclick="closeSupplierModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                                Cancel
                            </button>
                            <button type="submit" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                                <i class="fas fa-plus mr-1"></i>Add Supplier
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Add form submit handler
    document.getElementById('supplier-creation-form').addEventListener('submit', handleSupplierCreation);

    // Focus on name input
    setTimeout(() => {
        document.querySelector('#supplier-creation-modal input[name="name"]').focus();
    }, 100);
}

function closeSupplierModal() {
    const modal = document.getElementById('supplier-creation-modal');
    if (modal) {
        modal.remove();
    }
}

async function handleSupplierCreation(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const supplierData = {
        name: formData.get('name'),
        contact_person: formData.get('contact_person') || null,
        phone: formData.get('phone') || null,
        email: formData.get('email') || null,
        address: formData.get('address') || null,
        notes: formData.get('notes') || null,
        status: 'active'
    };

    try {
        const response = await fetch('/api/suppliers/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(supplierData)
        });

        if (response.ok) {
            const result = await response.json();
            showToast('Supplier added successfully!', 'success');

            // Close supplier modal
            closeSupplierModal();

            // Reload suppliers in restock modal and select the new one
            loadSuppliersForRestock();

            // Select the newly created supplier
            setTimeout(() => {
                const supplierSelect = document.getElementById('restock-supplier-select');
                if (supplierSelect) {
                    supplierSelect.value = supplierData.name;
                }
            }, 500);

        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to add supplier', 'error');
        }
    } catch (error) {
        console.error('Error adding supplier:', error);
        showToast('Failed to add supplier', 'error');
    }
}

// Handle restock form submission
function handleRestockSubmit(event) {
    event.preventDefault();

    if (!currentRestockProductId) {
        showToast('No product selected for restocking', 'error');
        return;
    }

    const quantity = parseInt(document.getElementById('restock-quantity').value);
    const reason = document.getElementById('restock-reason').value.trim();
    const unitCost = parseFloat(document.getElementById('restock-unit-cost').value);
    const supplier = document.getElementById('restock-supplier-select').value.trim();
    const paymentMethod = document.getElementById('restock-payment-method').value;

    if (!quantity || quantity <= 0) {
        showToast('Please enter a valid quantity', 'error');
        return;
    }

    // Prepare restock data
    const restockData = {
        quantity: quantity,
        reason: reason || 'Manual restock'
    };

    // Add cost information if provided
    if (unitCost && unitCost > 0) {
        restockData.unit_cost = unitCost;
        if (supplier) restockData.supplier_name = supplier;
        if (paymentMethod) restockData.payment_method = paymentMethod;
    }

    console.log('Restocking product:', currentRestockProductId, restockData);

    // Show loading state
    const submitButton = document.querySelector('#restock-form button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Restocking...';
    submitButton.disabled = true;

    // Make API call
    fetch(`/api/products/${currentRestockProductId}/restock`, {
        method: 'POST',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(restockData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.detail || 'Failed to restock product');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Restock successful:', data);

        let message = data.message || 'Product restocked successfully!';

        // Add expense information if created
        if (data.expense_created) {
            message += `\n${data.expense_created.message}`;
        }

        showToast(message, 'success');

        // Close modal
        closeRestockModal();

        // Refresh data
        loadProductStats();
        loadProducts();
    })
    .catch(error => {
        console.error('Restock error:', error);
        showToast(error.message || 'Failed to restock product', 'error');
    })
    .finally(() => {
        // Restore button state
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}

// Update new total when quantity changes and add form handler
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('restock-quantity');
    const unitCostInput = document.getElementById('restock-unit-cost');
    const totalCostInput = document.getElementById('restock-total-cost');
    const newTotalSpan = document.getElementById('restock-new-total');
    const restockForm = document.getElementById('restock-form');

    function updateCalculations() {
        const addQuantity = parseInt(quantityInput.value) || 0;
        const unitCost = parseFloat(unitCostInput.value) || 0;

        // Update stock total
        const newTotal = currentRestockStock + addQuantity;
        newTotalSpan.textContent = newTotal + ' units';

        // Update cost total
        const totalCost = addQuantity * unitCost;
        totalCostInput.value = totalCost > 0 ? `UGX ${totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '';
    }

    if (quantityInput && newTotalSpan) {
        quantityInput.addEventListener('input', updateCalculations);
    }

    if (unitCostInput && totalCostInput) {
        unitCostInput.addEventListener('input', updateCalculations);
    }

    if (restockForm) {
        restockForm.addEventListener('submit', handleRestockSubmit);
    }
});

// Load product stats separately
function loadProductStats() {
    fetch('/api/products/stats', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Product stats loaded:', data);

        // Update stats cards with animation
        const stats = [
            { id: 'total-products', value: data.total_products || 0 },
            { id: 'in-stock', value: data.in_stock || 0 },
            { id: 'low-stock', value: data.low_stock || 0 },
            { id: 'out-of-stock', value: data.out_of_stock || 0 }
        ];

        stats.forEach(stat => {
            const element = document.getElementById(stat.id);
            if (element) {
                element.textContent = stat.value;
            }
        });
    })
    .catch(error => {
        console.error('Error loading product stats:', error);
        showToast('Failed to load product statistics', 'error');

        // Set default values on error
        ['total-products', 'in-stock', 'low-stock', 'out-of-stock'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = '0';
            }
        });
    });
}

// Pagination state variables
let currentPage = 1;
let totalProducts = 0;
let loadedProductsCount = 0;
let isLoading = false;
let hasMoreProducts = true;

// Load products with filtering
function loadProducts(resetPagination = true) {
    console.log('loadProducts called with resetPagination:', resetPagination);
    console.log('Before update - currentPage:', currentPage, 'hasMoreProducts:', hasMoreProducts, 'isLoading:', isLoading);

    if (resetPagination) {
        currentPage = 1;
        hasMoreProducts = true;
        loadedProductsCount = 0;
        console.log('Reset pagination - currentPage:', currentPage);
    }

    if (isLoading || !hasMoreProducts) {
        console.log('Exiting early - isLoading:', isLoading, 'hasMoreProducts:', hasMoreProducts);
        return;
    }

    isLoading = true;

    // Show appropriate loading indicator
    if (resetPagination) {
        showLoadingIndicator();
    } else {
        showAutoLoadingProductsState();
    }

    console.log('Starting to load page:', currentPage);

    const searchQuery = document.getElementById('search-products').value.trim();
    const categoryFilter = document.getElementById('category-filter').value;
    const stockFilter = document.getElementById('stock-filter').value;

    // Build query parameters
    const params = new URLSearchParams({
        page: currentPage,
        size: 10
    });



    if (searchQuery) {
        params.append('search', searchQuery);
    }
    if (categoryFilter) {
        params.append('category_id', categoryFilter);
    }
    if (stockFilter) {
        params.append('stock_status', stockFilter);
    }

    fetch(`/api/products/?${params.toString()}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Products loaded:', data);
        console.log('Response details:', {
            total: data.total,
            productsCount: data.products?.length,
            currentPage,
            resetPagination
        });

        totalProducts = data.total || 0;
        const products = data.products || [];

        if (resetPagination) {
            displayProducts(products);
            loadedProductsCount = products.length;
        } else {
            appendProducts(products);
            loadedProductsCount += products.length;
        }

        // Check if there are more products to load
        hasMoreProducts = data.has_next || false;
        console.log('After loading - hasMoreProducts:', hasMoreProducts, 'from API response:', {
            has_next: data.has_next,
            productsLength: products.length,
            currentPage,
            totalProducts,
            loadedProductsCount
        });

        // Update status display
        updateProductsScrollStatus();

        // Show appropriate message only on first load
        if (resetPagination) {
            if (totalProducts === 0) {
                showToast('No products found matching your criteria', 'info');
            } else {
                showToast(`Found ${totalProducts} product${totalProducts !== 1 ? 's' : ''}`, 'success');
            }
        }

        currentPage++;
        console.log('Incremented currentPage to:', currentPage);
    })
    .catch(error => {
        console.error('Error loading products:', error);
        if (resetPagination) {
            showToast('Failed to load products. Please check your connection.', 'error');
            // Show empty state
            displayProducts([]);
        }
    })
    .finally(() => {
        isLoading = false;
        hideLoadingIndicator();
        hideAutoLoadingProductsState();
    });
}

function displayProducts(products) {
    const tableBody = document.querySelector('#products-table-body');
    if (!tableBody) return;

    if (products.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="px-3 py-3 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-box text-gray-300 text-4xl mb-2"></i>
                        <p>No products found</p>
                        <p class="text-sm">Create your first product to get started</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = generateProductRows(products);
}

// Function to append products for infinite scroll
function appendProducts(products) {
    const tableBody = document.querySelector('#products-table-body');
    if (!tableBody || products.length === 0) return;

    // Remove any existing "no products" message
    const noProductsRow = tableBody.querySelector('tr td[colspan="7"]');
    if (noProductsRow) {
        noProductsRow.parentElement.remove();
    }

    tableBody.insertAdjacentHTML('beforeend', generateProductRows(products));
}

// Generate HTML for product rows
function generateProductRows(products) {
    return products.map(product => `
        <tr class="hover:bg-gray-50">
            <td class="px-3 py-3 whitespace-nowrap">
                <div class="flex items-center">
                    ${product.image && product.image.thumbnail_url ? `
                        <div class="w-12 h-12 rounded-lg overflow-hidden mr-3 shadow-sm border border-gray-200 flex-shrink-0">
                            <img src="${product.image.thumbnail_url}" alt="${product.name}" class="w-full h-full object-cover">
                        </div>
                    ` : `
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3 shadow-sm flex-shrink-0">
                            <i class="fas fa-box text-white text-sm"></i>
                        </div>
                    `}
                    <div class="min-w-0 flex-1">
                        <div class="text-sm font-medium text-gray-900 truncate">${product.name}</div>
                        ${product.scents && product.scents.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${product.scents.map(scent => `
                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                        <i class="fas fa-spray-can text-purple-600 mr-1" style="font-size: 8px;"></i>
                                        ${scent.name}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </td>
            <td class="px-3 py-3 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                    ${product.category_name || 'No Category'}
                </span>
            </td>

            <td class="px-3 py-3 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-medium">UGX ${product.price.toLocaleString('en-UG')}</div>
                ${product.is_perfume_with_decants && product.decant ? `
                    <div class="text-xs text-purple-600 mt-1">
                        <i class="fas fa-vial text-purple-400 mr-1"></i>
                        ${product.decant.decant_size_ml}ml UGX ${product.decant.decant_price.toLocaleString()}
                    </div>
                ` : ''}
            </td>
            <td class="px-3 py-3 whitespace-nowrap">
                <div class="text-sm text-gray-900">${product.stock_display || (product.stock_quantity + ' ' + product.unit)}</div>
                ${product.min_stock_level > 0 ? `<div class="text-xs text-gray-500">Min: ${product.min_stock_level}</div>` : ''}
            </td>
            <td class="px-3 py-3 whitespace-nowrap">
                <div class="flex items-center space-x-2">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStockStatusClass(product.stock_status)}">
                        ${getStockStatusText(product.stock_status)}
                    </span>
                    ${(product.stock_status === 'low-stock' || product.stock_status === 'out-of-stock') && '{{ user.role }}' !== 'cashier' ?
                        `<button onclick="openRestockModal('${product.id}', '${product.name}', ${product.stock_quantity})"
                                 class="text-orange-600 hover:text-orange-800 text-xs p-1 rounded hover:bg-orange-50 transition-colors duration-200"
                                 title="Quick Restock">
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>` : ''
                    }
                </div>
            </td>
            <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex items-center justify-end space-x-1">
                    <button onclick="viewProductDetails('${product.id}')"
                            class="text-indigo-600 hover:text-indigo-900 p-1 rounded hover:bg-indigo-50 transition-colors duration-200"
                            title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    {% if user and (user.role == 'admin' or user.role == 'manager') %}
                    <button onclick="openRestockModal('${product.id}', '${product.name}', ${product.stock_quantity})"
                            class="text-green-600 hover:text-green-900 p-1 rounded hover:bg-green-50 transition-colors duration-200"
                            title="Restock Product">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                    {% endif %}
                    {% if user and user.role != 'cashier' %}
                    <button onclick="editProduct('${product.id}')"
                            class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50 transition-colors duration-200"
                            title="Edit Product">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteProduct('${product.id}')"
                            class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50 transition-colors duration-200"
                            title="Delete Product">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </td>
        </tr>
    `).join('');
}

function getStockStatusClass(status) {
    switch(status) {
        case 'in-stock': return 'bg-green-100 text-green-800';
        case 'low-stock': return 'bg-yellow-100 text-yellow-800';
        case 'out-of-stock': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getStockStatusText(status) {
    switch(status) {
        case 'in-stock': return 'In Stock';
        case 'low-stock': return 'Low Stock';
        case 'out-of-stock': return 'Out of Stock';
        default: return 'Unknown';
    }
}

// Loading indicator functions
function showLoadingIndicator() {
    const tableBody = document.querySelector('#products-table-body');
    if (!tableBody) return;

    // Only show loading indicator if table is empty or we're loading more
    if (currentPage === 1 || tableBody.children.length === 0) {
        return; // Don't show loading for initial load
    }

    // Add loading row at the bottom
    const loadingRow = document.createElement('tr');
    loadingRow.id = 'loading-indicator';
    loadingRow.innerHTML = `
        <td colspan="6" class="px-3 py-6 text-center">
            <div class="flex items-center justify-center space-x-3 text-gray-600">
                <div class="animate-spin rounded-full h-5 w-5 border-2 border-blue-600 border-t-transparent"></div>
                <span class="text-sm font-medium">Loading more products...</span>
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
            </div>
        </td>
    `;
    tableBody.appendChild(loadingRow);
}

function hideLoadingIndicator() {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.remove();
    }
}

// Status update functions
function showAutoLoadingProductsState() {
    const indicator = document.getElementById('auto-loading-products-indicator');
    indicator.classList.remove('hidden');
    // Add smooth fade-in animation
    setTimeout(() => {
        indicator.style.opacity = '0';
        indicator.style.transform = 'translateY(10px)';
        indicator.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        setTimeout(() => {
            indicator.style.opacity = '1';
            indicator.style.transform = 'translateY(0)';
        }, 10);
    }, 10);
}

function hideAutoLoadingProductsState() {
    const indicator = document.getElementById('auto-loading-products-indicator');
    indicator.style.opacity = '0';
    indicator.style.transform = 'translateY(-10px)';
    setTimeout(() => {
        indicator.classList.add('hidden');
        indicator.style.opacity = '';
        indicator.style.transform = '';
    }, 300);
}

function updateProductsScrollStatus() {
    const showingCountEl = document.getElementById('showing-products-count');
    const totalCountEl = document.getElementById('total-products-count');
    const endOfResults = document.getElementById('end-of-products');

    // Update counts
    showingCountEl.textContent = loadedProductsCount;
    totalCountEl.textContent = totalProducts;

    // Show/hide end message with animation
    if (hasMoreProducts) {
        endOfResults.classList.add('hidden');
    } else {
        endOfResults.classList.remove('hidden');
        // Add smooth fade-in animation
        setTimeout(() => {
            endOfResults.style.opacity = '0';
            endOfResults.style.transform = 'translateY(20px)';
            endOfResults.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            setTimeout(() => {
                endOfResults.style.opacity = '1';
                endOfResults.style.transform = 'translateY(0)';
            }, 10);
        }, 10);
    }
}

// Infinite scroll functionality
function setupInfiniteScroll() {
    let scrollTimeout;

    window.addEventListener('scroll', function() {
        // Debounce scroll events
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            // Check if user has scrolled near the bottom
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;

            // Debug logging
            console.log('Scroll debug:', {
                scrollTop,
                windowHeight,
                documentHeight,
                distanceFromBottom: documentHeight - (scrollTop + windowHeight),
                isLoading,
                hasMoreProducts,
                currentPage,
                totalProducts
            });

            // Trigger when user is within 300px of the bottom (increased for better UX)
            if (scrollTop + windowHeight >= documentHeight - 300) {
                console.log('Near bottom detected!');
                if (!isLoading && hasMoreProducts) {
                    console.log('Loading more products...');
                    loadProducts(false); // false = don't reset pagination
                }
            }
        }, 50); // Reduced debounce time for more responsive scrolling
    });
}

// Load categories for dropdown
function loadCategories(retryCount = 0) {
    console.log('loadCategories() called, retry count:', retryCount);

    // Check if elements exist, if not retry after a short delay
    const categorySelect = document.getElementById('category-filter');
    const categoryModalSelect = document.getElementById('category-select');

    if ((!categorySelect || !categoryModalSelect) && retryCount < 3) {
        console.log('Elements not found, retrying in 100ms...');
        setTimeout(() => loadCategories(retryCount + 1), 100);
        return;
    }

    if (!categorySelect) {
        console.error('category-filter element not found after retries');
        return;
    }

    if (!categoryModalSelect) {
        console.error('category-select element not found after retries');
        return;
    }

    console.log('Elements found, proceeding with API call');

    fetch('/api/categories/simple', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('Categories API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Categories API response data:', data);

        // Clear existing options (except "All Categories" for filter)
        categorySelect.innerHTML = '<option value="">All Categories</option>';
        categoryModalSelect.innerHTML = '<option value="">Select Category</option>';

        // Add categories to both dropdowns
        if (data.categories && Array.isArray(data.categories)) {
            console.log(`Processing ${data.categories.length} categories`);

            data.categories.forEach((category, index) => {
                console.log(`Adding category ${index + 1}:`, category);

                if (category.id && category.name) {
                    // Create options for filter dropdown
                    const option1 = document.createElement('option');
                    option1.value = category.id;
                    option1.textContent = category.name;
                    categorySelect.appendChild(option1);

                    // Create options for modal dropdown
                    const option2 = document.createElement('option');
                    option2.value = category.id;
                    option2.textContent = category.name;
                    categoryModalSelect.appendChild(option2);

                    console.log(`Added category: ${category.name} (${category.id})`);
                } else {
                    console.warn('Invalid category data:', category);
                }
            });

            console.log(`Successfully loaded ${data.categories.length} categories into dropdowns`);
            console.log('Filter dropdown options:', categorySelect.options.length);
            console.log('Modal dropdown options:', categoryModalSelect.options.length);

            // Verify the options are actually there
            for (let i = 0; i < categorySelect.options.length; i++) {
                console.log(`Filter option ${i}:`, categorySelect.options[i].value, categorySelect.options[i].text);
            }

            showToast(`Loaded ${data.categories.length} categories`, 'success');
        } else {
            console.warn('No categories found in response or invalid format');
            showToast('No categories found', 'warning');
        }
    })
    .catch(error => {
        console.error('Error loading categories:', error);
        showToast('Failed to load categories. Please check your connection.', 'error');
    });
}

// Edit product functionality
let currentEditProductId = null;

function editProduct(productId) {
    console.log('Editing product:', productId);
    currentEditProductId = productId;

    // Show modal immediately with loading state
    const modal = document.getElementById('edit-product-modal');
    const loadingDiv = document.getElementById('edit-modal-loading');
    const formDiv = document.getElementById('edit-product-form');

    // Show modal and loading state
    modal.classList.remove('hidden');
    loadingDiv.classList.remove('hidden');
    formDiv.classList.add('hidden');

    // Load product data
    fetch(`/api/products/${productId}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(product => {
        console.log('Product data loaded:', product);

        // Store product data globally for use in form submission
        window.currentEditProduct = product;

        // Handle existing product image
        const editImagePreview = document.getElementById('edit-image-preview');
        const deleteImageBtn = document.getElementById('delete-image-btn');

        if (product.image && product.image.url) {
            // Show existing image
            editImagePreview.innerHTML = `
                <div class="relative">
                    <img src="${product.image.thumbnail_url || product.image.url}" alt="Product Image" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                    <div class="absolute top-1 right-1 bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                        ✓
                    </div>
                </div>
                <p class="text-xs text-gray-600 mt-2">Current product image</p>
            `;
            deleteImageBtn.classList.remove('hidden');
        } else {
            // No existing image
            editImagePreview.innerHTML = `
                <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
                <p class="text-sm text-gray-600">Click to upload or change product image</p>
                <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP up to 10MB</p>
            `;
            deleteImageBtn.classList.add('hidden');
        }

        // Populate the form
        document.getElementById('edit-name').value = product.name || '';
        document.getElementById('edit-price').value = product.price || '';
        document.getElementById('edit-cost-price').value = product.cost_price || '';
        document.getElementById('edit-stock-quantity').value = product.stock_quantity || 0;
        document.getElementById('edit-min-stock-level').value = product.min_stock_level || 4;

        document.getElementById('edit-unit').value = product.unit || 'pcs';
        document.getElementById('edit-supplier').value = product.supplier || '';
        document.getElementById('edit-barcode').value = product.barcode || '';

        document.getElementById('edit-payment-method').value = product.payment_method || '';
        document.getElementById('edit-description').value = product.description || '';
        document.getElementById('edit-is-active').checked = product.is_active !== false;

        // Load categories and set the selected one
        loadCategoriesForEdit(product.category_id);

        // Load suppliers and set the selected one
        loadSuppliersForEdit(product.supplier);

        // Store product scents data for later use when perfume settings are opened
        window.currentProductScents = [];
        if (product.scents && Array.isArray(product.scents)) {
            window.currentProductScents = product.scents.map(scent => scent.id);
        } else if (product.scent_ids && Array.isArray(product.scent_ids)) {
            window.currentProductScents = product.scent_ids;
        } else if (product.scent_id) {
            window.currentProductScents = [product.scent_id];
        }
        console.log('Stored product scents for later:', window.currentProductScents);

        // Handle perfume settings
        const hasBottleSize = product.bottle_size_ml;
        const hasScent = product.scent_id;
        const hasDecant = product.decant || product.is_decantable || product.decant_size_ml || product.decant_price;

        if (hasBottleSize || hasScent || hasDecant) {
            console.log('Product has perfume data:', { hasBottleSize, hasScent, hasDecant, decant: product.decant });

            // Show perfume settings if product has perfume data
            document.getElementById('edit-perfume-settings').classList.remove('hidden');
            document.getElementById('edit-perfume-toggle-icon').classList.remove('fa-chevron-down');
            document.getElementById('edit-perfume-toggle-icon').classList.add('fa-chevron-up');

            // Populate perfume fields
            document.getElementById('edit-bottle-size-ml').value = product.bottle_size_ml || '';

            // Load scents when perfume settings are automatically shown
            console.log('Auto-expanding perfume settings, loading scents...');
            console.log('Function exists?', typeof loadScentsForEditWithCheckboxes);
            if (typeof loadScentsForEditWithCheckboxes === 'function') {
                loadScentsForEditWithCheckboxes();
            } else {
                console.error('loadScentsForEditWithCheckboxes function not found!');
            }

            // Handle decant settings - check multiple possible data structures
            const decantObj = product.decant || {};
            const isDecantable = product.is_decantable ||
                                decantObj.is_decantable ||
                                (decantObj && (decantObj.decant_size_ml || decantObj.decant_price)) ||
                                product.decant_size_ml ||
                                product.decant_price;

            console.log('Decant check:', {
                product_is_decantable: product.is_decantable,
                decant_obj: decantObj,
                decant_obj_is_decantable: decantObj.is_decantable,
                isDecantable: isDecantable
            });

            if (isDecantable) {
                console.log('Product is decantable, populating decant fields');
                document.getElementById('edit-is-decantable').checked = true;
                document.getElementById('edit-decant-fields').classList.remove('hidden');

                // Try different data structures for decant info
                let decantSizeMl = '';
                let decantPrice = '';

                if (decantObj && Object.keys(decantObj).length > 0) {
                    decantSizeMl = decantObj.decant_size_ml || decantObj.size_ml || '';
                    decantPrice = decantObj.decant_price || decantObj.price || '';
                } else {
                    decantSizeMl = product.decant_size_ml || '';
                    decantPrice = product.decant_price || '';
                }

                console.log('Setting decant values:', {
                    decantSizeMl,
                    decantPrice,
                    decantObj: decantObj,
                    product_decant_size_ml: product.decant_size_ml,
                    product_decant_price: product.decant_price
                });

                document.getElementById('edit-decant-size-ml').value = decantSizeMl;
                document.getElementById('edit-decant-price').value = decantPrice;
            }
        }

        // Calculate profit margin with loaded data
        calculateEditProfitMargin();

        // Hide loading and show form
        setTimeout(() => {
            loadingDiv.classList.add('hidden');
            formDiv.classList.remove('hidden');

            // Focus on first input
            const firstInput = document.getElementById('edit-name');
            if (firstInput) firstInput.focus();

            // Add real-time validation listeners
            addEditFormValidationListeners();

            // Add keyboard shortcuts
            addEditModalKeyboardShortcuts();
        }, 300); // Small delay for better UX
    })
    .catch(error => {
        console.error('Error loading product:', error);
        showToast('Failed to load product data', 'error');

        // Hide modal on error
        modal.classList.add('hidden');
    });
}

function loadCategoriesForEdit(selectedCategoryId) {
    console.log('Loading categories for edit modal, selectedCategoryId:', selectedCategoryId);

    fetch('/api/categories/simple', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('Categories API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Categories API response data:', data);

        const categorySelect = document.getElementById('edit-category-id');
        if (!categorySelect) {
            console.error('Category select element not found');
            return;
        }

        categorySelect.innerHTML = '<option value="">Select Category</option>';

        // The API returns {categories: [...], total: number}
        const categories = data.categories || [];
        console.log(`Processing ${categories.length} categories for edit modal`);

        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            if (category.id === selectedCategoryId) {
                option.selected = true;
                console.log('Selected category:', category.name);
            }
            categorySelect.appendChild(option);
        });

        console.log('Categories loaded successfully for edit modal');
    })
    .catch(error => {
        console.error('Error loading categories for edit modal:', error);
        showToast('Failed to load categories. Please try again.', 'error');
    });
}

// Refresh categories for edit modal (called from refresh button)
function refreshCategoriesForEdit() {
    console.log('Refreshing categories for edit modal');
    const categorySelect = document.getElementById('edit-category-id');
    const currentValue = categorySelect ? categorySelect.value : null;
    loadCategoriesForEdit(currentValue);
}

// Load suppliers for dropdown
function loadSuppliers() {
    fetch('/api/products/suppliers/dropdown', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to load suppliers');
    })
    .then(data => {
        const supplierSelect = document.getElementById('supplier-select');
        if (supplierSelect) {
            // Clear existing options except the first one
            supplierSelect.innerHTML = '<option value="">Select Supplier (Optional)</option>';

            // Add supplier options
            data.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.name;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error loading suppliers:', error);
        // Don't show error toast for suppliers since it's optional
        // Just log the error and continue
    });
}

// Load suppliers for edit modal
function loadSuppliersForEdit(selectedSupplier = null) {
    fetch('/api/products/suppliers/dropdown', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to load suppliers');
    })
    .then(data => {
        const supplierSelect = document.getElementById('edit-supplier');
        if (supplierSelect) {
            // Clear existing options except the first one
            supplierSelect.innerHTML = '<option value="">Select Supplier (Optional)</option>';

            // Add supplier options
            data.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.name;
                option.textContent = supplier.name;
                if (selectedSupplier && supplier.name === selectedSupplier) {
                    option.selected = true;
                }
                supplierSelect.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error loading suppliers for edit:', error);
        // Don't show error toast for suppliers since it's optional
        // Just log the error and continue
    });
}

// Refresh suppliers for edit modal (called from refresh button)
function refreshSuppliersForEdit() {
    const currentValue = document.getElementById('edit-supplier').value;
    loadSuppliersForEdit(currentValue);
}

// Form validation functions for edit modal
function validateEditForm() {
    const errors = [];

    // Validate product name
    const name = document.getElementById('edit-name').value.trim();
    if (!name) {
        errors.push({ field: 'edit-name', message: 'Product name is required' });
    } else if (name.length < 2) {
        errors.push({ field: 'edit-name', message: 'Product name must be at least 2 characters' });
    }

    // Validate category
    const categoryId = document.getElementById('edit-category-id').value;
    if (!categoryId) {
        errors.push({ field: 'edit-category-id', message: 'Please select a category' });
    }

    // Validate selling price
    const price = parseFloat(document.getElementById('edit-price').value);
    if (!price || price <= 0) {
        errors.push({ field: 'edit-price', message: 'Selling price must be greater than 0' });
    }

    // Validate cost price if provided
    const costPrice = document.getElementById('edit-cost-price').value;
    if (costPrice && parseFloat(costPrice) < 0) {
        errors.push({ field: 'edit-cost-price', message: 'Cost price cannot be negative' });
    }

    // Validate stock quantity
    const stockQuantity = parseInt(document.getElementById('edit-stock-quantity').value);
    if (isNaN(stockQuantity) || stockQuantity < 0) {
        errors.push({ field: 'edit-stock-quantity', message: 'Stock quantity must be 0 or greater' });
    }

    // Validate min stock level
    const minStock = parseInt(document.getElementById('edit-min-stock-level').value);
    if (isNaN(minStock) || minStock < 0) {
        errors.push({ field: 'edit-min-stock-level', message: 'Min stock level must be 0 or greater' });
    }



    // Validate perfume fields if perfume settings are visible
    const perfumeSettings = document.getElementById('edit-perfume-settings');
    if (!perfumeSettings.classList.contains('hidden')) {
        const bottleSize = document.getElementById('edit-bottle-size-ml').value;
        if (bottleSize && parseFloat(bottleSize) <= 0) {
            errors.push({ field: 'edit-bottle-size-ml', message: 'Bottle size must be greater than 0' });
        }

        // Validate decant fields if decant is enabled
        const isDecantable = document.getElementById('edit-is-decantable').checked;
        if (isDecantable) {
            const decantSize = document.getElementById('edit-decant-size-ml').value;
            const decantPrice = document.getElementById('edit-decant-price').value;

            if (!decantSize || parseFloat(decantSize) <= 0) {
                errors.push({ field: 'edit-decant-size-ml', message: 'Decant size must be greater than 0' });
            }
            if (!decantPrice || parseFloat(decantPrice) <= 0) {
                errors.push({ field: 'edit-decant-price', message: 'Decant price must be greater than 0' });
            }
        }
    }

    return errors;
}

function showEditFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (!field) return;

    // Remove existing error styling and messages
    clearEditFieldError(fieldId);

    // Add error styling
    field.classList.add('border-red-500', 'focus:ring-red-500');
    field.classList.remove('border-gray-300', 'focus:ring-blue-500');

    // Create and add error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'text-red-600 text-xs mt-1 edit-field-error';
    errorDiv.textContent = message;

    // Insert error message after the field
    field.parentNode.appendChild(errorDiv);
}

function clearEditFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return;

    // Remove error styling
    field.classList.remove('border-red-500', 'focus:ring-red-500');
    field.classList.add('border-gray-300', 'focus:ring-blue-500');

    // Remove error messages
    const errorMessages = field.parentNode.querySelectorAll('.edit-field-error');
    errorMessages.forEach(msg => msg.remove());
}

function clearAllEditFieldErrors() {
    const form = document.getElementById('edit-product-form');
    const errorMessages = form.querySelectorAll('.edit-field-error');
    errorMessages.forEach(msg => msg.remove());

    // Reset all field styling
    const fields = form.querySelectorAll('input, select, textarea');
    fields.forEach(field => {
        field.classList.remove('border-red-500', 'focus:ring-red-500');
        field.classList.add('border-gray-300', 'focus:ring-blue-500');
    });
}

function addEditFormValidationListeners() {
    // Add blur validation for key fields
    const fieldsToValidate = [
        'edit-name',
        'edit-category-id',
        'edit-price',
        'edit-cost-price',
        'edit-stock-quantity',
        'edit-min-stock-level',
        'edit-bottle-size-ml',
        'edit-decant-size-ml',
        'edit-decant-price'
    ];

    fieldsToValidate.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('blur', function() {
                // Clear existing error for this field
                clearEditFieldError(fieldId);

                // Validate specific field
                const errors = validateEditForm();
                const fieldError = errors.find(error => error.field === fieldId);
                if (fieldError) {
                    showEditFieldError(fieldId, fieldError.message);
                }
            });

            // Clear error on input/change for better UX
            const eventType = field.tagName.toLowerCase() === 'select' ? 'change' : 'input';
            field.addEventListener(eventType, function() {
                clearEditFieldError(fieldId);
            });
        }
    });

    // Add special handling for scents checkboxes (will be added dynamically)
    // Event delegation for dynamically created checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('edit-scent-checkbox')) {
            const checkedScents = document.querySelectorAll('.edit-scent-checkbox:checked');
            const scentNames = Array.from(checkedScents).map(cb => cb.nextElementSibling.textContent);
            console.log('Scents selection changed:', scentNames);
        }
    });
}

function addEditModalKeyboardShortcuts() {
    const modal = document.getElementById('edit-product-modal');

    function handleKeydown(e) {
        // Only handle shortcuts when modal is visible
        if (modal.classList.contains('hidden')) return;

        // Escape key to close modal
        if (e.key === 'Escape') {
            e.preventDefault();
            closeEditProductModal();
            return;
        }

        // Ctrl/Cmd + Enter to submit form
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            const form = document.getElementById('edit-product-form');
            if (form && !form.classList.contains('hidden')) {
                form.dispatchEvent(new Event('submit'));
            }
            return;
        }

        // Ctrl/Cmd + P to toggle perfume settings
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            toggleEditPerfumeSettings();
            return;
        }
    }

    // Add event listener
    document.addEventListener('keydown', handleKeydown);

    // Store reference to remove later
    modal._keydownHandler = handleKeydown;
}

// Load scents for edit modal
function loadScentsForEdit() {
    return fetch('/api/scents/', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(scents => {
        const scentSelect = document.getElementById('edit-scent-select');
        if (scentSelect) {
            scentSelect.innerHTML = '';
            scents.forEach(scent => {
                const option = document.createElement('option');
                option.value = scent.id;
                option.textContent = scent.name;
                scentSelect.appendChild(option);
            });
        }
        return scents; // Return scents for chaining
    })
    .catch(error => {
        console.error('Error loading scents for edit:', error);
        // Don't show error toast for scents since it's optional
        return []; // Return empty array on error
    });
}

// Load scents for edit modal with checkboxes
function loadScentsForEditWithCheckboxes() {
    console.log('🌸 loadScentsForEditWithCheckboxes() called');
    console.log('Loading scents with checkboxes for edit modal');

    return fetch('/api/scents?active_only=true', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('Scents API response status:', response.status);
        console.log('Scents API response headers:', response.headers);
        if (!response.ok) {
            console.error('Scents API error response:', response.status, response.statusText);
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Scents API response data:', data);

        const scentsContainer = document.getElementById('edit-scents-container');
        if (!scentsContainer) {
            console.error('Scents container not found');
            return [];
        }

        // The scents API returns an array directly, not wrapped in an object
        const scents = Array.isArray(data) ? data : [];
        console.log(`Processing ${scents.length} scents for edit modal`);

        if (scents.length === 0) {
            scentsContainer.innerHTML = `
                <div class="text-xs text-gray-500 text-center py-2">
                    <i class="fas fa-info-circle mr-1"></i>No scents available
                </div>
            `;
            return [];
        }

        // Create checkboxes for each scent
        const selectedScents = window.currentProductScents || [];
        console.log('Selected scents to check:', selectedScents);

        scentsContainer.innerHTML = scents.map(scent => `
            <label class="flex items-center p-1 hover:bg-purple-50 rounded cursor-pointer transition-colors duration-150">
                <input type="checkbox"
                       class="edit-scent-checkbox h-3 w-3 text-purple-600 focus:ring-purple-500 border-gray-300 rounded mr-2"
                       value="${scent.id}"
                       ${selectedScents.includes(scent.id) ? 'checked' : ''}>
                <span class="text-xs text-gray-700 select-none">${scent.name}</span>
            </label>
        `).join('');

        console.log('Scents checkboxes created successfully');
        return scents;
    })
    .catch(error => {
        console.error('Error loading scents for edit modal:', error);
        const scentsContainer = document.getElementById('edit-scents-container');
        if (scentsContainer) {
            let errorMessage = 'Failed to load scents';
            if (error.message.includes('401')) {
                errorMessage = 'Authentication required';
            } else if (error.message.includes('403')) {
                errorMessage = 'Access denied';
            } else if (error.message.includes('500')) {
                errorMessage = 'Server error';
            }

            scentsContainer.innerHTML = `
                <div class="text-xs text-red-500 text-center py-2">
                    <i class="fas fa-exclamation-triangle mr-1"></i>${errorMessage}
                    <br><button onclick="loadScentsForEditWithCheckboxes()" class="text-blue-500 hover:text-blue-700 underline mt-1">Retry</button>
                </div>
            `;
        }
        return [];
    });
}

function closeEditProductModal() {
    const modal = document.getElementById('edit-product-modal');
    const loadingDiv = document.getElementById('edit-modal-loading');
    const formDiv = document.getElementById('edit-product-form');

    // Hide modal
    modal.classList.add('hidden');

    // Reset states
    loadingDiv.classList.remove('hidden');
    formDiv.classList.add('hidden');
    formDiv.reset();
    currentEditProductId = null;

    // Hide profit margin display
    document.getElementById('edit-profit-margin-display').classList.add('hidden');

    // Reset perfume settings
    document.getElementById('edit-perfume-settings').classList.add('hidden');
    document.getElementById('edit-perfume-toggle-icon').classList.remove('fa-chevron-up');
    document.getElementById('edit-perfume-toggle-icon').classList.add('fa-chevron-down');
    document.getElementById('edit-decant-fields').classList.add('hidden');

    // Reset decant checkbox
    const decantCheckbox = document.getElementById('edit-is-decantable');
    if (decantCheckbox) decantCheckbox.checked = false;

    // Clear scents container
    const scentsContainer = document.getElementById('edit-scents-container');
    if (scentsContainer) {
        scentsContainer.innerHTML = `
            <div class="text-xs text-gray-500 text-center py-2">
                <i class="fas fa-spinner fa-spin mr-1"></i>Loading scents...
            </div>
        `;
    }

    // Clear stored scents data
    window.currentProductScents = [];

    // Remove keyboard shortcuts
    if (modal._keydownHandler) {
        document.removeEventListener('keydown', modal._keydownHandler);
        delete modal._keydownHandler;
    }
}

// Handle edit form submission
document.addEventListener('DOMContentLoaded', function() {
    const editForm = document.getElementById('edit-product-form');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!currentEditProductId) {
                showToast('No product selected for editing', 'error');
                return;
            }

            // Clear previous errors
            clearAllEditFieldErrors();

            // Validate form
            const validationErrors = validateEditForm();
            if (validationErrors.length > 0) {
                // Show validation errors
                validationErrors.forEach(error => {
                    showEditFieldError(error.field, error.message);
                });

                // Focus on first error field
                const firstErrorField = document.getElementById(validationErrors[0].field);
                if (firstErrorField) {
                    firstErrorField.focus();
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                showToast('Please fix the validation errors before submitting', 'error');
                return;
            }

            const formData = new FormData(editForm);
            const submitButton = editForm.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;

            // Disable submit button and show loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Updating...';

            // Build update data
            const updateData = {};

            // Only include fields that have values
            const name = formData.get('name');
            if (name && name.trim()) updateData.name = name.trim();

            const categoryId = formData.get('category_id');
            if (categoryId) updateData.category_id = categoryId;

            const price = formData.get('price');
            if (price) updateData.price = parseFloat(price);

            const costPrice = formData.get('cost_price');
            if (costPrice) updateData.cost_price = parseFloat(costPrice);

            const stockQuantity = formData.get('stock_quantity');
            if (stockQuantity && stockQuantity.trim()) {
                const parsedStock = parseInt(stockQuantity);
                if (!isNaN(parsedStock)) updateData.stock_quantity = parsedStock;
            }

            const minStockLevel = formData.get('min_stock_level');
            if (minStockLevel && minStockLevel.trim()) {
                const parsedMinStock = parseInt(minStockLevel);
                if (!isNaN(parsedMinStock)) updateData.min_stock_level = parsedMinStock;
            }



            const unit = formData.get('unit');
            if (unit && unit.trim()) updateData.unit = unit.trim();

            const supplier = formData.get('supplier');
            if (supplier && supplier.trim()) updateData.supplier = supplier.trim();

            const barcode = formData.get('barcode');
            if (barcode && barcode.trim()) updateData.barcode = barcode.trim();

            const description = formData.get('description');
            if (description && description.trim()) updateData.description = description.trim();

            updateData.is_active = formData.get('is_active') === 'on';

            // Handle perfume-specific fields
            const bottleSizeMl = formData.get('bottle_size_ml');
            if (bottleSizeMl) {
                updateData.bottle_size_ml = parseFloat(bottleSizeMl);
            }

            // Handle scent selection from checkboxes
            const scentCheckboxes = document.querySelectorAll('.edit-scent-checkbox:checked');
            const selectedScents = Array.from(scentCheckboxes).map(checkbox => checkbox.value);
            console.log('Selected scents for update:', selectedScents);

            // Always set scent_ids (empty array if no scents selected)
            updateData.scent_ids = selectedScents;

            // Handle decant information
            const isDecantable = formData.get('is_decantable') === 'on';
            if (isDecantable) {
                const decantSizeMl = formData.get('decant_size_ml');
                const decantPrice = formData.get('decant_price');

                // Get existing decant data to preserve opened_bottle_ml_left
                const existingDecant = window.currentEditProduct?.decant || {};

                updateData.decant = {
                    is_decantable: true,
                    decant_size_ml: decantSizeMl ? parseFloat(decantSizeMl) : null,
                    decant_price: decantPrice ? parseFloat(decantPrice) : null,
                    opened_bottle_ml_left: existingDecant.opened_bottle_ml_left || 0.0  // Preserve existing value
                };
            } else {
                // If decant is disabled, set it to null
                updateData.decant = null;
            }

            console.log('Updating product with data:', JSON.stringify(updateData, null, 2));
            console.log('Original product data:', window.currentEditProduct);

            // Send update request
            fetch(`/api/products/${currentEditProductId}`, {
                method: 'PUT',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Failed to update product');
                    });
                }
                return response.json();
            })
            .then(async (data) => {
                console.log('Product updated successfully:', data);

                // Check if new image was selected for upload
                const imageFile = document.getElementById('edit-product-image').files[0];
                if (imageFile && currentEditProductId) {
                    try {
                        console.log('Uploading new image for product:', currentEditProductId);
                        await uploadProductImage(currentEditProductId, imageFile);

                        // Show success animation on submit button
                        submitButton.innerHTML = '<i class="fas fa-check mr-1"></i>Updated with Image!';
                        submitButton.classList.add('bg-green-500', 'hover:bg-green-600');
                        submitButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'hover:from-blue-600', 'hover:to-indigo-700');

                        showToast('Product updated with new image successfully!', 'success');
                    } catch (imageError) {
                        console.error('Failed to upload image:', imageError);

                        // Show partial success animation
                        submitButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Updated (Image Failed)';
                        submitButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                        submitButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'hover:from-blue-600', 'hover:to-indigo-700');

                        showToast('Product updated but image upload failed', 'warning');
                    }
                } else {
                    // Show success animation on submit button
                    submitButton.innerHTML = '<i class="fas fa-check mr-1"></i>Updated!';
                    submitButton.classList.add('bg-green-500', 'hover:bg-green-600');
                    submitButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-indigo-600', 'hover:from-blue-600', 'hover:to-indigo-700');

                    showToast('Product updated successfully!', 'success');
                }

                // Close modal after a short delay to show success state
                setTimeout(() => {
                    closeEditProductModal();

                    // Refresh data
                    loadProductStats();
                    loadProducts();
                }, 1500);
            })
            .catch(error => {
                console.error('Update error:', error);

                // Provide more specific error messages
                let errorMessage = 'Failed to update product';
                if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message.includes('validation')) {
                    errorMessage = 'Validation error. Please check your input and try again.';
                } else if (error.message) {
                    errorMessage = error.message;
                }

                showToast(errorMessage, 'error');
            })
            .finally(() => {
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });
    }

    // Handle add product form submission
    const addForm = document.getElementById('add-product-form');
    if (addForm) {
        addForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(addForm);
            const submitButton = addForm.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;

            // Disable submit button and show loading
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Creating...';

            // Build product data
            const productData = {
                name: formData.get('name').trim(),
                description: formData.get('description')?.trim() || null,
                barcode: formData.get('barcode')?.trim() || null,
                category_id: formData.get('category_id') || null,
                price: parseFloat(formData.get('price')),
                cost_price: formData.get('cost_price') ? parseFloat(formData.get('cost_price')) : null,
                stock_quantity: parseInt(formData.get('stock_quantity')),
                min_stock_level: parseInt(formData.get('min_stock_level')),
                unit: formData.get('unit').trim(),
                supplier: formData.get('supplier')?.trim() || null,
                is_active: true
            };

            // Handle perfume-specific fields
            const bottleSizeMl = formData.get('bottle_size_ml');
            if (bottleSizeMl) {
                productData.bottle_size_ml = parseFloat(bottleSizeMl);
            }

            // Handle scent selection
            const scentSelect = document.getElementById('scent-select');
            if (scentSelect) {
                const selectedScents = Array.from(scentSelect.selectedOptions).map(option => option.value);
                if (selectedScents.length > 0) {
                    productData.scent_ids = selectedScents;
                }
            }

            // Handle decant information
            const isDecantable = formData.get('is_decantable') === 'on';
            if (isDecantable) {
                const decantSizeMl = formData.get('decant_size_ml');
                const decantPrice = formData.get('decant_price');

                productData.decant = {
                    is_decantable: true,
                    decant_size_ml: decantSizeMl ? parseFloat(decantSizeMl) : null,
                    decant_price: decantPrice ? parseFloat(decantPrice) : null,
                    opened_bottle_ml_left: 0.0  // Start with no opened bottles
                };
            }

            console.log('Creating product with data:', productData);

            // Send create request
            fetch('/api/products/', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Failed to create product');
                    });
                }
                return response.json();
            })
            .then(async (data) => {
                console.log('Product created successfully:', data);

                // Check if image was selected for upload
                const imageFile = document.getElementById('product-image').files[0];
                if (imageFile && data.product_id) {
                    try {
                        console.log('Uploading image for product:', data.product_id);
                        await uploadProductImage(data.product_id, imageFile);
                        showToast('Product created with image successfully!', 'success');
                    } catch (imageError) {
                        console.error('Failed to upload image:', imageError);
                        showToast('Product created but image upload failed', 'warning');
                    }
                } else {
                    showToast('Product created successfully!', 'success');
                }

                // Reset form and close modal
                addForm.reset();
                clearImagePreview('product-image', 'add-image-preview');
                closeAddProductModal();

                // Refresh data
                loadProductStats();
                loadProducts();
            })
            .catch(error => {
                console.error('Create error:', error);
                showToast(error.message || 'Failed to create product', 'error');
            })
            .finally(() => {
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });
    }
});

// Profit margin calculation for add product modal
function calculateProfitMargin() {
    const costPrice = parseFloat(document.getElementById('add-cost-price').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('add-selling-price').value) || 0;
    const profitDisplay = document.getElementById('profit-margin-display');
    const profitAmount = document.getElementById('profit-amount');
    const profitPercentage = document.getElementById('profit-percentage');

    if (costPrice > 0 && sellingPrice > 0) {
        const profit = sellingPrice - costPrice;
        const marginPercentage = ((profit / costPrice) * 100).toFixed(1);

        // Update display
        profitAmount.textContent = `${profit >= 0 ? '+' : ''}UGX ${profit.toLocaleString()}`;
        profitPercentage.textContent = `${marginPercentage}% margin`;

        // Color coding based on profit
        if (profit > 0) {
            profitDisplay.className = 'bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3';
            profitAmount.className = 'text-sm font-bold text-green-800';
            profitPercentage.className = 'text-xs text-green-600';
        } else if (profit < 0) {
            profitDisplay.className = 'bg-gradient-to-r from-red-50 to-red-50 border border-red-200 rounded-lg p-3';
            profitAmount.className = 'text-sm font-bold text-red-800';
            profitPercentage.className = 'text-xs text-red-600';
        } else {
            profitDisplay.className = 'bg-gradient-to-r from-gray-50 to-gray-50 border border-gray-200 rounded-lg p-3';
            profitAmount.className = 'text-sm font-bold text-gray-800';
            profitPercentage.className = 'text-xs text-gray-600';
        }

        profitDisplay.classList.remove('hidden');
    } else {
        profitDisplay.classList.add('hidden');
    }
}

// Profit margin calculation for edit product modal
function calculateEditProfitMargin() {
    const costPrice = parseFloat(document.getElementById('edit-cost-price').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('edit-price').value) || 0;
    const profitDisplay = document.getElementById('edit-profit-margin-display');
    const profitAmount = document.getElementById('edit-profit-amount');
    const profitPercentage = document.getElementById('edit-profit-percentage');

    if (costPrice > 0 && sellingPrice > 0) {
        const profit = sellingPrice - costPrice;
        const marginPercentage = ((profit / costPrice) * 100).toFixed(1);

        // Update display
        profitAmount.textContent = `${profit >= 0 ? '+' : ''}UGX ${profit.toLocaleString()}`;
        profitPercentage.textContent = `${marginPercentage}% margin`;

        // Color coding based on profit
        if (profit > 0) {
            profitDisplay.className = 'bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3 md:col-span-2';
            profitAmount.className = 'text-sm font-bold text-green-800';
            profitPercentage.className = 'text-xs text-green-600';
        } else if (profit < 0) {
            profitDisplay.className = 'bg-gradient-to-r from-red-50 to-red-50 border border-red-200 rounded-lg p-3 md:col-span-2';
            profitAmount.className = 'text-sm font-bold text-red-800';
            profitPercentage.className = 'text-xs text-red-600';
        } else {
            profitDisplay.className = 'bg-gradient-to-r from-gray-50 to-gray-50 border border-gray-200 rounded-lg p-3 md:col-span-2';
            profitAmount.className = 'text-sm font-bold text-gray-800';
            profitPercentage.className = 'text-xs text-gray-600';
        }

        profitDisplay.classList.remove('hidden');
    } else {
        profitDisplay.classList.add('hidden');
    }
}

// Global variable to store product info for deletion
let productToDelete = null;

function deleteProduct(productId) {
    console.log('Deleting product:', productId);

    try {
        // Find the product in the current loaded data
        const productRow = document.querySelector(`button[onclick="deleteProduct('${productId}')"]`).closest('tr');
        console.log('Found product row:', productRow);

        if (!productRow) {
            console.error('Could not find product row');
            showToast('Error: Could not find product information', 'error');
            return;
        }

        // Extract product information from the table row
        const productNameElement = productRow.querySelector('td:nth-child(1) .font-medium');
        const productCategoryElement = productRow.querySelector('td:nth-child(2) span'); // Category is in the 2nd column

        const productName = productNameElement ? productNameElement.textContent.trim() : 'Unknown Product';
        const productCategory = productCategoryElement ? productCategoryElement.textContent.trim() : 'No Category';

        console.log('Product details:', { productName, productCategory });

        // Store product info globally for the modal
        productToDelete = {
            id: productId,
            name: productName,
            category: productCategory
        };

        // Update modal content
        document.getElementById('delete-product-name').textContent = productName;
        document.getElementById('delete-product-category').textContent = `Category: ${productCategory}`;

        // Clear previous input and errors
        document.getElementById('delete-confirmation-input').value = '';
        document.getElementById('delete-input-error').classList.add('hidden');

        // Show the modal with animation
        const modal = document.getElementById('delete-product-modal');
        modal.classList.remove('hidden');

        // Add entrance animation
        setTimeout(() => {
            modal.querySelector('.bg-white').style.transform = 'scale(1)';
            modal.querySelector('.bg-white').style.opacity = '1';
        }, 10);

        // Focus on the input field
        setTimeout(() => {
            document.getElementById('delete-confirmation-input').focus();
        }, 150);

    } catch (error) {
        console.error('Error in deleteProduct:', error);
        showToast('Error preparing product deletion', 'error');
    }
}

function closeDeleteModal() {
    document.getElementById('delete-product-modal').classList.add('hidden');
    document.getElementById('delete-confirmation-input').value = '';
    document.getElementById('delete-input-error').classList.add('hidden');
    productToDelete = null;
}

function confirmDelete() {
    const confirmationInput = document.getElementById('delete-confirmation-input').value.trim();
    const errorElement = document.getElementById('delete-input-error');

    if (confirmationInput !== 'DELETE') {
        errorElement.classList.remove('hidden');
        document.getElementById('delete-confirmation-input').focus();
        return;
    }

    if (!productToDelete) {
        showToast('Error: No product selected for deletion', 'error');
        closeDeleteModal();
        return;
    }

    // Hide error and proceed with deletion
    errorElement.classList.add('hidden');

    // Close modal
    closeDeleteModal();

    // Perform the deletion
    performDeleteProduct(productToDelete.id, productToDelete.name);
}

// Add keyboard support for the delete modal
document.addEventListener('keydown', function(event) {
    const modal = document.getElementById('delete-product-modal');
    if (!modal.classList.contains('hidden')) {
        if (event.key === 'Escape') {
            closeDeleteModal();
        } else if (event.key === 'Enter') {
            event.preventDefault();
            confirmDelete();
        }
    }
});

// Add input event listener for real-time validation
document.addEventListener('DOMContentLoaded', function() {
    const confirmationInput = document.getElementById('delete-confirmation-input');
    const errorElement = document.getElementById('delete-input-error');

    if (confirmationInput) {
        confirmationInput.addEventListener('input', function() {
            if (this.value.trim() === 'DELETE') {
                errorElement.classList.add('hidden');
            }
        });
    }
});

function performDeleteProduct(productId, productName) {
    console.log('Performing delete for product:', productId);

    // Make API call to delete
    fetch(`/api/products/${productId}`, {
        method: 'DELETE',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.detail || 'Failed to delete product');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Product deleted successfully:', data);
        showToast(data.message || `Product "${productName}" deleted successfully!`, 'success');

        // Refresh data
        loadProducts();
        loadStats();
    })
    .catch(error => {
        console.error('Delete error:', error);
        showToast(error.message || 'Failed to delete product', 'error');
    });
}

// Load scents for add modal
async function loadScents() {
    try {
        const response = await fetch('/api/scents?active_only=true', {
            credentials: 'include'
        });

        if (response.ok) {
            const scents = await response.json();
            const scentSelect = document.getElementById('scent-select');

            // Clear existing options
            scentSelect.innerHTML = '';

            // Add scent options
            scents.forEach(scent => {
                const option = document.createElement('option');
                option.value = scent.id;
                option.textContent = scent.name;
                scentSelect.appendChild(option);
            });

            return Promise.resolve();
        }
    } catch (error) {
        console.error('Error loading scents:', error);
        return Promise.reject(error);
    }
}

// Load scents for edit modal
async function loadScentsForEdit() {
    try {
        const response = await fetch('/api/scents?active_only=true', {
            credentials: 'include'
        });

        if (response.ok) {
            const scents = await response.json();
            const scentSelect = document.getElementById('edit-scent-select');

            // Clear existing options
            scentSelect.innerHTML = '';

            // Add scent options
            scents.forEach(scent => {
                const option = document.createElement('option');
                option.value = scent.id;
                option.textContent = scent.name;
                scentSelect.appendChild(option);
            });

            return Promise.resolve();
        }
    } catch (error) {
        console.error('Error loading scents for edit:', error);
        return Promise.reject(error);
    }
}



// Product Details Modal Functions
function viewProductDetails(productId) {
    // Show modal immediately with loading state
    showLoadingProductDetails();
    document.getElementById('product-details-modal').classList.remove('hidden');

    // Fetch product details with all information included
    fetch(`/api/products/${productId}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(async (productResponse) => {
        if (!productResponse.ok) {
            throw new Error(`HTTP error! status: ${productResponse.status}`);
        }

        const product = await productResponse.json();

        // API now provides all data including supplier info and perfume details
        displayProductDetails(product);
    })
    .catch(error => {
        console.error('Error fetching product details:', error);
        showProductDetailsError('Failed to load product details');
    });
}

function closeProductDetailsModal() {
    document.getElementById('product-details-modal').classList.add('hidden');
}

function showLoadingProductDetails() {
    const content = document.getElementById('product-details-content');
    content.innerHTML = `
        <div class="flex items-center justify-center py-8">
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                <p class="text-gray-600 text-sm">Loading...</p>
            </div>
        </div>
    `;
}

function showProductDetailsError(message) {
    const content = document.getElementById('product-details-content');
    content.innerHTML = `
        <div class="flex items-center justify-center py-12">
            <div class="text-center">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500"></i>
                </div>
                <p class="text-red-600">${message}</p>
                <button onclick="closeProductDetailsModal()" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    `;
}

function refreshData() {
    loadProductStats();
    loadProducts();
    loadCategories();
    showToast('Data refreshed successfully', 'success');
}

function exportProducts() {
    showToast('Export functionality coming soon', 'info');
}

function displayProductDetails(product) {
    const content = document.getElementById('product-details-content');
    const titleElement = document.getElementById('product-details-title');

    const isPerfume = product.is_perfume_with_decants || false;
    const decant = product.decant || null;

    // Update modal title with product name
    if (titleElement) {
        titleElement.textContent = product.name;
    }

    // Perfume details and suppliers are now handled in the side-by-side layout below

    content.innerHTML = `
        <div class="space-y-3">
            <!-- Product Header with Image -->
            <div class="relative bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 rounded-lg p-3 border border-slate-200 shadow-sm overflow-hidden">
                <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-blue-400/10 to-indigo-500/10 rounded-full -translate-y-8 translate-x-8"></div>
                <div class="relative">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-start space-x-3">
                            ${product.image && product.image.medium_url ? `
                                <div class="w-16 h-16 rounded-lg overflow-hidden shadow-md border-2 border-white flex-shrink-0 cursor-pointer hover:shadow-lg transition-shadow duration-200"
                                     onclick="showLargeImage('${product.image.large_url || product.image.url}', '${product.name}')"
                                     title="Click to view larger image">
                                    <img src="${product.image.medium_url}" alt="${product.name}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-200">
                                </div>
                            ` : `
                                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md border-2 border-white flex-shrink-0">
                                    <i class="fas fa-box text-white text-lg"></i>
                                </div>
                            `}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center mb-1">
                                    <div class="w-1.5 h-1.5 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full mr-2"></div>
                                    <h2 class="text-lg font-bold text-slate-800 truncate">${product.name}</h2>
                                </div>
                            <div class="flex flex-wrap items-center gap-1.5 text-xs text-slate-600 mb-2">

                                <span class="inline-flex items-center px-1.5 py-0.5 rounded bg-white/60 backdrop-blur-sm">
                                    <i class="fas fa-folder text-indigo-500 mr-1 text-xs"></i>${product.category_name || 'No category'}
                                </span>
                                ${product.barcode ? `<span class="inline-flex items-center px-1.5 py-0.5 rounded bg-white/60 backdrop-blur-sm">
                                    <i class="fas fa-barcode text-purple-500 mr-1 text-xs"></i>${product.barcode}
                                </span>` : ''}
                            </div>
                            <div class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                                UGX ${product.price.toLocaleString()}
                            </div>
                            {% if user and (user.role == 'admin' or user.role == 'manager') %}
                            <div class="flex items-center gap-2 mt-1 text-sm">
                                ${product.cost_price ? `<span class="text-slate-600">Cost: <span class="font-semibold">UGX ${product.cost_price.toLocaleString()}</span></span>` : ''}
                                ${product.profit_margin ? `<span class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 font-semibold text-xs">
                                    <i class="fas fa-chart-line mr-1"></i>${product.profit_margin.toFixed(1)}%
                                </span>` : ''}
                            </div>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                    ${product.description ? `<div class="bg-white/50 backdrop-blur-sm rounded p-2 border border-white/60 mt-2">
                        <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Description</div>
                        <p class="text-slate-700 text-xs leading-relaxed">${product.description}</p>
                    </div>` : ''}
                </div>
            </div>

            <!-- Stock Information Grid -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-2">
                <div class="group bg-white rounded p-2 border border-slate-200 shadow-sm hover:shadow-md transition-all duration-200 hover:border-blue-300">
                    <div class="flex items-center justify-between mb-1">
                        <div class="w-5 h-5 bg-blue-100 rounded flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                            <i class="fas fa-boxes text-blue-600 text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Stock</span>
                    </div>
                    <div class="text-xs font-bold text-slate-800">
                        ${product.stock_quantity} ${product.unit}${isPerfume && product.bottle_size_ml ? ` & ${product.bottle_size_ml}mls` : ''}
                    </div>
                </div>

                <div class="group bg-white rounded p-2 border border-slate-200 shadow-sm hover:shadow-md transition-all duration-200 hover:border-emerald-300">
                    <div class="flex items-center justify-between mb-1">
                        <div class="w-5 h-5 bg-emerald-100 rounded flex items-center justify-center group-hover:bg-emerald-200 transition-colors">
                            <i class="fas fa-signal text-emerald-600 text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Status</span>
                    </div>
                    <div class="text-xs font-semibold ${getStockStatusColor(product.stock_status)}">${getStockStatusText(product.stock_status)}</div>
                </div>

                <div class="group bg-white rounded p-2 border border-slate-200 shadow-sm hover:shadow-md transition-all duration-200 hover:border-amber-300">
                    <div class="flex items-center justify-between mb-1">
                        <div class="w-5 h-5 bg-amber-100 rounded flex items-center justify-center group-hover:bg-amber-200 transition-colors">
                            <i class="fas fa-arrow-down text-amber-600 text-xs"></i>
                        </div>
                        <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">Min</span>
                    </div>
                    <div class="text-xs font-semibold text-slate-700">${product.min_stock_level} ${product.unit}</div>
                </div>


            </div>

            <!-- Perfume Details and Suppliers Side by Side -->
            ${isPerfume && product.perfume_details ? `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                <!-- Perfume Details Section -->
                <div class="bg-gradient-to-br from-purple-50 via-pink-50 to-rose-50 rounded-lg p-3 border border-purple-200 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-pink-500 rounded flex items-center justify-center mr-2">
                            <i class="fas fa-spray-can text-white text-xs"></i>
                        </div>
                        <h3 class="text-sm font-bold text-purple-800">Perfume Details</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60">
                            <div class="text-xs font-medium text-purple-600 uppercase tracking-wide mb-0.5">Perfume</div>
                            <div class="text-xs font-bold text-purple-800">${product.perfume_details.available_decants} decants</div>
                        </div>

                        <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60">
                            <div class="text-xs font-medium text-pink-600 uppercase tracking-wide mb-0.5">Bottle</div>
                            <div class="text-xs font-bold text-pink-800">${product.perfume_details.bottle_size_ml}ml</div>
                        </div>

                        <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60">
                            <div class="text-xs font-medium text-rose-600 uppercase tracking-wide mb-0.5">Total</div>
                            <div class="text-xs font-bold text-rose-800">${product.perfume_details.total_ml_available}ml</div>
                        </div>

                        <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60">
                            <div class="text-xs font-medium text-purple-600 uppercase tracking-wide mb-0.5">Decant</div>
                            <div class="text-xs font-bold text-purple-800">${product.perfume_details.decant_size_ml}ml</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-2">
                        <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60">
                            <div class="text-xs font-medium text-emerald-600 uppercase tracking-wide mb-0.5">Price</div>
                            <div class="text-sm font-bold text-emerald-800">UGX ${product.perfume_details.decant_price.toLocaleString()}</div>
                        </div>

                        <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60">
                            <div class="text-xs font-medium text-amber-600 uppercase tracking-wide mb-0.5">Opened</div>
                            <div class="text-xs font-bold text-amber-800">${product.perfume_details.opened_bottle_ml_left}ml left</div>
                        </div>
                    </div>

                    ${product.scents && product.scents.length > 0 ? `
                    <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60 mt-2">
                        <div class="text-xs font-medium text-indigo-600 uppercase tracking-wide mb-1">Available Scents</div>
                        <div class="flex flex-wrap gap-1">
                            ${product.scents.map(scent => `
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800 border border-purple-200">
                                    <i class="fas fa-spray-can text-purple-600 mr-1" style="font-size: 8px;"></i>
                                    ${scent.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Suppliers Section -->
                {% if user and (user.role == 'admin' or user.role == 'manager') %}
                <div class="bg-gradient-to-br from-teal-50 via-cyan-50 to-blue-50 rounded-lg p-3 border border-teal-200 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-6 h-6 bg-gradient-to-r from-teal-500 to-cyan-500 rounded flex items-center justify-center mr-2">
                            <i class="fas fa-users text-white text-xs"></i>
                        </div>
                        <h3 class="text-sm font-bold text-teal-800">Suppliers</h3>
                        ${product.suppliers_info && product.suppliers_info.length > 0 ? `
                        <span class="ml-auto inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                            ${product.suppliers_info.length} supplier${product.suppliers_info.length > 1 ? 's' : ''}
                        </span>
                        ` : ''}
                    </div>

                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${product.suppliers_info && product.suppliers_info.length > 0 ?
                            product.suppliers_info.map(supplier => `
                            <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60 ${supplier.is_current ? 'ring-1 ring-teal-300' : ''}">
                                <div class="flex items-center justify-between mb-1">
                                    <h4 class="text-xs font-bold text-teal-800">${supplier.name}</h4>
                                    <div class="flex items-center gap-1 flex-wrap">
                                        ${supplier.is_current ? '<span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Current</span>' : ''}
                                        <span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium ${supplier.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${supplier.is_active ? 'Active' : 'Inactive'}
                                        </span>
                                        ${supplier.found_in_expenses ? '<span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">History</span>' : ''}
                                        ${supplier.is_potential ? '<span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Potential</span>' : ''}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 gap-2 text-xs">
                                    ${supplier.email ? `
                                    <div class="flex items-center">
                                        <i class="fas fa-envelope text-teal-500 mr-2 w-3"></i>
                                        <a href="mailto:${supplier.email}" class="text-teal-700 hover:text-teal-900 hover:underline transition-colors duration-200" title="Send email to ${supplier.email}">${supplier.email}</a>
                                    </div>
                                    ` : ''}

                                    ${supplier.phone ? `
                                    <div class="flex items-center">
                                        <i class="fas fa-phone text-cyan-500 mr-2 w-3"></i>
                                        <a href="tel:${supplier.phone}" class="text-cyan-700 hover:text-cyan-900 hover:underline transition-colors duration-200" title="Call ${supplier.phone}">${supplier.phone}</a>
                                    </div>
                                    ` : ''}

                                    ${supplier.address ? `
                                    <div class="flex items-start">
                                        <i class="fas fa-map-marker-alt text-blue-500 mr-2 w-3 mt-0.5"></i>
                                        <span class="text-blue-700">${supplier.address}</span>
                                    </div>
                                    ` : ''}

                                    ${supplier.notes ? `
                                    <div class="flex items-start">
                                        <i class="fas fa-sticky-note text-teal-500 mr-2 w-3 mt-0.5"></i>
                                        <span class="text-teal-700">${supplier.notes}</span>
                                    </div>
                                    ` : ''}
                                </div>

                                <!-- Recent Price Information -->
                                ${supplier.pricing && supplier.pricing.price_count > 0 ? `
                                <div class="mt-2 pt-1 border-t border-teal-200">
                                    <div class="text-xs font-medium text-teal-600 uppercase tracking-wide mb-1">Recent Price</div>
                                    <div class="bg-emerald-50 rounded p-2">
                                        <div class="flex items-center justify-between">
                                            <div class="text-emerald-600 font-medium text-xs">Latest Price</div>
                                            <div class="text-emerald-800 font-bold text-sm">UGX ${supplier.pricing.latest_price.toLocaleString()}</div>
                                        </div>

                                    </div>
                                </div>
                                ` : supplier.is_potential ? '' : `
                                <div class="mt-2 pt-1 border-t border-gray-200">
                                    <div class="text-xs text-gray-500 italic">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        No pricing history
                                    </div>
                                </div>
                                `}
                            </div>
                            `).join('')
                        : '<div class="text-center text-gray-500 py-4"><i class="fas fa-info-circle mr-2"></i>No suppliers found</div>'}
                    </div>
                </div>
                 {% endif %}
            </div>
            ` : `
            <!-- Non-perfume products: Show scents and suppliers -->
            <div class="space-y-3">
                ${product.scents && product.scents.length > 0 ? `
                <div class="bg-gradient-to-br from-purple-50 via-pink-50 to-rose-50 rounded-lg p-3 border border-purple-200 shadow-sm">
                    <div class="flex items-center mb-2">
                        <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-pink-500 rounded flex items-center justify-center mr-2">
                            <i class="fas fa-spray-can text-white text-xs"></i>
                        </div>
                        <h3 class="text-sm font-bold text-purple-800">Available Scents</h3>
                        <span class="ml-auto inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            ${product.scents.length} scent${product.scents.length > 1 ? 's' : ''}
                        </span>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${product.scents.map(scent => `
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-purple-100 to-pink-100 text-purple-800 border border-purple-200">
                                <i class="fas fa-spray-can text-purple-600 mr-1" style="font-size: 8px;"></i>
                                ${scent.name}
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

            ${product.suppliers_info && product.suppliers_info.length > 0 ? `
            {% if user and (user.role == 'admin' or user.role == 'manager') %}
            <div class="bg-gradient-to-br from-teal-50 via-cyan-50 to-blue-50 rounded-lg p-3 border border-teal-200 shadow-sm">
                <div class="flex items-center mb-2">
                    <div class="w-6 h-6 bg-gradient-to-r from-teal-500 to-cyan-500 rounded flex items-center justify-center mr-2">
                        <i class="fas fa-users text-white text-xs"></i>
                    </div>
                    <h3 class="text-sm font-bold text-teal-800">Suppliers</h3>
                    <span class="ml-auto inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                        ${product.suppliers_info.length} supplier${product.suppliers_info.length > 1 ? 's' : ''}
                    </span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-2">
                    ${product.suppliers_info.map(supplier => `
                    <div class="bg-white/70 backdrop-blur-sm rounded p-2 border border-white/60 ${supplier.is_current ? 'ring-1 ring-teal-300' : ''}">
                        <div class="flex items-center justify-between mb-1">
                            <h4 class="text-xs font-bold text-teal-800">${supplier.name}</h4>
                            <div class="flex items-center gap-1 flex-wrap">
                                ${supplier.is_current ? '<span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Current</span>' : ''}
                                <span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium ${supplier.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${supplier.is_active ? 'Active' : 'Inactive'}
                                </span>
                                ${supplier.found_in_expenses ? '<span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">History</span>' : ''}
                                ${supplier.is_potential ? '<span class="inline-flex items-center px-1 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Potential</span>' : ''}
                            </div>
                        </div>

                        <div class="space-y-2 text-xs">
                            ${supplier.email ? `
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-teal-500 mr-2 w-3"></i>
                                <a href="mailto:${supplier.email}" class="text-teal-700 hover:text-teal-900 hover:underline transition-colors duration-200" title="Send email to ${supplier.email}">${supplier.email}</a>
                            </div>
                            ` : ''}

                            ${supplier.phone ? `
                            <div class="flex items-center">
                                <i class="fas fa-phone text-cyan-500 mr-2 w-3"></i>
                                <a href="tel:${supplier.phone}" class="text-cyan-700 hover:text-cyan-900 hover:underline transition-colors duration-200" title="Call ${supplier.phone}">${supplier.phone}</a>
                            </div>
                            ` : ''}

                            ${supplier.address ? `
                            <div class="flex items-start">
                                <i class="fas fa-map-marker-alt text-blue-500 mr-2 w-3 mt-0.5"></i>
                                <span class="text-blue-700">${supplier.address}</span>
                            </div>
                            ` : ''}

                            <!-- Recent Price Information for Non-Perfume Products -->
                            ${supplier.pricing && supplier.pricing.price_count > 0 ? `
                            <div class="mt-1 pt-1 border-t border-teal-200">
                                <div class="flex items-center justify-between">
                                    <span class="text-emerald-600 font-medium text-xs">Recent Price:</span>
                                    <span class="text-emerald-800 font-bold text-xs">UGX ${supplier.pricing.latest_price.toLocaleString()}</span>
                                </div>

                            </div>
                            ` : supplier.is_potential ? '' : `
                            <div class="mt-1 pt-1 border-t border-gray-200">
                                <div class="text-xs text-gray-500 italic">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    No pricing history
                                </div>
                            </div>
                            `}
                        </div>
                    </div>
                    `).join('')}
                </div>
            </div>
            {% endif %}
            ` : ''}
            </div>
            `}

            <!-- Timeline Information -->
            <div class="bg-gradient-to-br from-gray-50 via-slate-50 to-gray-100 rounded-lg p-3 border border-gray-200 shadow-sm">
                <div class="flex items-center mb-2">
                    <div class="w-6 h-6 bg-gradient-to-r from-gray-500 to-slate-500 rounded flex items-center justify-center mr-2">
                        <i class="fas fa-clock text-white text-xs"></i>
                    </div>
                    <h3 class="text-sm font-bold text-gray-800">Timeline</h3>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <div class="flex items-center">
                        <div class="w-5 h-5 bg-green-100 rounded flex items-center justify-center mr-2">
                            <i class="fas fa-plus text-green-600 text-xs"></i>
                        </div>
                        <div>
                            <div class="text-xs font-medium text-green-600 uppercase tracking-wide">Created</div>
                            <div class="text-xs font-semibold text-gray-800">${formatDate(product.created_at)}</div>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <div class="w-5 h-5 bg-blue-100 rounded flex items-center justify-center mr-2">
                            <i class="fas fa-edit text-blue-600 text-xs"></i>
                        </div>
                        <div>
                            <div class="text-xs font-medium text-blue-600 uppercase tracking-wide">Updated</div>
                            <div class="text-xs font-semibold text-gray-800">${product.updated_at ? formatDate(product.updated_at) : 'Never'}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Helper functions for status styling
function getStockStatusColor(status) {
    switch(status) {
        case 'in-stock': return 'text-green-600';
        case 'low-stock': return 'text-yellow-600';
        case 'out-of-stock': return 'text-red-600';
        default: return 'text-gray-600';
    }
}

function getStockStatusText(status) {
    switch(status) {
        case 'in-stock': return 'In Stock';
        case 'low-stock': return 'Low Stock';
        case 'out-of-stock': return 'Out of Stock';
        default: return 'Unknown';
    }
}

// Helper function to format dates
function formatDate(dateString) {
    if (!dateString) return 'N/A';

    try {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    } catch (error) {
        return 'Invalid date';
    }
}

// Load products on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - initializing page');

    // Load initial data
    console.log('Loading product stats...');
    loadProductStats();

    console.log('Loading products...');
    loadProducts();

    console.log('Loading categories...');
    loadCategories();

    // Setup infinite scroll
    setupInfiniteScroll();

    // Add event listeners for real-time filtering
    const searchInput = document.getElementById('search-products');
    const categoryFilter = document.getElementById('category-filter');
    const stockFilter = document.getElementById('stock-filter');

    // Debounce search input
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadProducts(true); // Reset pagination when searching
        }, 500); // Wait 500ms after user stops typing
    });

    // Filter on dropdown changes
    categoryFilter.addEventListener('change', function() {
        loadProducts(true); // Reset pagination when filtering
    });

    stockFilter.addEventListener('change', function() {
        loadProducts(true); // Reset pagination when filtering
    });

    // Check for success/error messages in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const successMessage = urlParams.get('success');
    const errorMessage = urlParams.get('error');

    if (successMessage) {
        showToast(successMessage, 'success');
        // Reload data after successful creation
        loadProductStats();
        loadProducts();
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    if (errorMessage) {
        showToast(errorMessage, 'error');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

// Image handling functions
function handleImagePreview(input, previewId) {
    const file = input.files[0];
    const previewDiv = document.getElementById(previewId);

    if (file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            input.value = '';
            return;
        }

        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
            alert('Image size must be less than 10MB');
            input.value = '';
            return;
        }

        // Create preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewDiv.innerHTML = `
                <div class="relative">
                    <img src="${e.target.result}" alt="Preview" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                    <button type="button" onclick="clearImagePreview('${input.id}', '${previewId}')"
                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                        ×
                    </button>
                </div>
                <p class="text-xs text-gray-600 mt-2">${file.name}</p>
            `;
        };
        reader.readAsDataURL(file);
    }
}

function clearImagePreview(inputId, previewId) {
    document.getElementById(inputId).value = '';
    const previewDiv = document.getElementById(previewId);
    previewDiv.innerHTML = `
        <i class="fas fa-cloud-upload-alt text-gray-400 text-2xl mb-2"></i>
        <p class="text-sm text-gray-600">Click to upload product image</p>
        <p class="text-xs text-gray-500 mt-1">PNG, JPG, WEBP up to 10MB</p>
    `;
}

async function uploadProductImage(productId, file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch(`/api/products/${productId}/upload-image`, {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error uploading image:', error);
        throw error;
    }
}

async function deleteProductImage() {
    if (!currentEditProductId) return;

    if (!confirm('Are you sure you want to delete this product image?')) {
        return;
    }

    try {
        const response = await fetch(`/api/products/${currentEditProductId}/image`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Clear the preview and hide delete button
        clearImagePreview('edit-product-image', 'edit-image-preview');
        document.getElementById('delete-image-btn').classList.add('hidden');

        showToast('Image deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting image:', error);
        showToast('Failed to delete image', 'error');
    }
}

// Function to show large image in modal
function showLargeImage(imageUrl, productName) {
    // Create modal HTML
    const modalHtml = `
        <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="relative max-w-4xl max-h-full">
                <button onclick="closeLargeImage()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
                    <i class="fas fa-times text-lg"></i>
                </button>
                <div class="bg-white rounded-lg overflow-hidden shadow-2xl">
                    <div class="p-4 bg-gray-50 border-b">
                        <h3 class="text-lg font-semibold text-gray-900">${productName}</h3>
                    </div>
                    <div class="p-4">
                        <img src="${imageUrl}" alt="${productName}" class="max-w-full max-h-[70vh] object-contain mx-auto">
                    </div>
                </div>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Add click outside to close
    document.getElementById('image-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLargeImage();
        }
    });

    // Add escape key to close
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLargeImage();
        }
    });
}

function closeLargeImage() {
    const modal = document.getElementById('image-modal');
    if (modal) {
        modal.remove();
    }
}

</script>
{% endblock %}
