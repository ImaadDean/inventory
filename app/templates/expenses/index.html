{% extends "base.html" %}

{% block title %}Expenses - Inventory Management System{% endblock %}

{% block extra_head %}
<style>
    /* Enhanced skeleton animation */
    @keyframes shimmer {
        0% {
            background-position: -200px 0;
        }
        100% {
            background-position: calc(200px + 100%) 0;
        }
    }

    .skeleton-shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200px 100%;
        animation: shimmer 1.5s infinite;
    }

    .payment-modal-transition {
        transition: all 0.3s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-red-500 to-pink-600 shadow-lg rounded-xl p-4 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="mb-2 md:mb-0">
                <h1 class="text-xl md:text-2xl font-bold">Expense Management</h1>
                <p class="text-red-100 text-sm">Track and manage business expenses and payments</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="openAddExpenseModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm">
                    <i class="fas fa-plus"></i>
                    <span class="font-medium">Add Expense</span>
                </button>
                <button onclick="openCategoriesModal()" class="bg-white bg-opacity-10 hover:bg-opacity-20 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm border border-white border-opacity-30">
                    <i class="fas fa-tags"></i>
                    <span class="font-medium">Categories</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <!-- Total Expenses -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-red-400 to-red-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-receipt text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Total Expenses</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-expenses">UGX 0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-red-50 to-red-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-red-700 font-medium">All time expenses</span>
                </div>
            </div>
        </div>

        <!-- This Month -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-calendar-month text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">This Month</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="month-expenses">UGX 0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-blue-700 font-medium">Current month total</span>
                </div>
            </div>
        </div>

        <!-- Pending Payments -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-clock text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Pending</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="pending-expenses">UGX 0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-yellow-50 to-orange-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-orange-700 font-medium">Remaining balance</span>
                </div>
            </div>
        </div>

        <!-- Categories -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-tags text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Categories</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="expense-categories">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-purple-700 font-medium">Expense types</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Expenses Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300">
        <!-- Table Header with Search & Filters -->
        <div class="px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-gradient-to-r from-red-500 to-pink-600 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-table text-white text-xs"></i>
                    </div>
                    <h3 class="text-base font-semibold text-gray-900">Expense Records</h3>
                </div>

                <!-- Compact Search & Filter Controls -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <div class="relative">
                        <input type="text" id="search-expenses" placeholder="Search expenses..."
                               class="pl-7 pr-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent w-full sm:w-40 text-xs transition-all duration-200">
                        <i class="fas fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                    </div>
                    <select id="category-filter" class="px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-xs transition-all duration-200">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                    <select id="status-filter" class="px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-xs transition-all duration-200">
                        <option value="">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                        <option value="partially_paid">Partially Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                    <div class="flex items-center space-x-1">
                        <input type="date" id="date-from" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200" title="From Date">
                        <span class="text-gray-400 text-xs">to</span>
                        <input type="date" id="date-to" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200" title="To Date">
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="applyFilters()" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1.5 rounded-lg flex items-center space-x-1 text-xs transition-all duration-200">
                            <i class="fas fa-refresh text-xs"></i>
                            <span>Refresh</span>
                        </button>
                        <button onclick="exportExpenses()" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1.5 rounded-lg flex items-center space-x-1 text-xs transition-all duration-200">
                            <i class="fas fa-download text-xs"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Description</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount Paid</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Payment Method</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="expenses-table-body" class="bg-white divide-y divide-gray-100">
                    <!-- Expenses will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Expenses Status Section -->
        <div id="expenses-status-container" class="mt-4 px-4 py-3 bg-white border-t border-gray-200">
            <div class="flex flex-col items-center space-y-3">
                <!-- Results info -->
                <div class="text-sm text-gray-700">
                    Showing <span id="showing-expenses-count" class="font-medium">0</span> of <span id="total-expenses-count" class="font-medium">0</span> expenses
                </div>

                <!-- Auto-loading indicator -->
                <div id="auto-loading-expenses-indicator" class="hidden flex items-center justify-center space-x-3 py-4 text-gray-600 bg-red-50 rounded-lg border border-red-200 transition-all duration-300">
                    <div class="animate-spin rounded-full h-5 w-5 border-2 border-red-600 border-t-transparent"></div>
                    <span class="text-sm font-medium">Loading more expenses...</span>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-red-600 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-red-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-red-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>

                <!-- End of results message -->
                <div id="end-of-expenses" class="hidden text-center py-6">
                    <div class="inline-flex items-center justify-center space-x-3 px-6 py-3 bg-green-50 border border-green-200 rounded-lg text-green-700">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-500 text-lg"></i>
                        </div>
                        <div class="text-sm font-medium">
                            You've reached the end of all expenses
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div id="add-expense-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-red-500 to-pink-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-plus text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Add New Expense</h3>
                    </div>
                    <button type="button" onclick="closeAddExpenseModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <form id="add-expense-form" class="p-4 space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-file-alt text-gray-400 mr-1"></i>Description
                    </label>
                    <input type="text" name="description" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200" placeholder="Enter expense description">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-tags text-gray-400 mr-1"></i>Category
                        </label>
                        <select name="category" id="expense-category-select" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                            <option value="">Select Category</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-dollar-sign text-gray-400 mr-1"></i>Amount (UGX)
                        </label>
                        <input type="number" name="amount" required min="0" step="0.01" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200" placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-calendar text-gray-400 mr-1"></i>Date
                        </label>
                        <input type="date" name="expense_date" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-credit-card text-gray-400 mr-1"></i>Payment Method
                        </label>
                        <select name="payment_method" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                            <option value="">Select Method</option>
                            <option value="not_paid">Not Paid</option>
                            <option value="mobile_money">📱 Mobile Money</option>
                            <option value="cash">💵 Cash</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-truck text-gray-400 mr-1"></i>Vendor/Supplier (Optional)
                    </label>
                    <button type="button" id="select-expense-supplier-btn" onclick="openSupplierSelectionModal()" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-white shadow-sm transition-all duration-200 text-left flex items-center justify-between hover:border-gray-400">
                        <span id="selected-expense-supplier-text" class="text-gray-500">Click to select supplier</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </button>
                    <input type="hidden" id="expense-vendor" name="vendor">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-sticky-note text-gray-400 mr-1"></i>Notes (Optional)
                    </label>
                    <textarea name="notes" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200" placeholder="Additional notes"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-info-circle text-gray-400 mr-1"></i>Status
                    </label>
                    <select name="status" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                        <option value="pending">Not Paid</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="closeAddExpenseModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="add-expense-btn" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-plus mr-1"></i>Add Expense
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Expense Modal -->
<div id="edit-expense-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-edit text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Edit Expense</h3>
                    </div>
                    <button type="button" onclick="closeEditExpenseModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <form id="edit-expense-form" class="p-4 space-y-3">
                <input type="hidden" id="edit-expense-id" name="expense_id">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-file-alt text-gray-400 mr-1"></i>Description
                    </label>
                    <input type="text" id="edit-description" name="description" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Enter expense description">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-tags text-gray-400 mr-1"></i>Category
                        </label>
                        <select name="category" id="edit-expense-category-select" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            <option value="">Select Category</option>
                            <!-- Categories will be loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-dollar-sign text-gray-400 mr-1"></i>Amount (UGX)
                        </label>
                        <input type="number" id="edit-amount" name="amount" required min="0" step="0.01" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-calendar text-gray-400 mr-1"></i>Date
                        </label>
                        <input type="date" id="edit-expense_date" name="expense_date" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-credit-card text-gray-400 mr-1"></i>Payment Method
                        </label>
                        <select name="payment_method" id="edit-payment_method" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                            <option value="">Select Method</option>
                            <option value="not_paid">Not Paid</option>
                            <option value="mobile_money">📱 Mobile Money</option>
                            <option value="cash">💵 Cash</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-truck text-gray-400 mr-1"></i>Vendor/Supplier (Optional)
                    </label>
                    <input type="text" id="edit-vendor" name="vendor" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Enter vendor name">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-sticky-note text-gray-400 mr-1"></i>Notes (Optional)
                    </label>
                    <textarea name="notes" id="edit-notes" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" placeholder="Additional notes"></textarea>
                </div>

                <div class="flex items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <input type="checkbox" id="edit-is_paid" name="is_paid" class="h-3 w-3 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="edit-is_paid" class="ml-2 block text-xs font-medium text-blue-900">
                        <i class="fas fa-check-circle text-blue-600 mr-1"></i>Mark as Paid
                    </label>
                </div>

                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="closeEditExpenseModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="update-expense-btn" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-save mr-1"></i>Update Expense
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Categories Management Modal -->
<div id="categories-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-tags text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Expense Categories</h3>
                    </div>
                    <button type="button" onclick="closeCategoriesModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <div class="p-4">
                <!-- Add Category Form -->
                <div class="mb-4 p-3 bg-gray-50 rounded-lg border">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Add New Category</h4>
                    <form id="add-category-form" class="flex space-x-2">
                        <input type="text" id="category-name" placeholder="Category name" required class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <input type="text" id="category-icon" placeholder="Icon (emoji)" maxlength="2" class="w-16 px-2 py-2 text-sm text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <button type="submit" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white text-sm rounded-lg transition-all duration-200">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </form>
                </div>

                <!-- Categories List -->
                <div class="space-y-2">
                    <h4 class="text-sm font-semibold text-gray-700">Current Categories</h4>
                    <div id="categories-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Categories will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-2 p-4 border-t border-gray-200">
                <button type="button" onclick="closeCategoriesModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div id="edit-category-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-edit text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Edit Category</h3>
                    </div>
                    <button type="button" onclick="closeEditCategoryModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <form id="edit-category-form" class="p-4 space-y-3">
                <input type="hidden" id="edit-category-id">

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Category Name</label>
                    <input type="text" id="edit-category-name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Icon (Emoji)</label>
                    <input type="text" id="edit-category-icon" maxlength="2" class="w-full px-3 py-2 text-sm text-center border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="closeEditCategoryModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-save mr-1"></i>Update
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- View Expense Modal -->
<div id="view-expense-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full transform transition-all duration-300 max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-receipt text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Expense Details</h3>
                            <p class="text-blue-100 text-sm" id="view-expense-category">Loading...</p>
                        </div>
                    </div>
                    <button onclick="closeViewExpenseModal()" class="text-white hover:text-blue-200 transition-colors duration-200 p-1 hover:bg-white hover:bg-opacity-10 rounded">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-4 space-y-4">
                <!-- Quick Stats -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-green-50 rounded-lg p-3 border border-green-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-money-bill-wave text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-green-600">Amount</div>
                                <div class="text-lg font-bold text-green-900" id="view-expense-amount">UGX 0</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-calendar-alt text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-blue-600">Date</div>
                                <div class="text-sm font-bold text-blue-900" id="view-expense-date">-
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-info-circle text-white text-xs"></i>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-purple-600">Status</div>
                                <div id="view-expense-status">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium">
                                        Loading...
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Left Column: Basic Info -->
                    <div class="space-y-4">
                        <!-- Expense Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-file-invoice text-gray-500 mr-2"></i>
                                Expense Information
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs font-semibold text-gray-600">Description</label>
                                    <div class="text-sm font-medium text-gray-900 mt-1 p-2 bg-white rounded border" id="view-expense-description">-
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">Category</label>
                                        <div class="text-sm font-medium text-gray-900 mt-1" id="view-expense-category-name">-
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">Vendor</label>
                                        <div class="text-sm font-medium text-gray-900 mt-1" id="view-expense-vendor">-
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200">
                            <h4 class="text-sm font-semibold text-indigo-900 mb-3 flex items-center">
                                <i class="fas fa-credit-card text-indigo-600 mr-2"></i>
                                Payment Information
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-indigo-700">Payment Method:</span>
                                    <span class="font-medium text-indigo-900" id="view-expense-payment-method">-
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-indigo-700">Payment Status:</span>
                                    <span class="font-medium text-indigo-900" id="view-expense-payment-status">-
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Additional Details -->
                    <div class="space-y-4">
                        <!-- System Information -->
                        <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                            <h4 class="text-sm font-semibold text-yellow-900 mb-3 flex items-center">
                                <i class="fas fa-cog text-yellow-600 mr-2"></i>
                                System Information
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-yellow-700">Created:</span>
                                    <span class="font-medium text-yellow-900" id="view-expense-created">-
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-yellow-700">Updated:</span>
                                    <span class="font-medium text-yellow-900" id="view-expense-updated">-
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-yellow-700">Created By:</span>
                                    <span class="font-medium text-yellow-900" id="view-expense-created-by">-
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-yellow-700">Auto Generated:</span>
                                    <span class="font-medium text-yellow-900" id="view-expense-auto-generated">-
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Products Section (for restock expenses) -->
                        <div class="bg-blue-50 rounded-lg p-4 hidden" id="view-expense-products-section">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center">
                                <i class="fas fa-boxes text-blue-500 mr-2"></i>
                                Products Restocked
                            </h4>
                            <div id="view-expense-products" class="space-y-2">
                                <!-- Products will be populated here -->
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="bg-gray-50 rounded-lg p-4" id="view-expense-notes-section">
                            <h4 class="text-sm font-semibold text-gray-900 mb-2 flex items-center">
                                <i class="fas fa-sticky-note text-gray-500 mr-2"></i>
                                Notes
                            </h4>
                            <div class="text-sm text-gray-700 p-2 bg-white rounded border min-h-[60px]" id="view-expense-notes">No additional notes available.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment History Section -->
                <div id="view-expense-payments-section" class="pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-history text-gray-500 mr-2"></i>
                        Payment History
                    </h4>
                    <div id="view-expense-payments-list" class="space-y-2">
                        <!-- Payments will be loaded here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button onclick="closeViewExpenseModal()" class="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Close
                    </button>
                    <button onclick="editExpenseFromView()" class="px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Helper functions for escaping strings
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeJs(text) {
        if (!text) return '';
        return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
    }

    // Pagination state variables
    let currentPage = 1;
    let totalExpenses = 0;
    let loadedExpensesCount = 0;
    let isLoading = false;
    let hasMoreExpenses = true;

    // Expense management functionality
    function openAddExpenseModal() {
        document.getElementById('add-expense-modal').classList.remove('hidden');
        // Set today's date as default
        document.querySelector('input[name="expense_date"]').value = new Date().toISOString().split('T')[0];
        // Load categories for the dropdown
        loadCategoriesForDropdown();
    }

    function closeAddExpenseModal() {
        document.getElementById('add-expense-modal').classList.add('hidden');
        document.getElementById('add-expense-form').reset();

        // Clear supplier selection
        const expenseVendorInput = document.getElementById('expense-vendor');
        const selectedExpenseSupplierText = document.getElementById('selected-expense-supplier-text');

        if (expenseVendorInput && selectedExpenseSupplierText) {
            expenseVendorInput.value = '';
            selectedExpenseSupplierText.textContent = 'Click to select supplier';
            selectedExpenseSupplierText.classList.remove('text-gray-900', 'font-medium');
            selectedExpenseSupplierText.classList.add('text-gray-500');
        }
    }

    // Categories Management
    function openCategoriesModal() {
        document.getElementById('categories-modal').classList.remove('hidden');
        loadCategories();
    }

    function closeCategoriesModal() {
        document.getElementById('categories-modal').classList.add('hidden');
    }

    function openEditCategoryModal(id, name, icon) {
        document.getElementById('edit-category-modal').classList.remove('hidden');
        document.getElementById('edit-category-id').value = id;
        document.getElementById('edit-category-name').value = name;
        document.getElementById('edit-category-icon').value = icon;
    }

    function closeEditCategoryModal() {
        document.getElementById('edit-category-modal').classList.add('hidden');
        document.getElementById('edit-category-form').reset();
    }

    function displaySkeleton() {
        const tbody = document.getElementById('expenses-table-body');
        tbody.innerHTML = ''; // Clear existing content
        for (let i = 0; i < 10; i++) {
            tbody.innerHTML += `
                <tr class="animate-pulse skeleton-row">
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="h-8 w-full bg-gray-200 rounded"></div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="h-6 w-24 bg-gray-200 rounded-full"></div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="h-6 w-20 bg-gray-200 rounded"></div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="h-6 w-20 bg-gray-200 rounded"></div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="h-6 w-24 bg-gray-200 rounded"></div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="h-6 w-20 bg-gray-200 rounded-full"></div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="h-6 w-24 bg-gray-200 rounded"></div>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                            <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                            <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                            <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                        </div>
                    </td>
                </tr>
            `;
        }
    }

    function appendSkeleton(count = 3) {
        const tbody = document.getElementById('expenses-table-body');
        let skeletonHtml = '';
        for (let i = 0; i < count; i++) {
            skeletonHtml += `
            <tr class="animate-pulse skeleton-row">
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="h-8 w-full bg-gray-200 rounded"></div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="h-6 w-24 bg-gray-200 rounded-full"></div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="h-6 w-20 bg-gray-200 rounded"></div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="h-6 w-20 bg-gray-200 rounded"></div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="h-6 w-24 bg-gray-200 rounded"></div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="h-6 w-20 bg-gray-200 rounded-full"></div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="h-6 w-24 bg-gray-200 rounded"></div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="flex items-center space-x-2">
                        <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                        <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                        <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                        <div class="h-6 w-6 bg-gray-200 rounded-full"></div>
                    </div>
                </td>
            </tr>
            `;
        }
        tbody.innerHTML += skeletonHtml;
    }

    function hideLoadingIndicator() {
        const tbody = document.getElementById('expenses-table-body');
        const skeletonRows = tbody.querySelectorAll('.skeleton-row');
        skeletonRows.forEach(row => row.remove());
    }

    // Function to append expenses for infinite scroll
    function appendExpenses(expenses) {
        const tableBody = document.querySelector('#expenses-table-body');
        if (!tableBody || expenses.length === 0) return;

        // Remove any existing "no expenses" message
        const noExpensesRow = tableBody.querySelector('tr td[colspan="8"]');
        if (noExpensesRow) {
            noExpensesRow.closest('tr').remove();
        }

        tableBody.insertAdjacentHTML('beforeend', generateExpenseRows(expenses));
    }

    // Status update functions
    function showAutoLoadingExpensesState() {
        const remainingExpenses = totalExpenses - loadedExpensesCount;
        const rowsToShow = Math.max(0, remainingExpenses);
        if (rowsToShow > 0) {
            appendSkeleton(Math.min(rowsToShow, 3));
        }
    }

    function hideAutoLoadingExpensesState() {
        // Hide the old indicator if it exists
        const indicator = document.getElementById('auto-loading-expenses-indicator');
        if (indicator && !indicator.classList.contains('hidden')) {
            indicator.classList.add('hidden');
        }
    }

    function updateExpensesScrollStatus() {
        const showingCountEl = document.getElementById('showing-expenses-count');
        const totalCountEl = document.getElementById('total-expenses-count');
        const endOfResults = document.getElementById('end-of-expenses');

        // Update counts
        showingCountEl.textContent = loadedExpensesCount;
        totalCountEl.textContent = totalExpenses;

        // Show/hide end message with animation
        if (hasMoreExpenses) {
            endOfResults.classList.add('hidden');
        } else {
            endOfResults.classList.remove('hidden');
            // Add smooth fade-in animation
            setTimeout(() => {
                endOfResults.style.opacity = '0';
                endOfResults.style.transform = 'translateY(20px)';
                endOfResults.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                setTimeout(() => {
                    endOfResults.style.opacity = '1';
                    endOfResults.style.transform = 'translateY(0)';
                }, 10);
            }, 10);
        }
    }

    // Load expenses with filtering
    function loadExpenses(page = 1, append = false, search = '', category = '', status = '', dateFrom = '', dateTo = '') {
        if (isLoading) return;
        isLoading = true;

        if (append) {
            showAutoLoadingExpensesState();
        } else {
            displaySkeleton();
        }

        // If not appending, get current filter values
        if (!append) {
            search = search || document.getElementById('search-expenses').value.trim();
            category = category || document.getElementById('category-filter').value;
            status = status || document.getElementById('status-filter').value;
            dateFrom = dateFrom || document.getElementById('date-from').value;
            dateTo = dateTo || document.getElementById('date-to').value;
        }

        const params = new URLSearchParams({
            page: page,
            size: 10
        });

        if (search) params.append('search', search);
        if (category) params.append('category', category);
        if (status) params.append('status', status);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);

        fetch(`/api/expenses/?${params}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to load expenses');
        })
        .then(data => {
            console.log('Received data from API:', data);
            hideLoadingIndicator(); // Hide skeleton before adding new content

            totalExpenses = data.total || 0;
            const expenses = data.expenses || [];
            hasMoreExpenses = data.has_next || false;
            currentPage = data.page;

            if (append) {
                appendExpenses(expenses);
                loadedExpensesCount += expenses.length;
            } else {
                displayExpenses(expenses);
                loadedExpensesCount = expenses.length;
            }

            updateExpensesScrollStatus();
            updateExpenseStats(data.stats || {});

            if (!append && !search && !category && !status && !dateFrom && !dateTo) {
                // Only show initial toast if no filters are active
                if (totalExpenses === 0) {
                    showToast('No expenses found. Add your first expense!', 'info');
                } else {
                    showToast(`Showing ${expenses.length} of ${totalExpenses} expenses`, 'success');
                }
            }
        })
        .catch(error => {
            console.error('Error in loadExpenses:', error);
            showToast('Failed to load expenses. Please check your connection.', 'error');
            hideLoadingIndicator(); // Also hide on error
            if (!append) {
                displayExpenses([]);
            }
        })
        .finally(() => {
            isLoading = false;
            hideAutoLoadingExpensesState();
        });
    }

    // Infinite scroll functionality
    function setupInfiniteScroll() {
        const sentinel = document.createElement('div');
        sentinel.id = 'scroll-sentinel';
        sentinel.style.height = '1px';
        const endMessage = document.querySelector('#end-of-expenses');
        if (endMessage && endMessage.parentNode) {
            endMessage.parentNode.insertBefore(sentinel, endMessage);
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !isLoading && hasMoreExpenses) {
                    const searchTerm = document.getElementById('search-expenses').value;
                    const categoryFilter = document.getElementById('category-filter').value;
                    const statusFilter = document.getElementById('status-filter').value;
                    const dateFrom = document.getElementById('date-from').value;
                    const dateTo = document.getElementById('date-to').value;
                    loadExpenses(currentPage + 1, true, searchTerm, categoryFilter, statusFilter, dateFrom, dateTo);
                }
            });
        }, {
            root: null,
            rootMargin: '100px',
            threshold: 0
        });

        observer.observe(sentinel);
    }

    function displayExpenses(expenses) {
        const tableBody = document.querySelector('#expenses-table-body');
        if (!tableBody) return;

        if (expenses.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                            <p class="text-lg font-medium">No expenses found</p>
                            <p class="text-sm">Add your first expense to get started</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.insertAdjacentHTML('beforeend', generateExpenseRows(expenses));
    }

    function generateExpenseRows(expenses) {
        return expenses.map(expense => `
            <tr class="hover:bg-gray-50 transition-colors duration-200 ${expense.status === 'pending' ? 'bg-yellow-50 border-l-4 border-yellow-400' : expense.status === 'overdue' ? 'bg-red-50 border-l-4 border-red-400' : ''}">
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-r from-red-400 to-pink-500 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-receipt text-white text-xs"></i>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${escapeHtml(expense.description)}</div>
                            <div class="text-xs text-gray-500">${escapeHtml(expense.vendor || 'No vendor')}</div>
                        </div>
                    </div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        ${getCategoryIcon(expense.category)} ${escapeHtml(expense.category)}
                    </span>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="text-sm font-bold text-gray-900">UGX ${(expense.amount || 0).toLocaleString()}</div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <div class="text-sm font-bold text-green-600">UGX ${(expense.status === 'paid' ? expense.amount : (expense.amount_paid || 0)).toLocaleString()}</div>
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                    ${expense.expense_date ? new Date(expense.expense_date).toLocaleDateString() : 'N/A'}
                </td>
                <td class="px-3 py-3 whitespace-nowrap">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(expense.status)}">
                        <i class="fas fa-circle text-xs mr-1"></i>
                        ${expense.status.replace('_', ' ')}
                    </span>
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                    ${escapeHtml(expense.payment_method || 'N/A')}
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
                    <div class="flex items-center space-x-2">
                        <button onclick="viewExpense('${expense.id}')" class="text-blue-600 hover:text-blue-900 transition-colors duration-200" title="View Details">
                            <i class="fas fa-eye text-xs"></i>
                        </button>
                        ${expense.status !== 'paid' ? `
                        <button onclick="openPaymentModal('${expense.id}', '${escapeJs(expense.description)}', ${expense.amount - (expense.amount_paid || 0)})" class="text-green-600 hover:text-green-900 transition-colors duration-200" title="Pay Expense">
                            <i class="fas fa-credit-card text-xs"></i>
                        </button>
                        ` : ''}
                        <button onclick="editExpense('${expense.id}')" class="text-indigo-600 hover:text-indigo-900 transition-colors duration-200" title="Edit">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button onclick="deleteExpense('${expense.id}')" class="text-red-600 hover:text-red-900 transition-colors duration-200" title="Delete">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }



    function loadCategories() {
        fetch('/api/expense-categories/', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            displayCategories(data.categories || []);
        })
        .catch(error => {
            console.error('Error loading categories:', error);
            showToast('Failed to load categories', 'error');
        });
    }

    function loadCategoriesForDropdown() {
        fetch('/api/expense-categories/', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            const categories = data.categories || [];

            // Update expense form dropdown
            const expenseSelect = document.getElementById('expense-category-select');
            expenseSelect.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                expenseSelect.innerHTML += `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`;
            });

            // Update filter dropdown
            const filterSelect = document.getElementById('category-filter');
            filterSelect.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                filterSelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
            });
        })
        .catch(error => {
            console.error('Error loading categories for dropdown:', error);
        });
    }

    function displayCategories(categories) {
        const container = document.getElementById('categories-list');

        if (categories.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i class="fas fa-tags text-2xl text-gray-300 mb-2"></i>
                    <p class="text-sm">No categories found</p>
                </div>
            `;
            return;
        }

        container.innerHTML = categories.map(category => `
            <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg hover:shadow-sm transition-all duration-200">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                        <span class="text-sm">${category.icon || '📝'}</span>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">${category.name}</div>
                        <div class="text-xs text-gray-500">${category.is_default ? 'Default category' : 'Custom category'}</div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    ${!category.is_default ? `
                        <button onclick="openEditCategoryModal('${category.id}', '${category.name}', '${category.icon}')" class="text-blue-600 hover:text-blue-800 transition-colors duration-200" title="Edit">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        <button onclick="deleteCategory('${category.id}')" class="text-red-600 hover:text-red-800 transition-colors duration-200" title="Delete">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    ` : `
                        <span class="text-xs text-gray-400">Built-in</span>
                    `}
                </div>
            </div>
        `).join('');
    }

    // Global variable to store category icons
    let categoryIconsMap = {};

    function getCategoryIcon(category) {
        // Use dynamically loaded category icons or fallback to static mapping
        if (categoryIconsMap[category]) {
            return categoryIconsMap[category];
        }

        // Static fallback mapping for common categories
        const staticIcons = {
            'Stock Purchase': '🛒',
            'External Labor': '👷',
            'Inventory': '📦',
            'Utilities': '⚡',
            'Rent': '🏠',
            'Supplies': '📋',
            'Marketing': '📢',
            'Transport': '🚚',
            'Other': '📝'
        };

        return staticIcons[category] || '📝'; // Default fallback
    }

    // Function to load category icons from API
    async function loadCategoryIcons() {
        try {
            const response = await fetch('/api/expense-categories/', {
                credentials: 'include'
            });

            if (response.ok) {
                const data = await response.json();
                const categories = data.categories || [];

                // Build the icons map
                categoryIconsMap = {};
                categories.forEach(category => {
                    categoryIconsMap[category.name] = category.icon || '📝';
                });
            }
        } catch (error) {
            console.error('Error loading category icons:', error);
        }
    }

    function getStatusColor(status) {
        switch(status) {
            case 'paid': return 'bg-green-100 text-green-800';
            case 'pending': return 'bg-yellow-100 text-yellow-800';
            case 'partially_paid': return 'bg-blue-100 text-blue-800';
            case 'overdue': return 'bg-red-100 text-red-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function updateExpenseStats(stats) {
        document.getElementById('total-expenses').textContent = `UGX ${(stats.total || 0).toLocaleString()}`;
        document.getElementById('month-expenses').textContent = `UGX ${(stats.month || 0).toLocaleString()}`;
        document.getElementById('pending-expenses').textContent = `UGX ${(stats.pending || 0).toLocaleString()}`;
        document.getElementById('expense-categories').textContent = stats.categories || 0;
    }

    function exportExpenses() {
        showToast('Export functionality coming soon!', 'info');
    }

    function viewExpense(id) {
        // Fetch expense details
        fetch(`/api/expenses/${id}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to fetch expense details');
        })
        .then(expense => {
            // Populate the view modal
            document.getElementById('view-expense-category').textContent = expense.category || 'Uncategorized';
            document.getElementById('view-expense-amount').textContent = `UGX ${(expense.amount || 0).toLocaleString()}`;
            document.getElementById('view-expense-date').textContent = expense.expense_date ? new Date(expense.expense_date).toLocaleDateString() : 'No date';
            document.getElementById('view-expense-description').textContent = expense.description || 'No description';
            document.getElementById('view-expense-category-name').textContent = expense.category || 'Uncategorized';
            document.getElementById('view-expense-vendor').textContent = expense.vendor || 'No vendor';
            document.getElementById('view-expense-payment-method').textContent = expense.payment_method || 'Not specified';
            document.getElementById('view-expense-payment-status').textContent = expense.status === 'not_paid' || expense.status === 'pending' ? 'Pending' : expense.status === 'paid' ? 'Paid' : (expense.status || 'Unknown');

            // System information
            document.getElementById('view-expense-created').textContent = expense.created_at ? new Date(expense.created_at).toLocaleDateString() : 'Unknown';
            document.getElementById('view-expense-updated').textContent = expense.updated_at ? new Date(expense.updated_at).toLocaleDateString() : 'Unknown';
            document.getElementById('view-expense-created-by').textContent = expense.created_by_name || expense.created_by || 'Unknown';
            document.getElementById('view-expense-auto-generated').textContent = expense.is_auto_generated ? 'Yes' : 'No';

            // Status with color coding
            const statusElement = document.getElementById('view-expense-status');
            const status = expense.status || 'unknown';
            let statusClass = 'bg-gray-100 text-gray-800';

            switch(status.toLowerCase()) {
                case 'paid':
                    statusClass = 'bg-green-100 text-green-800';
                    break;
                case 'pending':
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    break;
                case 'overdue':
                    statusClass = 'bg-red-100 text-red-800';
                    break;
                case 'cancelled':
                    statusClass = 'bg-gray-100 text-gray-800';
                    break;
            }

            statusElement.innerHTML = `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                    <i class="fas fa-circle text-xs mr-1"></i>
                    ${status.charAt(0).toUpperCase() + status.slice(1)}
                </span>
            `;

            // Notes
            const notesElement = document.getElementById('view-expense-notes');
            if (expense.notes && expense.notes.trim()) {
                notesElement.textContent = expense.notes;
            } else {
                notesElement.textContent = 'No additional notes available.';
            }

            // Products section (for restock expenses)
            const productsSection = document.getElementById('view-expense-products-section');
            const productsContainer = document.getElementById('view-expense-products');
            
            if (expense.products && expense.products.length > 0) {
                productsSection.classList.remove('hidden');
                productsContainer.innerHTML = expense.products.map(product => `
                    <div class="bg-white border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-blue-500 rounded-md flex items-center justify-center mr-2">
                                    <i class="fas fa-box text-white text-xs"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">${product.name || product.product_name || 'Unknown Product'}</p>
                                    <p class="text-xs text-gray-500">Qty: ${product.quantity} | Cost: UGX ${(product.cost_price || 0).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-blue-600">UGX ${((product.quantity || 0) * (product.cost_price || 0)).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                productsSection.classList.add('hidden');
            }

            // Store expense ID for edit button
            document.getElementById('view-expense-modal').setAttribute('data-expense-id', id);

            // Show the modal
            document.getElementById('view-expense-modal').classList.remove('hidden');
            loadExpensePayments(id);
        })
        .catch(error => {
            console.error('Error fetching expense:', error);
            showToast('Failed to load expense details', 'error');
        });
    }

    function loadExpensePayments(expenseId) {
        const paymentsList = document.getElementById('view-expense-payments-list');
        
        // 1. Show skeleton loader
        let skeletonHTML = '';
        for (let i = 0; i < 2; i++) {
            skeletonHTML += `
            <div class="bg-gray-50 rounded-lg p-3 animate-pulse">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="h-4 bg-gray-200 rounded w-24 mb-2"></div>
                        <div class="h-3 bg-gray-200 rounded w-32"></div>
                    </div>
                    <div class="h-5 bg-gray-200 rounded w-20"></div>
                </div>
            </div>
            `;
        }
        paymentsList.innerHTML = skeletonHTML;

        // 2. Fetch payments
        fetch(`/api/expenses/${expenseId}/payments`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to load payments');
                return response.json();
            })
            .then(payments => {
                // 3. Display payments or 'no payments' message
                if (payments && payments.length > 0) {
                    paymentsList.innerHTML = payments.map(payment => {
                        const paymentDate = new Date(payment.payment_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        const paymentAmount = (payment.amount || 0).toLocaleString();
                        return `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 transition-all duration-300 hover:bg-green-100">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm font-medium text-green-800 capitalize">${(payment.payment_method || 'Payment').replace('_', ' ')}</p>
                                    <p class="text-xs text-gray-500">${paymentDate}</p>
                                </div>
                                <p class="text-sm font-bold text-green-900">UGX ${paymentAmount}</p>
                            </div>
                            ${payment.notes ? `<p class="text-xs text-gray-600 mt-2 pt-2 border-t border-green-200">${payment.notes}</p>` : ''}
                        </div>
                        `;
                    }).join('');
                } else {
                    paymentsList.innerHTML = `
                    <div class="text-center py-4 px-3 bg-gray-50 border rounded-lg">
                        <p class="text-sm text-gray-500">No payment history recorded for this expense.</p>
                    </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching payments:', error);
                paymentsList.innerHTML = `
                <div class="text-center py-4 px-3 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-600">Could not load payment history.</p>
                </div>
                `;
            });
    }

    function closeViewExpenseModal() {
        document.getElementById('view-expense-modal').classList.add('hidden');
    }

    function editExpenseFromView() {
        const expenseId = document.getElementById('view-expense-modal').getAttribute('data-expense-id');
        closeViewExpenseModal();
        editExpense(expenseId);
    }

    function closeEditExpenseModal() {
        document.getElementById('edit-expense-modal').classList.add('hidden');
        document.getElementById('edit-expense-form').reset();
    }

    async function editExpense(id) {
        try {
            const response = await fetch(`/api/expenses/${id}`);
            if (!response.ok) {
                throw new Error('Failed to fetch expense details');
            }
            const expense = await response.json();

            // Populate the modal
            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-description').value = expense.description;
            document.getElementById('edit-amount').value = expense.amount;
            document.getElementById('edit-expense_date').value = expense.expense_date ? new Date(expense.expense_date).toISOString().split('T')[0] : '';
            document.getElementById('edit-payment_method').value = expense.payment_method;
            document.getElementById('edit-vendor').value = expense.vendor;
            document.getElementById('edit-notes').value = expense.notes;
            document.getElementById('edit-is_paid').checked = expense.status === 'paid';

            // Load categories and select the correct one
            const categorySelect = document.getElementById('edit-expense-category-select');
            await loadCategoriesForEditDropdown(categorySelect, expense.category);

            // Show the modal
            document.getElementById('edit-expense-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error fetching expense for editing:', error);
            showToast('Failed to load expense details for editing.', 'error');
        }
    }

    async function loadCategoriesForEditDropdown(selectElement, selectedCategory) {
        try {
            const response = await fetch('/api/expense-categories/');
            if (!response.ok) {
                throw new Error('Failed to load categories');
            }
            const data = await response.json();
            const categories = data.categories || [];
            
            selectElement.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                const selected = cat.name === selectedCategory ? 'selected' : '';
                selectElement.innerHTML += `<option value="${cat.name}" ${selected}>${cat.icon} ${cat.name}</option>`;
            });
        } catch (error) {
            console.error('Error loading categories for dropdown:', error);
        }
    }

    function deleteExpense(id) {
        if (confirm('Are you sure you want to delete this expense?')) {
            showToast('Delete expense functionality coming soon!', 'info');
        }
    }

    // Search and filter functionality
    function applyFilters() {
        currentPage = 1;
        hasMoreExpenses = true;
        loadedExpensesCount = 0;
        document.getElementById('expenses-table-body').innerHTML = '';
        document.getElementById('end-of-expenses').classList.add('hidden');
        loadExpenses(1, false); // Reset pagination and replace results when filtering
    }



    // Handle Edit Expense Form Submission
    document.getElementById('edit-expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('update-expense-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Updating...';
        
        const expenseId = document.getElementById('edit-expense-id').value;
        const formData = new FormData(e.target);
        const expenseData = {
            description: formData.get('description'),
            category: formData.get('category'),
            amount: parseFloat(formData.get('amount')),
            expense_date: formData.get('expense_date'),
            payment_method: formData.get('payment_method'),
            vendor: formData.get('vendor') || null,
            notes: formData.get('notes') || null,
            status: formData.get('is_paid') === 'on' ? 'paid' : 'pending'
        };
        
        try {
            const response = await fetch(`/api/expenses/${expenseId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(expenseData)
            });
            
            if (response.ok) {
                const result = await response.json();
                showToast('Expense updated successfully!', 'success');
                closeEditExpenseModal();
                applyFilters(); // Reload expenses
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to update expense', 'error');
            }
        } catch (error) {
            console.error('Error updating expense:', error);
            showToast('Failed to update expense', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    // Handle Add Expense Form Submission
    document.getElementById('add-expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('add-expense-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
        
        const formData = new FormData(e.target);
        const expenseData = {
            description: formData.get('description'),
            category: formData.get('category'),
            amount: parseFloat(formData.get('amount')),
            expense_date: formData.get('expense_date'),
            payment_method: formData.get('payment_method'),
            vendor: formData.get('vendor') || null,
            notes: formData.get('notes') || null,
            status: formData.get('is_paid') === 'on' ? 'paid' : 'pending'
        };
        
        try {
            const response = await fetch('/api/expenses/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(expenseData)
            });
            
            if (response.ok) {
                const result = await response.json();
                showToast('Expense added successfully!', 'success');
                closeAddExpenseModal();
                applyFilters(); // Reload expenses with filters
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to add expense', 'error');
            }
        } catch (error) {
            console.error('Error adding expense:', error);
            showToast('Failed to add expense', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    async function deleteCategory(id) {
        if (!confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/expense-categories/${id}`, {
                method: 'DELETE',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                showToast('Category deleted successfully!', 'success');
                loadCategories();
                loadCategoriesForDropdown();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to delete category', 'error');
            }
        } catch (error) {
            console.error('Error deleting category:', error);
            showToast('Failed to delete category', 'error');
        }
    }

    // Handle Add Category Form
    document.getElementById('add-category-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('category-name').value.trim();
        const icon = document.getElementById('category-icon').value.trim();

        if (!name) {
            showToast('Category name is required', 'error');
            return;
        }

        try {
            const response = await fetch('/api/expense-categories/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    name: name,
                    icon: icon || '📝'
                })
            });

            if (response.ok) {
                showToast('Category added successfully!', 'success');
                document.getElementById('add-category-form').reset();
                loadCategories();
                loadCategoriesForDropdown();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to add category', 'error');
            }
        } catch (error) {
            console.error('Error adding category:', error);
            showToast('Failed to add category', 'error');
        }
    });

    // Handle Edit Category Form
    document.getElementById('edit-category-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const id = document.getElementById('edit-category-id').value;
        const name = document.getElementById('edit-category-name').value.trim();
        const icon = document.getElementById('edit-category-icon').value.trim();

        if (!name) {
            showToast('Category name is required', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/expense-categories/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({
                    name: name,
                    icon: icon || '📝'
                })
            });

            if (response.ok) {
                showToast('Category updated successfully!', 'success');
                closeEditCategoryModal();
                loadCategories();
                loadCategoriesForDropdown();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to update category', 'error');
            }
        } catch (error) {
            console.error('Error updating category:', error);
            showToast('Failed to update category', 'error');
        }
    });







    // Payment Modal Functions
    let currentPaymentExpense = null;

    async function openPaymentModal(expenseId, expenseDescription, remainingAmount) {
        try {
            // Show modal with skeleton loading
            document.getElementById('payment-modal').classList.remove('hidden');
            document.getElementById('payment-loading-skeleton').classList.remove('hidden');
            document.getElementById('payment-form').classList.add('hidden');

            // Fetch the full expense details from the API
            const response = await fetch(`/api/expenses/${expenseId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch expense details');
            }

            const expense = await response.json();
            const totalAmount = expense.amount || remainingAmount;
            const amountPaid = expense.amount_paid || 0;
            const actualRemaining = totalAmount - amountPaid;

            currentPaymentExpense = {
                id: expenseId,
                description: expenseDescription,
                amount: totalAmount,
                remaining: actualRemaining
            };

            // Update modal content
            document.getElementById('payment-expense-name').textContent = expenseDescription;

            // Show payment breakdown if partially paid
            if (amountPaid > 0) {
                document.getElementById('payment-expense-amount').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between text-gray-600">
                            <span>Total Amount:</span>
                            <span>UGX ${totalAmount.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Already Paid:</span>
                            <span>UGX ${amountPaid.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between font-semibold text-green-700 border-t pt-1">
                            <span>Remaining:</span>
                            <span>UGX ${actualRemaining.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('payment-expense-amount').textContent = `UGX ${actualRemaining.toLocaleString()}`;
            }

            document.getElementById('payment-amount-input').value = actualRemaining;
            document.getElementById('payment-amount-input').max = actualRemaining;
            document.getElementById('payment-method-select').value = '';

            // Hide skeleton and show form with a smooth transition
            setTimeout(() => {
                document.getElementById('payment-loading-skeleton').classList.add('hidden');
                document.getElementById('payment-form').classList.remove('hidden');
            }, 500); // Small delay to show the skeleton animation

        } catch (error) {
            console.error('Error opening payment modal:', error);
            showToast('Failed to load expense details', 'error');
            // Hide modal on error
            document.getElementById('payment-modal').classList.add('hidden');
        }
    }

    function closePaymentModal() {
        document.getElementById('payment-modal').classList.add('hidden');
        currentPaymentExpense = null;
        document.getElementById('payment-form').reset();

        // Reset skeleton state for next time
        document.getElementById('payment-loading-skeleton').classList.remove('hidden');
        document.getElementById('payment-form').classList.add('hidden');
    }

    function processPayment() {
        if (!currentPaymentExpense) return;

        const paymentAmount = parseFloat(document.getElementById('payment-amount-input').value);
        const paymentMethod = document.getElementById('payment-method-select').value;

        if (!paymentAmount || paymentAmount <= 0) {
            showToast('Please enter a valid payment amount', 'error');
            return;
        }

        if (paymentAmount > currentPaymentExpense.amount) {
            showToast('Payment amount cannot exceed expense amount', 'error');
            return;
        }

        if (!paymentMethod) {
            showToast('Please select a payment method', 'error');
            return;
        }

        const payButton = document.getElementById('pay-now-button');
        const originalText = payButton.innerHTML;
        payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        payButton.disabled = true;

        // Record payment using the new payment endpoint
        const paymentData = {
            amount: paymentAmount,
            payment_method: paymentMethod,
            notes: `Payment made from expenses page`
        };

        fetch(`/api/expenses/${currentPaymentExpense.id}/payment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(paymentData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to process payment');
            }
            return response.json();
        })
        .then(data => {
            showToast('Payment processed successfully', 'success');
            closePaymentModal();
            applyFilters(); // Reload expenses
        })
        .catch(error => {
            console.error('Error processing payment:', error);
            showToast('Failed to process payment', 'error');
        })
        .finally(() => {
            payButton.innerHTML = originalText;
            payButton.disabled = false;
        });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - initializing expenses page');

        // Load category icons for display
        loadCategoryIcons();

        // Load initial data
        applyFilters();
        loadCategoriesForDropdown();

        // Setup infinite scroll
        setupInfiniteScroll();

        // Add debounced search input
        let searchTimeout;
        const searchInput = document.getElementById('search-expenses');
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters(); // Reset pagination and replace results when searching
            }, 500); // Wait 500ms after user stops typing
        });

        // Remove the old event listeners and replace with the debounced search
        document.getElementById('category-filter').addEventListener('change', applyFilters);
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('date-from').addEventListener('change', applyFilters);
        document.getElementById('date-to').addEventListener('change', applyFilters);
    });

    // Global supplier selection function (needs to be accessible from onclick)
    function openSupplierSelectionModal() {
        console.log('Opening supplier selection modal...');
        const supplierSelectionModal = document.getElementById('supplier-selection-modal');
        const supplierSearchInput = document.getElementById('supplier-search');

        if (supplierSelectionModal) {
            supplierSelectionModal.classList.remove('hidden');
            // Load suppliers when modal opens
            loadSuppliersInModal();
            if (supplierSearchInput) {
                supplierSearchInput.focus();
            }
        } else {
            console.error('Supplier selection modal not found!');
        }
    }

    // Global function to load suppliers in modal
    async function loadSuppliersInModal() {
        const supplierList = document.getElementById('supplier-list');
        if (!supplierList) return;

        supplierList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500"></i><span class="ml-2 text-gray-600">Loading suppliers...</span></div>';

        try {
            const response = await fetch('/api/suppliers/?size=50');
            const data = await response.json();
            displaySuppliersInModal(data.suppliers || []);
        } catch (error) {
            console.error('Error loading suppliers:', error);
            supplierList.innerHTML = '<p class="text-red-500 text-xs p-2">Error loading suppliers</p>';
        }
    }

    // Global function to display suppliers in modal
    function displaySuppliersInModal(suppliers) {
        const supplierList = document.getElementById('supplier-list');
        if (!supplierList) return;

        if (!suppliers || suppliers.length === 0) {
            supplierList.innerHTML = `
                <div class="text-center py-4 px-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl">
                    <div class="w-8 h-8 bg-gray-300 rounded-lg flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-truck text-gray-500 text-sm"></i>
                    </div>
                    <p class="text-gray-600 text-xs font-medium mb-1">No suppliers found</p>
                    <p class="text-gray-500 text-xs">Try a different search term or add a new supplier</p>
                </div>
            `;
            return;
        }

        supplierList.innerHTML = suppliers.map(supplier => `
            <div class="bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg p-3 cursor-pointer transition-all duration-200" onclick="selectSupplierFromModal('${supplier.id}', '${supplier.name.replace(/'/g, "\\'")}')">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded-md flex items-center justify-center mr-2">
                            <i class="fas fa-building text-white text-xs"></i>
                        </div>
                        <div>
                            <div class="text-xs font-semibold text-gray-900">${supplier.name}</div>
                            ${supplier.contact_person ? `<div class="text-xs text-gray-600">${supplier.contact_person}</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        ${supplier.phone ? `<div class="text-xs text-gray-500">${supplier.phone}</div>` : ''}
                        <div class="text-xs ${supplier.is_active ? 'text-green-600' : 'text-red-500'}">${supplier.is_active ? 'Active' : 'Inactive'}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Global function to select supplier from modal
    function selectSupplierFromModal(supplierId, supplierName) {
        // Update the expense form if it exists
        const expenseVendorInput = document.getElementById('expense-vendor');
        const selectedExpenseSupplierText = document.getElementById('selected-expense-supplier-text');

        if (expenseVendorInput && selectedExpenseSupplierText) {
            expenseVendorInput.value = supplierName;
            selectedExpenseSupplierText.textContent = supplierName;
            selectedExpenseSupplierText.classList.remove('text-gray-500');
            selectedExpenseSupplierText.classList.add('text-gray-900', 'font-medium');
        }

        console.log('Selected supplier:', supplierId, supplierName);
        showToast(`Selected supplier: ${supplierName}`, 'success');

        closeSupplierSelectionModal();
    }

    // Global function to close supplier selection modal
    function closeSupplierSelectionModal() {
        const supplierSelectionModal = document.getElementById('supplier-selection-modal');
        const supplierSearchInput = document.getElementById('supplier-search');
        const supplierList = document.getElementById('supplier-list');

        if (supplierSelectionModal) {
            supplierSelectionModal.classList.add('hidden');
        }
        if (supplierSearchInput) {
            supplierSearchInput.value = '';
        }
        if (supplierList) {
            supplierList.innerHTML = '';
        }
    }

    // Global function to clear selected supplier
    function clearSelectedSupplier() {
        // Clear the expense form if it exists
        const expenseVendorInput = document.getElementById('expense-vendor');
        const selectedExpenseSupplierText = document.getElementById('selected-expense-supplier-text');

        if (expenseVendorInput && selectedExpenseSupplierText) {
            expenseVendorInput.value = '';
            selectedExpenseSupplierText.textContent = 'Click to select supplier';
            selectedExpenseSupplierText.classList.remove('text-gray-900', 'font-medium');
            selectedExpenseSupplierText.classList.add('text-gray-500');
        }

        showToast('Supplier selection cleared', 'info');
        closeSupplierSelectionModal();
    }

    // Global function to add new supplier
    function addNewSupplier(name) {
        const supplierNameInput = document.getElementById('supplier-name');
        if (supplierNameInput) {
            supplierNameInput.value = name.trim();
        }
        openSupplierModal();
    }

    // Global function to open supplier modal
    function openSupplierModal() {
        const supplierModal = document.getElementById('add-supplier-modal');
        const supplierNameInput = document.getElementById('supplier-name');

        if (supplierModal) {
            supplierModal.classList.remove('hidden');
            if (supplierNameInput) {
                supplierNameInput.focus();
            }
        }
    }

    // Global function to close supplier modal
    function closeSupplierModal() {
        const supplierModal = document.getElementById('add-supplier-modal');
        const supplierForm = document.getElementById('add-supplier-form');

        if (supplierModal) {
            supplierModal.classList.add('hidden');
        }
        if (supplierForm) {
            supplierForm.reset();
        }
    }

    // Global function to handle supplier form submission
    async function handleSupplierFormSubmit(event) {
        event.preventDefault();

        const saveBtn = document.getElementById('save-supplier-btn');
        if (!saveBtn) return;

        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Saving...';

        const supplierData = {
            name: document.getElementById('supplier-name')?.value.trim() || '',
            contact_person: document.getElementById('supplier-contact')?.value.trim() || '',
            phone: document.getElementById('supplier-phone')?.value.trim() || '',
            email: document.getElementById('supplier-email')?.value.trim() || null,
            address: document.getElementById('supplier-address')?.value.trim() || null,
            notes: document.getElementById('supplier-notes')?.value.trim() || null,
            is_active: document.getElementById('supplier-is-active')?.checked || true
        };

        try {
            const response = await fetch('/api/suppliers/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(supplierData)
            });

            if (response.ok) {
                const newSupplier = await response.json();
                closeSupplierModal();
                showToast(`Supplier "${newSupplier.name}" added successfully!`, 'success');

                // Automatically select the newly created supplier
                selectSupplierFromModal(newSupplier.id, newSupplier.name);
            } else {
                const error = await response.json();
                showToast(`Error adding supplier: ${error.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error adding supplier:', error);
            showToast('Error adding supplier', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    // Global function to search suppliers in modal
    async function searchSuppliersInModal() {
        const supplierSearchInput = document.getElementById('supplier-search');
        const supplierList = document.getElementById('supplier-list');

        if (!supplierSearchInput || !supplierList) return;

        const query = supplierSearchInput.value.trim();
        if (query.length < 2) {
            loadSuppliersInModal();
            return;
        }

        supplierList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500"></i><span class="ml-2 text-gray-600">Searching...</span></div>';

        try {
            const response = await fetch(`/api/suppliers/?search=${encodeURIComponent(query)}&size=50`);
            const data = await response.json();
            displaySuppliersInModal(data.suppliers || []);
        } catch (error) {
            console.error('Error searching suppliers:', error);
            supplierList.innerHTML = '<p class="text-red-500 text-xs p-2">Error searching suppliers</p>';
        }
    }

    // Debounce function for search inputs
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Add event listeners when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Add New Supplier button
        const addNewSupplierBtn = document.getElementById('add-new-supplier-btn');
        if (addNewSupplierBtn) {
            addNewSupplierBtn.addEventListener('click', () => {
                closeSupplierSelectionModal();
                addNewSupplier('');
            });
        }

        // Clear Supplier button
        const clearSupplierBtn = document.getElementById('clear-supplier-btn');
        if (clearSupplierBtn) {
            clearSupplierBtn.addEventListener('click', clearSelectedSupplier);
        }

        // Close supplier selection modal button
        const closeSupplierSelectionBtn = document.getElementById('close-supplier-selection-modal');
        if (closeSupplierSelectionBtn) {
            closeSupplierSelectionBtn.addEventListener('click', closeSupplierSelectionModal);
        }

        // Supplier search input
        const supplierSearchInput = document.getElementById('supplier-search');
        if (supplierSearchInput) {
            supplierSearchInput.addEventListener('input', debounce(searchSuppliersInModal, 300));
        }

        // Add New Supplier Modal event listeners
        const closeModalBtn = document.getElementById('close-supplier-modal');
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeSupplierModal);
        }

        const cancelModalBtn = document.getElementById('cancel-supplier-btn');
        if (cancelModalBtn) {
            cancelModalBtn.addEventListener('click', closeSupplierModal);
        }

        const supplierForm = document.getElementById('add-supplier-form');
        if (supplierForm) {
            supplierForm.addEventListener('submit', handleSupplierFormSubmit);
        }

        // Close modals when clicking outside
        const supplierSelectionModal = document.getElementById('supplier-selection-modal');
        if (supplierSelectionModal) {
            supplierSelectionModal.addEventListener('click', function(event) {
                if (event.target === supplierSelectionModal) {
                    closeSupplierSelectionModal();
                }
            });
        }

        const supplierModal = document.getElementById('add-supplier-modal');
        if (supplierModal) {
            supplierModal.addEventListener('click', function(event) {
                if (event.target === supplierModal) {
                    closeSupplierModal();
                }
            });
        }
    });
</script>

<!-- Supplier Selection Modal -->
<div id="supplier-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-truck text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Select Supplier</h3>
                    </div>
                    <button id="close-supplier-selection-modal" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <div class="relative mb-4">
                    <input type="text" id="supplier-search" placeholder="Search suppliers..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <i class="fas fa-search text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i>
                </div>
                <div id="supplier-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Suppliers will be loaded here -->
                </div>
                <div class="flex justify-between items-center pt-3 border-t border-gray-200 mt-4">
                    <button type="button" id="add-new-supplier-btn" class="text-xs font-medium text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-plus mr-1"></i>Add New Supplier
                    </button>
                    <button type="button" id="clear-supplier-btn" class="text-xs font-medium text-gray-600 hover:text-gray-800">
                        Clear Selection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add New Supplier Modal -->
<div id="add-supplier-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-plus text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Add New Supplier</h3>
                    </div>
                    <button id="close-supplier-modal" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <form id="add-supplier-form" class="p-4 space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-building text-gray-400 mr-1"></i>Company Name
                    </label>
                    <input type="text" id="supplier-name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Enter company name">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-user text-gray-400 mr-1"></i>Contact Person
                        </label>
                        <input type="text" id="supplier-contact" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Contact person name">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-phone text-gray-400 mr-1"></i>Phone Number
                        </label>
                        <input type="tel" id="supplier-phone" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Phone number">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-envelope text-gray-400 mr-1"></i>Email Address
                    </label>
                    <input type="email" id="supplier-email" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Email address">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>Address
                    </label>
                    <textarea id="supplier-address" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Full address"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-sticky-note text-gray-400 mr-1"></i>Notes
                    </label>
                    <textarea id="supplier-notes" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Additional notes"></textarea>
                </div>

                <div class="flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <input type="checkbox" id="supplier-is-active" checked class="h-3 w-3 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                    <label class="ml-2 block text-xs font-medium text-orange-900">
                        <i class="fas fa-check-circle text-orange-600 mr-1"></i>Active Supplier
                    </label>
                    <span class="ml-2 text-xs text-orange-600">Supplier is available for orders</span>
                </div>

                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" id="cancel-supplier-btn" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="save-supplier-btn" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-plus mr-1"></i>Add Supplier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-credit-card text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Pay Expense</h3>
                    </div>
                    <button type="button" onclick="closePaymentModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- Loading Skeleton -->
            <div id="payment-loading-skeleton" class="p-4 space-y-4 payment-modal-transition">
                <!-- Expense Info Skeleton -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="h-3 skeleton-shimmer rounded w-16 mb-2"></div>
                    <div class="h-4 skeleton-shimmer rounded w-3/4"></div>
                </div>

                <!-- Expense Amount Skeleton -->
                <div class="bg-red-50 rounded-lg p-3 border border-red-200">
                    <div class="h-3 skeleton-shimmer rounded w-24 mb-2"></div>
                    <div class="h-6 skeleton-shimmer rounded w-32"></div>
                </div>

                <!-- Payment Amount Skeleton -->
                <div>
                    <div class="h-3 skeleton-shimmer rounded w-28 mb-2"></div>
                    <div class="h-10 skeleton-shimmer rounded-lg"></div>
                </div>

                <!-- Payment Method Skeleton -->
                <div>
                    <div class="h-3 skeleton-shimmer rounded w-32 mb-2"></div>
                    <div class="h-10 skeleton-shimmer rounded-lg"></div>
                </div>

                <!-- Buttons Skeleton -->
                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <div class="h-8 skeleton-shimmer rounded-lg w-16"></div>
                    <div class="h-8 skeleton-shimmer rounded-lg w-20"></div>
                </div>
            </div>

            <!-- Actual Form (hidden during loading) -->
            <form id="payment-form" class="p-4 space-y-4 hidden payment-modal-transition">
                <!-- Expense Info -->
                <div class="bg-gray-50 rounded-lg p-3">
                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Expense</div>
                    <div class="text-sm font-bold text-gray-900" id="payment-expense-name">Loading...</div>
                </div>

                <!-- Expense Amount -->
                <div class="bg-red-50 rounded-lg p-3 border border-red-200">
                    <div class="text-xs font-medium text-red-600 uppercase tracking-wide mb-1">Expense Amount</div>
                    <div class="text-lg font-bold text-red-800" id="payment-expense-amount">UGX 0</div>
                </div>

                <!-- Payment Amount -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-2">
                        <i class="fas fa-money-bill text-gray-400 mr-1"></i>Payment Amount
                    </label>
                    <input type="number" id="payment-amount-input"
                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200"
                           placeholder="Enter payment amount" min="1" step="1" required>
                </div>

                <!-- Payment Method -->
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-2">
                        <i class="fas fa-credit-card text-gray-400 mr-1"></i>Payment Method
                    </label>
                    <select id="payment-method-select" required
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                        <option value="">Select payment method</option>
                        <option value="mobile_money">📱 Mobile Money</option>
                        <option value="cash">💵 Cash</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" onclick="closePaymentModal()"
                            class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="button" id="pay-now-button" onclick="processPayment()"
                            class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-check mr-1"></i>Pay Now
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>


{% endblock %}