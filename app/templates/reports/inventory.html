{% extends "base.html" %}

{% block title %}Inventory Reports - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-500 to-teal-600 shadow-lg rounded-xl p-6 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl md:text-3xl font-bold">📦 Inventory Reports</h1>
                <p class="text-green-100 text-sm mt-1">Stock levels, movement, and inventory analytics</p>
            </div>
            <div class="flex space-x-2">
                <a href="/reports" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-white text-sm font-medium transition-all duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Reports
                </a>
                <button onclick="testChart()" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-white text-sm font-medium transition-all duration-200">
                    <i class="fas fa-chart-bar mr-2"></i>Test Chart
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Products</p>
                    <p class="text-2xl font-bold text-blue-600" id="totalProducts">0</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-boxes text-blue-600 text-lg"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Low Stock Items</p>
                    <p class="text-2xl font-bold text-red-600" id="lowStockItems">0</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Out of Stock</p>
                    <p class="text-2xl font-bold text-orange-600" id="outOfStock">0</p>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-times-circle text-orange-600 text-lg"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Value</p>
                    <p class="text-2xl font-bold text-green-600" id="totalValue">UGX 0</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-dollar-sign text-green-600 text-lg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Categories -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Stock Levels Report -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Stock Levels</h3>
                <i class="fas fa-layer-group text-blue-600 text-xl"></i>
            </div>
            <p class="text-sm text-gray-600 mb-4">Current stock quantities and inventory status</p>
            <button onclick="generateStockReport()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200">
                Generate Report
            </button>
        </div>

        <!-- Movement Report -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Stock Movement</h3>
                <i class="fas fa-exchange-alt text-green-600 text-xl"></i>
            </div>
            <p class="text-sm text-gray-600 mb-4">Inventory in/out movements and transactions</p>
            <button onclick="generateMovementReport()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors duration-200">
                Generate Report
            </button>
        </div>

        <!-- Valuation Report -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Inventory Valuation</h3>
                <i class="fas fa-calculator text-purple-600 text-xl"></i>
            </div>
            <p class="text-sm text-gray-600 mb-4">Total inventory value and cost analysis</p>
            <button onclick="generateValuationReport()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors duration-200">
                Generate Report
            </button>
        </div>
    </div>

    <!-- Stock Movement Report -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6 hidden" id="movementReportSection">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Stock Movement Report</h3>
            <button onclick="closeMovementReport()" class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                <i class="fas fa-times mr-2"></i>Close
            </button>
        </div>
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-alt mr-1 text-gray-400"></i>
                                Date
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-box mr-1 text-gray-400"></i>
                                Product
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-exchange-alt mr-1 text-gray-400"></i>
                                Type
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-sort-numeric-up mr-1 text-gray-400"></i>
                                Quantity
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-1 text-gray-400"></i>
                                User
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="movementTableBody">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                    <i class="fas fa-spinner fa-spin text-gray-400 text-lg"></i>
                                </div>
                                <p class="text-gray-600 font-medium mb-1 text-sm">Loading stock movement data...</p>
                                <p class="text-xs text-gray-500">Please wait...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Low Stock Alert -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6" id="lowStockAlertsSection">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Low Stock Alerts</h3>
            <button onclick="refreshAlerts()" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                <i class="fas fa-sync mr-2"></i>Refresh
            </button>
        </div>
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-box mr-1 text-gray-400"></i>
                                Product
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-sort-numeric-up mr-1 text-gray-400"></i>
                                Current Stock
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-level-down-alt mr-1 text-gray-400"></i>
                                Min Level
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle mr-1 text-gray-400"></i>
                                Status
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-cogs mr-1 text-gray-400"></i>
                                Action
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="lowStockTableBody">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                    <i class="fas fa-spinner fa-spin text-gray-400 text-lg"></i>
                                </div>
                                <p class="text-gray-600 font-medium mb-1 text-sm">Loading low stock alerts...</p>
                                <p class="text-xs text-gray-500">Please wait...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Inventory Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6" id="inventoryByCategorySection">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Inventory by Category</h3>
        <div class="h-72 relative">
            <div id="inventoryChart" class="w-full h-full"></div>
            <div id="inventoryChartPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-4xl mb-2"></i>
                    <p class="text-gray-500">Loading inventory chart...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Valuation Report Section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6 hidden" id="valuationReportSection">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Detailed Valuation Report</h3>
            <button onclick="closeValuationReport()" class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg text-sm font-medium transition-all duration-200">
                <i class="fas fa-times mr-2"></i>Close
            </button>
        </div>
        
        <!-- Valuation Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="valuationSummaryCards">
            <!-- Summary cards will be populated by JavaScript -->
        </div>
        
        <!-- Category Valuation Table -->
        <div class="mb-6">
            <h4 class="text-md font-semibold text-gray-900 mb-3 flex items-center">
                <i class="fas fa-folder mr-2 text-blue-500"></i>Valuation by Category
            </h4>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-folder mr-1 text-gray-400"></i>
                                    Category
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-box mr-1 text-gray-400"></i>
                                    Products
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-tag mr-1 text-gray-400"></i>
                                    Retail Value
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-dollar-sign mr-1 text-gray-400"></i>
                                    Cost Value
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-chart-line mr-1 text-gray-400"></i>
                                    Profit Value
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="categoryValuationTableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Product Valuation Table -->
        <div>
            <h4 class="text-md font-semibold text-gray-900 mb-3 flex items-center">
                <i class="fas fa-box mr-2 text-green-500"></i>Product Valuation Details
            </h4>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-box mr-1 text-gray-400"></i>
                                    Product
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-folder mr-1 text-gray-400"></i>
                                    Category
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-sort-numeric-up mr-1 text-gray-400"></i>
                                    Stock
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-tag mr-1 text-gray-400"></i>
                                    Retail Price
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-tags mr-1 text-gray-400"></i>
                                    Retail Value
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-dollar-sign mr-1 text-gray-400"></i>
                                    Cost Value
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <div class="flex items-center">
                                    <i class="fas fa-chart-line mr-1 text-gray-400"></i>
                                    Profit Value
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="productValuationTableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
// Global variables
let inventoryChart = null;

// Money formatting function
function formatMoney(value, showFull = false) {
    if (value === 0) return 'UGX 0';

    const absValue = Math.abs(value);
    const isNegative = value < 0;
    const prefix = isNegative ? '-UGX ' : 'UGX ';

    if (showFull) {
        return prefix + absValue.toLocaleString();
    }

    if (absValue >= 1000000000) {
        return prefix + (absValue / 1000000000).toFixed(1) + 'B';
    } else if (absValue >= 1000000) {
        return prefix + (absValue / 1000000).toFixed(1) + 'M';
    } else if (absValue >= 1000) {
        return prefix + (absValue / 1000).toFixed(1) + 'K';
    } else {
        return prefix + absValue.toLocaleString();
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium transition-all duration-300 transform translate-x-full`;

    // Set color based on type
    switch(type) {
        case 'success':
            toast.className += ' bg-green-600';
            break;
        case 'error':
            toast.className += ' bg-red-600';
            break;
        case 'warning':
            toast.className += ' bg-yellow-600';
            break;
        default:
            toast.className += ' bg-blue-600';
    }

    toast.textContent = message;
    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Load inventory data
async function loadInventoryData() {
    try {
        console.log('📦 Loading inventory data...');

        // Check if ApexCharts is available
        if (typeof ApexCharts === 'undefined') {
            console.error('❌ ApexCharts not available');
            showToast('Chart library not loaded. Please refresh the page.', 'error');
        } else {
            console.log('✅ ApexCharts is available');
        }

        const response = await fetch('/api/reports/inventory-reports', {
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        console.log('📦 Inventory data loaded:', data);
        
        if (!data.success) {
            throw new Error('API returned error: ' + (data.error || 'Unknown error'));
        }
        
        console.log('📊 Category breakdown:', data.data.category_inventory);

        // Update summary cards
        updateSummaryCards(data.data);

        // Update low stock table
        updateLowStockTable(data.data.low_stock_products, []); // out_of_stock_products not in current API

        // Update inventory chart
        updateInventoryChart(data.data.category_inventory);

        console.log('✅ Inventory data updated successfully');

    } catch (error) {
        console.error('❌ Error loading inventory data:', error);
        showToast('Error loading inventory data: ' + error.message, 'error');
    }
}

// Update summary cards
function updateSummaryCards(data) {
    const totalProductsEl = document.getElementById('totalProducts');
    const lowStockItemsEl = document.getElementById('lowStockItems');
    const outOfStockEl = document.getElementById('outOfStock');
    const totalValueEl = document.getElementById('totalValue');

    // Extract data from the API response
    const lowStockCount = data.low_stock_products ? data.low_stock_products.length : 0;
    const totalValue = data.valuation ? data.valuation.total_retail_value : 0;
    const productCount = data.valuation && data.valuation.products ? data.valuation.products.length : 0;

    if (totalProductsEl) {
        totalProductsEl.textContent = productCount.toLocaleString();
    }

    if (lowStockItemsEl) {
        lowStockItemsEl.textContent = lowStockCount.toLocaleString();
    }

    if (outOfStockEl) {
        outOfStockEl.textContent = '0'; // Not provided in current API
    }

    if (totalValueEl) {
        totalValueEl.textContent = formatMoney(totalValue);
    }
}

// Update low stock table
function updateLowStockTable(lowStockProducts, outOfStockProducts) {
    const tableBody = document.getElementById('lowStockTableBody');
    const noLowStockRow = document.getElementById('noLowStockRow');

    if (!tableBody) return;

    // Clear existing rows
    tableBody.innerHTML = '';

    // Use only low stock products from the new API structure
    const allAlerts = lowStockProducts.map(p => ({
        ...p, 
        status: 'low',
        id: p._id || '',
        current_stock: p.stock_quantity || 0,
        min_stock_level: 10, // Default minimum stock level
        category: p.category_name || 'Uncategorized' // Use category_name from API
    }));

    if (allAlerts.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-8 text-center">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-check-circle text-green-500 text-lg"></i>
                        </div>
                        <p class="text-gray-600 font-medium mb-1 text-sm">All Stock Levels OK</p>
                        <p class="text-xs text-gray-500">No low stock alerts at this time</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    // Add rows for each alert
    allAlerts.forEach(product => {
        const statusClass = product.status === 'out' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
        const statusText = product.status === 'out' ? 'Out of Stock' : 'Low Stock';
        const statusIcon = product.status === 'out' ? 'fas fa-times-circle' : 'fas fa-exclamation-triangle';

        const row = document.createElement('tr');
        row.className = 'hover:bg-gradient-to-r hover:from-gray-50 hover:to-yellow-50 transition-all duration-200';
        row.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-box text-gray-500"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">${product.name || 'Unknown Product'}</div>
                        <div class="text-sm text-gray-500">Brand: ${product.brand || 'N/A'}</div>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-medium">${product.current_stock}</div>
                <div class="text-sm text-gray-500">${product.category}</div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="text-sm text-gray-900">${product.min_stock_level}</div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                    <i class="${statusIcon} mr-1"></i>
                    ${statusText}
                </span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                <button onclick="restockProduct('${product.id}')" class="inline-flex items-center px-3 py-1 bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white rounded text-xs font-medium transition-all duration-200">
                    <i class="fas fa-plus mr-1"></i>Restock
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Update inventory chart
function updateInventoryChart(categoryData) {
    console.log('📊 updateInventoryChart called with:', categoryData);

    if (typeof ApexCharts === 'undefined') {
        console.error('❌ ApexCharts not available');
        showToast('Chart library not loaded', 'error');
        return;
    }

    const chartContainer = document.getElementById('inventoryChart');
    const placeholder = document.getElementById('inventoryChartPlaceholder');

    if (!chartContainer) {
        console.error('❌ Chart container not found');
        return;
    }

    if (!placeholder) {
        console.error('❌ Chart placeholder not found');
        return;
    }

    console.log('📊 Chart elements found, proceeding...');

    // Destroy existing chart
    if (inventoryChart) {
        console.log('📊 Destroying existing chart');
        inventoryChart.destroy();
        inventoryChart = null;
    }

    if (!categoryData || categoryData.length === 0) {
        console.log('⚠️ No category data available');
        placeholder.innerHTML = `
            <div class="text-center">
                <i class="fas fa-chart-bar text-gray-400 text-4xl mb-2"></i>
                <p class="text-gray-500">No category data available</p>
            </div>
        `;
        placeholder.style.display = 'flex';
        return;
    }

    // Filter out null categories and prepare chart data
    const validCategories = categoryData.filter(cat => cat._id && cat.total_value > 0);
    console.log('📊 Valid categories for chart:', validCategories);

    if (validCategories.length === 0) {
        console.log('⚠️ No valid categories with values > 0');
        placeholder.innerHTML = `
            <div class="text-center">
                <i class="fas fa-chart-bar text-gray-400 text-4xl mb-2"></i>
                <p class="text-gray-500">No category data with values available</p>
            </div>
        `;
        placeholder.style.display = 'flex';
        return;
    }

    // Hide placeholder
    placeholder.style.display = 'none';

    // Prepare chart data
    const categories = validCategories.map(cat => cat._id || 'Uncategorized');
    const values = validCategories.map(cat => cat.total_value);

    console.log('📊 Chart data prepared:', { categories, values });

    const options = {
        series: [{
            name: 'Inventory Value',
            data: values
        }],
        chart: {
            type: 'bar',
            height: '100%',
            toolbar: {
                show: false
            },
            background: 'transparent',
            fontFamily: 'Inter, system-ui, sans-serif',
            parentHeightOffset: 0
        },
        colors: ['#10b981'],
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: false,
                columnWidth: '60%'
            }
        },
        dataLabels: {
            enabled: false
        },
        xaxis: {
            categories: categories,
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '11px'
                }
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            }
        },
        yaxis: {
            title: {
                text: 'Value',
                style: {
                    color: '#374151',
                    fontSize: '12px',
                    fontWeight: 600
                }
            },
            labels: {
                formatter: function (val) {
                    return formatMoney(val).replace('UGX ', '');
                },
                style: {
                    colors: '#6b7280',
                    fontSize: '11px'
                }
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            }
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function (val) {
                    return formatMoney(val, true);
                }
            }
        },
        grid: {
            show: true,
            borderColor: '#f3f4f6',
            strokeDashArray: 2,
            yaxis: {
                lines: {
                    show: true
                }
            },
            xaxis: {
                lines: {
                    show: false
                }
            },
            padding: {
                top: 0,
                right: 15,
                bottom: 5,
                left: 5
            }
        }
    };

    console.log('📊 Creating ApexCharts instance with options:', options);

    try {
        inventoryChart = new ApexCharts(chartContainer, options);
        console.log('📊 ApexCharts instance created, rendering...');

        inventoryChart.render().then(() => {
            console.log('✅ Inventory chart rendered successfully');
        }).catch((error) => {
            console.error('❌ Error rendering inventory chart:', error);
            showToast('Error rendering chart: ' + error.message, 'error');
        });
    } catch (error) {
        console.error('❌ Error creating inventory chart:', error);
        showToast('Error creating chart: ' + error.message, 'error');
    }
}

// Update movement table
function updateMovementTable(movementData) {
    const tableBody = document.getElementById('movementTableBody');
    if (!tableBody) return;

    if (!movementData || movementData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-8 text-center">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-check-circle text-green-500 text-lg"></i>
                        </div>
                        <p class="text-gray-600 font-medium mb-1 text-sm">No Movement Data</p>
                        <p class="text-xs text-gray-500">No stock movements in the selected period</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    // Clear existing rows
    tableBody.innerHTML = '';

    // Add rows for each movement
    movementData.forEach(movement => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gradient-to-r hover:from-gray-50 hover:to-blue-50 transition-all duration-200';
        
        // Determine movement type and styling
        const isIncoming = movement.quantity > 0;
        const typeClass = isIncoming ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const typeIcon = isIncoming ? 'fas fa-arrow-down' : 'fas fa-arrow-up';
        const typeText = isIncoming ? 'Stock In' : 'Stock Out';
        const quantity = Math.abs(movement.quantity);
        
        row.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-medium">${movement.date || 'N/A'}</div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center mr-3">
                        <i class="fas fa-box text-gray-500"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">${movement.product_name || 'Unknown Product'}</div>
                        <div class="text-xs text-gray-500">Brand: ${movement.brand || 'N/A'}</div>
                    </div>
                </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeClass}">
                    <i class="${typeIcon} mr-1"></i>
                    ${typeText}
                </span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-medium">${quantity}</div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="text-sm text-gray-900">${movement.user || 'System'}</div>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Report generation functions
function generateStockReport() {
    // For Stock Levels report, we want to show only Low Stock Alerts and Inventory by Category
    // Hide other report sections
    const movementSection = document.getElementById('movementReportSection');
    const valuationSection = document.getElementById('valuationReportSection');
    const lowStockSection = document.getElementById('lowStockAlertsSection');
    const inventoryChartSection = document.getElementById('inventoryByCategorySection');
    
    if (movementSection) {
        movementSection.classList.add('hidden');
    }
    
    if (valuationSection) {
        valuationSection.classList.add('hidden');
    }
    
    // Show the Low Stock Alerts and Inventory by Category sections
    if (lowStockSection) {
        lowStockSection.classList.remove('hidden');
    }
    
    if (inventoryChartSection) {
        inventoryChartSection.classList.remove('hidden');
    }
    
    showToast('Stock levels report displayed', 'success');
}

async function generateMovementReport() {
    // For Stock Movement report, we want to show only the movement data
    // Hide all other sections
    const valuationSection = document.getElementById('valuationReportSection');
    const lowStockSection = document.getElementById('lowStockAlertsSection');
    const inventoryChartSection = document.getElementById('inventoryByCategorySection');
    
    if (valuationSection) {
        valuationSection.classList.add('hidden');
    }
    
    if (lowStockSection) {
        lowStockSection.classList.add('hidden');
    }
    
    if (inventoryChartSection) {
        inventoryChartSection.classList.add('hidden');
    }
    
    // Show the movement report section
    const movementSection = document.getElementById('movementReportSection');
    if (movementSection) {
        movementSection.classList.remove('hidden');
    }
    
    // Scroll to the movement report section
    movementSection.scrollIntoView({ behavior: 'smooth' });
    
    const tableBody = document.getElementById('movementTableBody');
    
    try {
        console.log('📊 Loading stock movement data...');

        const response = await fetch('/api/reports/stock-movement?days=30', {
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        console.log('📊 Stock movement data loaded:', data);

        if (!data.success) {
            throw new Error('API returned error: ' + (data.error || 'Unknown error'));
        }

        // Update movement table
        updateMovementTable(data.data);

        showToast('Stock movement report generated successfully!', 'success');

    } catch (error) {
        console.error('❌ Error generating movement report:', error);
        showToast('Error generating movement report: ' + error.message, 'error');
        
        // Show error in table
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center">
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3">
                                <i class="fas fa-exclamation-circle text-red-500 text-lg"></i>
                            </div>
                            <p class="text-red-600 font-medium mb-1 text-sm">Error Loading Data</p>
                            <p class="text-xs text-gray-500">${error.message}</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
}

function closeMovementReport() {
    const movementSection = document.getElementById('movementReportSection');
    if (movementSection) {
        movementSection.classList.add('hidden');
    }
    
    // Show the Low Stock Alerts and Inventory by Category sections again
    const lowStockSection = document.getElementById('lowStockAlertsSection');
    const inventoryChartSection = document.getElementById('inventoryByCategorySection');
    
    if (lowStockSection) {
        lowStockSection.classList.remove('hidden');
    }
    
    if (inventoryChartSection) {
        inventoryChartSection.classList.remove('hidden');
    }
}

function generateValuationReport() {
    // For Inventory Valuation report, we want to show Detailed Valuation Report and Product Valuation Details
    // Hide all other sections
    const movementSection = document.getElementById('movementReportSection');
    const lowStockSection = document.getElementById('lowStockAlertsSection');
    const inventoryChartSection = document.getElementById('inventoryByCategorySection');
    
    if (movementSection) {
        movementSection.classList.add('hidden');
    }
    
    if (lowStockSection) {
        lowStockSection.classList.add('hidden');
    }
    
    if (inventoryChartSection) {
        inventoryChartSection.classList.add('hidden');
    }
    
    // Show the valuation report section
    showValuationReport();
}

async function showValuationReport() {
    try {
        // Show the valuation report section
        const valuationSection = document.getElementById('valuationReportSection');
        if (valuationSection) {
            valuationSection.classList.remove('hidden');
            
            // Scroll to the valuation report section
            valuationSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Show loading state
        const summaryCards = document.getElementById('valuationSummaryCards');
        const categoryTableBody = document.getElementById('categoryValuationTableBody');
        const productTableBody = document.getElementById('productValuationTableBody');
        
        if (summaryCards) {
            summaryCards.innerHTML = `
                <div class="col-span-4 text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                    <p class="text-gray-600 mt-2">Loading valuation report...</p>
                </div>
            `;
        }
        
        if (categoryTableBody) {
            categoryTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center">
                        <i class="fas fa-spinner fa-spin text-gray-400"></i>
                        <span class="text-gray-600 ml-2">Loading category data...</span>
                    </td>
                </tr>
            `;
        }
        
        if (productTableBody) {
            productTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center">
                        <i class="fas fa-spinner fa-spin text-gray-400"></i>
                        <span class="text-gray-600 ml-2">Loading product data...</span>
                    </td>
                </tr>
            `;
        }
        
        const response = await fetch('/api/reports/valuation-report', {
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        console.log('📊 Valuation report data loaded:', data);

        if (!data.success) {
            throw new Error('API returned error: ' + (data.error || 'Unknown error'));
        }

        // Display the valuation report data
        displayValuationReport(data.data);
        
        showToast('Valuation report generated successfully!', 'success');
    } catch (error) {
        console.error('❌ Error generating valuation report:', error);
        showToast('Error generating valuation report: ' + error.message, 'error');
        
        // Show error in the section
        const summaryCards = document.getElementById('valuationSummaryCards');
        if (summaryCards) {
            summaryCards.innerHTML = `
                <div class="col-span-4 text-center py-8">
                    <i class="fas fa-exclamation-circle text-2xl text-red-500"></i>
                    <p class="text-red-600 mt-2">Error loading valuation report</p>
                    <p class="text-gray-500 text-sm mt-1">${error.message}</p>
                </div>
            `;
        }
    }
}

// Function to display valuation report data
function displayValuationReport(valuationData) {
    // Update summary cards
    const summaryCards = document.getElementById('valuationSummaryCards');
    if (summaryCards && valuationData.summary) {
        const summary = valuationData.summary;
        summaryCards.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-boxes text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Total Products</p>
                        <p class="text-lg font-bold text-gray-900">${summary.total_products.toLocaleString()}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-tag text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Retail Value</p>
                        <p class="text-lg font-bold text-gray-900">${formatMoney(summary.total_retail_value)}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-dollar-sign text-orange-600"></i>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Cost Value</p>
                        <p class="text-lg font-bold text-gray-900">${formatMoney(summary.total_cost_value)}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-chart-line text-purple-600"></i>
                    </div>
                    <div>
                        <p class="text-xs font-medium text-gray-500">Profit Value</p>
                        <p class="text-lg font-bold text-gray-900">${formatMoney(summary.total_profit_value)}</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Update category valuation table
    const categoryTableBody = document.getElementById('categoryValuationTableBody');
    if (categoryTableBody && valuationData.by_category) {
        if (valuationData.by_category.length === 0) {
            categoryTableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-gray-300 text-2xl mb-2"></i>
                        <p>No category data available</p>
                    </td>
                </tr>
            `;
        } else {
            categoryTableBody.innerHTML = valuationData.by_category.map(category => `
                <tr class="hover:bg-gradient-to-r hover:from-gray-50 hover:to-blue-50 transition-all duration-200">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-folder text-gray-500 text-sm"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-900">${category.category_name}</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${category.product_count} products
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-600">${formatMoney(category.retail_value)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-orange-600">${formatMoney(category.cost_value)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-purple-600">${formatMoney(category.profit_value)}</td>
                </tr>
            `).join('');
        }
    }
    
    // Update product valuation table
    const productTableBody = document.getElementById('productValuationTableBody');
    if (productTableBody && valuationData.products) {
        if (valuationData.products.length === 0) {
            productTableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-gray-300 text-2xl mb-2"></i>
                        <p>No product data available</p>
                    </td>
                </tr>
            `;
        } else {
            // Sort products by retail value (highest first) and limit to top 50 for performance
            const sortedProducts = [...valuationData.products]
                .sort((a, b) => b.retail_value - a.retail_value)
                .slice(0, 50);
                
            productTableBody.innerHTML = sortedProducts.map(product => `
                <tr class="hover:bg-gradient-to-r hover:from-gray-50 hover:to-green-50 transition-all duration-200">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center mr-3">
                                <i class="fas fa-box text-gray-500"></i>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${product.name}</div>
                                <div class="text-xs text-gray-500">Brand: ${product.brand || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${product.category_name}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                        <div class="font-medium">${product.stock_quantity}</div>
                        <div class="text-xs">${product.unit}</div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${formatMoney(product.price)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-600">${formatMoney(product.retail_value)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-orange-600">${formatMoney(product.cost_value)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-purple-600">${formatMoney(product.profit_value)}</td>
                </tr>
            `).join('');
        }
    }
}

function closeValuationReport() {
    const valuationSection = document.getElementById('valuationReportSection');
    if (valuationSection) {
        valuationSection.classList.add('hidden');
    }
    
    // Show the Low Stock Alerts and Inventory by Category sections again
    const lowStockSection = document.getElementById('lowStockAlertsSection');
    const inventoryChartSection = document.getElementById('inventoryByCategorySection');
    
    if (lowStockSection) {
        lowStockSection.classList.remove('hidden');
    }
    
    if (inventoryChartSection) {
        inventoryChartSection.classList.remove('hidden');
    }
}

function refreshAlerts() {
    showToast('Refreshing inventory data...', 'info');
    loadInventoryData();
}

function restockProduct(productId) {
    showToast('Redirecting to product restock...', 'info');
    // TODO: Implement restock functionality or redirect to product page
    window.location.href = `/products?highlight=${productId}`;
}

// Test chart function
function testChart() {
    console.log('🧪 Testing chart with sample data...');

    if (typeof ApexCharts === 'undefined') {
        alert('❌ ApexCharts not loaded');
        return;
    }

    const sampleData = [
        { category: 'Electronics', total_value: 18388800 },
        { category: 'Perfume', total_value: 12810000 },
        { category: 'Books', total_value: 6802875 },
        { category: 'Clothing', total_value: 440000 }
    ];

    console.log('📊 Testing with sample data:', sampleData);
    updateInventoryChart(sampleData);
    showToast('Test chart created!', 'success');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('📦 Inventory Reports page loaded');

    // Load initial data
    setTimeout(() => {
        loadInventoryData();
    }, 100);
});
</script>
{% endblock %}
