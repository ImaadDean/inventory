{% extends "base.html" %}

{% block title %}Inventory Reports - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-500 to-teal-600 shadow-lg rounded-xl p-6 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="mb-4 md:mb-0">
                <h1 class="text-2xl md:text-3xl font-bold">📦 Inventory Reports</h1>
                <p class="text-green-100 text-sm mt-1">Stock levels, movement, and inventory analytics</p>
            </div>
            <div class="flex space-x-2">
                <a href="/reports" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-white text-sm font-medium transition-all duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Reports
                </a>
                <button onclick="testChart()" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-white text-sm font-medium transition-all duration-200">
                    <i class="fas fa-chart-bar mr-2"></i>Test Chart
                </button>
            </div>
        </div>
    </div>

    <!-- Inventory Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Products</p>
                    <p class="text-2xl font-bold text-blue-600" id="totalProducts">0</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-boxes text-blue-600 text-lg"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Low Stock Items</p>
                    <p class="text-2xl font-bold text-red-600" id="lowStockItems">0</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Out of Stock</p>
                    <p class="text-2xl font-bold text-orange-600" id="outOfStock">0</p>
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-times-circle text-orange-600 text-lg"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Value</p>
                    <p class="text-2xl font-bold text-green-600" id="totalValue">UGX 0</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-dollar-sign text-green-600 text-lg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Categories -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Stock Levels Report -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Stock Levels</h3>
                <i class="fas fa-layer-group text-blue-600 text-xl"></i>
            </div>
            <p class="text-sm text-gray-600 mb-4">Current stock quantities and inventory status</p>
            <button onclick="generateStockReport()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors duration-200">
                Generate Report
            </button>
        </div>

        <!-- Movement Report -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Stock Movement</h3>
                <i class="fas fa-exchange-alt text-green-600 text-xl"></i>
            </div>
            <p class="text-sm text-gray-600 mb-4">Inventory in/out movements and transactions</p>
            <button onclick="generateMovementReport()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors duration-200">
                Generate Report
            </button>
        </div>

        <!-- Valuation Report -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Inventory Valuation</h3>
                <i class="fas fa-calculator text-purple-600 text-xl"></i>
            </div>
            <p class="text-sm text-gray-600 mb-4">Total inventory value and cost analysis</p>
            <button onclick="generateValuationReport()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors duration-200">
                Generate Report
            </button>
        </div>
    </div>

    <!-- Low Stock Alert -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Low Stock Alerts</h3>
            <button onclick="refreshAlerts()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors duration-200">
                <i class="fas fa-sync mr-2"></i>Refresh
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Stock</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min Level</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="lowStockTableBody">
                    <tr id="noLowStockRow">
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-gray-300 text-3xl mb-2"></i>
                            <p>Loading low stock alerts...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Inventory Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Inventory by Category</h3>
        <div class="h-72 relative">
            <div id="inventoryChart" class="w-full h-full"></div>
            <div id="inventoryChartPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-lg">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-4xl mb-2"></i>
                    <p class="text-gray-500">Loading inventory chart...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let inventoryChart = null;

// Money formatting function
function formatMoney(value, showFull = false) {
    if (value === 0) return 'UGX 0';

    const absValue = Math.abs(value);
    const isNegative = value < 0;
    const prefix = isNegative ? '-UGX ' : 'UGX ';

    if (showFull) {
        return prefix + absValue.toLocaleString();
    }

    if (absValue >= 1000000000) {
        return prefix + (absValue / 1000000000).toFixed(1) + 'B';
    } else if (absValue >= 1000000) {
        return prefix + (absValue / 1000000).toFixed(1) + 'M';
    } else if (absValue >= 1000) {
        return prefix + (absValue / 1000).toFixed(1) + 'K';
    } else {
        return prefix + absValue.toLocaleString();
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium transition-all duration-300 transform translate-x-full`;

    // Set color based on type
    switch(type) {
        case 'success':
            toast.className += ' bg-green-600';
            break;
        case 'error':
            toast.className += ' bg-red-600';
            break;
        case 'warning':
            toast.className += ' bg-yellow-600';
            break;
        default:
            toast.className += ' bg-blue-600';
    }

    toast.textContent = message;
    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Load inventory data
async function loadInventoryData() {
    try {
        console.log('📦 Loading inventory data...');

        // Check if ApexCharts is available
        if (typeof ApexCharts === 'undefined') {
            console.error('❌ ApexCharts not available');
            showToast('Chart library not loaded. Please refresh the page.', 'error');
        } else {
            console.log('✅ ApexCharts is available');
        }

        const response = await fetch('/reports/api/inventory-data', {
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        console.log('📦 Inventory data loaded:', data);
        console.log('📊 Category breakdown:', data.category_breakdown);

        // Update summary cards
        updateSummaryCards(data.inventory_overview);

        // Update low stock table
        updateLowStockTable(data.low_stock_products, data.out_of_stock_products);

        // Update inventory chart
        updateInventoryChart(data.category_breakdown);

        console.log('✅ Inventory data updated successfully');

    } catch (error) {
        console.error('❌ Error loading inventory data:', error);
        showToast('Error loading inventory data: ' + error.message, 'error');
    }
}

// Update summary cards
function updateSummaryCards(overview) {
    const totalProductsEl = document.getElementById('totalProducts');
    const lowStockItemsEl = document.getElementById('lowStockItems');
    const outOfStockEl = document.getElementById('outOfStock');
    const totalValueEl = document.getElementById('totalValue');

    if (totalProductsEl) {
        totalProductsEl.textContent = overview.total_products.toLocaleString();
    }

    if (lowStockItemsEl) {
        lowStockItemsEl.textContent = overview.low_stock_products.toLocaleString();
    }

    if (outOfStockEl) {
        outOfStockEl.textContent = overview.out_of_stock_products.toLocaleString();
    }

    if (totalValueEl) {
        totalValueEl.textContent = formatMoney(overview.total_inventory_value);
    }
}

// Update low stock table
function updateLowStockTable(lowStockProducts, outOfStockProducts) {
    const tableBody = document.getElementById('lowStockTableBody');
    const noLowStockRow = document.getElementById('noLowStockRow');

    if (!tableBody) return;

    // Clear existing rows
    tableBody.innerHTML = '';

    // Combine low stock and out of stock products
    const allAlerts = [
        ...lowStockProducts.map(p => ({...p, status: 'low'})),
        ...outOfStockProducts.map(p => ({...p, status: 'out', current_stock: 0, min_stock_level: 1}))
    ];

    if (allAlerts.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-check-circle text-green-300 text-3xl mb-2"></i>
                    <p>No low stock alerts at this time</p>
                </td>
            </tr>
        `;
        return;
    }

    // Add rows for each alert
    allAlerts.forEach(product => {
        const statusClass = product.status === 'out' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
        const statusText = product.status === 'out' ? 'Out of Stock' : 'Low Stock';
        const statusIcon = product.status === 'out' ? 'fas fa-times-circle' : 'fas fa-exclamation-triangle';

        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-lg bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-box text-gray-500"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">${product.name}</div>
                        <div class="text-sm text-gray-500">SKU: ${product.sku}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${product.current_stock}</div>
                <div class="text-sm text-gray-500">${product.category}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${product.min_stock_level}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                    <i class="${statusIcon} mr-1"></i>
                    ${statusText}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="restockProduct('${product.id}')" class="text-indigo-600 hover:text-indigo-900">
                    <i class="fas fa-plus mr-1"></i>Restock
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Update inventory chart
function updateInventoryChart(categoryData) {
    console.log('📊 updateInventoryChart called with:', categoryData);

    if (typeof ApexCharts === 'undefined') {
        console.error('❌ ApexCharts not available');
        showToast('Chart library not loaded', 'error');
        return;
    }

    const chartContainer = document.getElementById('inventoryChart');
    const placeholder = document.getElementById('inventoryChartPlaceholder');

    if (!chartContainer) {
        console.error('❌ Chart container not found');
        return;
    }

    if (!placeholder) {
        console.error('❌ Chart placeholder not found');
        return;
    }

    console.log('📊 Chart elements found, proceeding...');

    // Destroy existing chart
    if (inventoryChart) {
        console.log('📊 Destroying existing chart');
        inventoryChart.destroy();
        inventoryChart = null;
    }

    if (!categoryData || categoryData.length === 0) {
        console.log('⚠️ No category data available');
        placeholder.innerHTML = `
            <div class="text-center">
                <i class="fas fa-chart-bar text-gray-400 text-4xl mb-2"></i>
                <p class="text-gray-500">No category data available</p>
            </div>
        `;
        placeholder.style.display = 'flex';
        return;
    }

    // Filter out null categories and prepare chart data
    const validCategories = categoryData.filter(cat => cat.category && cat.total_value > 0);
    console.log('📊 Valid categories for chart:', validCategories);

    if (validCategories.length === 0) {
        console.log('⚠️ No valid categories with values > 0');
        placeholder.innerHTML = `
            <div class="text-center">
                <i class="fas fa-chart-bar text-gray-400 text-4xl mb-2"></i>
                <p class="text-gray-500">No category data with values available</p>
            </div>
        `;
        placeholder.style.display = 'flex';
        return;
    }

    // Hide placeholder
    placeholder.style.display = 'none';

    // Prepare chart data
    const categories = validCategories.map(cat => cat.category || 'Uncategorized');
    const values = validCategories.map(cat => cat.total_value);

    console.log('📊 Chart data prepared:', { categories, values });

    const options = {
        series: [{
            name: 'Inventory Value',
            data: values
        }],
        chart: {
            type: 'bar',
            height: '100%',
            toolbar: {
                show: false
            },
            background: 'transparent',
            fontFamily: 'Inter, system-ui, sans-serif',
            parentHeightOffset: 0
        },
        colors: ['#10b981'],
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: false,
                columnWidth: '60%'
            }
        },
        dataLabels: {
            enabled: false
        },
        xaxis: {
            categories: categories,
            labels: {
                style: {
                    colors: '#6b7280',
                    fontSize: '11px'
                }
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            }
        },
        yaxis: {
            title: {
                text: 'Value',
                style: {
                    color: '#374151',
                    fontSize: '12px',
                    fontWeight: 600
                }
            },
            labels: {
                formatter: function (val) {
                    return formatMoney(val).replace('UGX ', '');
                },
                style: {
                    colors: '#6b7280',
                    fontSize: '11px'
                }
            },
            axisBorder: {
                show: false
            },
            axisTicks: {
                show: false
            }
        },
        tooltip: {
            theme: 'light',
            y: {
                formatter: function (val) {
                    return formatMoney(val, true);
                }
            }
        },
        grid: {
            show: true,
            borderColor: '#f3f4f6',
            strokeDashArray: 2,
            yaxis: {
                lines: {
                    show: true
                }
            },
            xaxis: {
                lines: {
                    show: false
                }
            },
            padding: {
                top: 0,
                right: 15,
                bottom: 5,
                left: 5
            }
        }
    };

    console.log('📊 Creating ApexCharts instance with options:', options);

    try {
        inventoryChart = new ApexCharts(chartContainer, options);
        console.log('📊 ApexCharts instance created, rendering...');

        inventoryChart.render().then(() => {
            console.log('✅ Inventory chart rendered successfully');
        }).catch((error) => {
            console.error('❌ Error rendering inventory chart:', error);
            showToast('Error rendering chart: ' + error.message, 'error');
        });
    } catch (error) {
        console.error('❌ Error creating inventory chart:', error);
        showToast('Error creating chart: ' + error.message, 'error');
    }
}

// Report generation functions
function generateStockReport() {
    showToast('Generating stock levels report...', 'info');
    // TODO: Implement stock report generation
    setTimeout(() => {
        showToast('Stock report generated successfully!', 'success');
    }, 2000);
}

async function generateMovementReport() {
    showToast('Generating stock movement report...', 'info');

    try {
        console.log('📊 Loading stock movement data...');

        const response = await fetch('/reports/api/stock-movement?days=30', {
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }

        const data = await response.json();
        console.log('📊 Stock movement data loaded:', data);

        // Show movement report modal
        showMovementReportModal(data);

        showToast('Stock movement report generated successfully!', 'success');

    } catch (error) {
        console.error('❌ Error generating movement report:', error);
        showToast('Error generating movement report: ' + error.message, 'error');
    }
}

function generateValuationReport() {
    showToast('Generating inventory valuation report...', 'info');
    // TODO: Implement valuation report generation
    setTimeout(() => {
        showToast('Valuation report generated successfully!', 'success');
    }, 2000);
}

function refreshAlerts() {
    showToast('Refreshing inventory data...', 'info');
    loadInventoryData();
}

function restockProduct(productId) {
    showToast('Redirecting to product restock...', 'info');
    // TODO: Implement restock functionality or redirect to product page
    window.location.href = `/products?highlight=${productId}`;
}

// Test chart function
function testChart() {
    console.log('🧪 Testing chart with sample data...');

    if (typeof ApexCharts === 'undefined') {
        alert('❌ ApexCharts not loaded');
        return;
    }

    const sampleData = [
        { category: 'Electronics', total_value: 18388800 },
        { category: 'Perfume', total_value: 12810000 },
        { category: 'Books', total_value: 6802875 },
        { category: 'Clothing', total_value: 440000 }
    ];

    console.log('📊 Testing with sample data:', sampleData);
    updateInventoryChart(sampleData);
    showToast('Test chart created!', 'success');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('📦 Inventory Reports page loaded');

    // Load initial data
    setTimeout(() => {
        loadInventoryData();
    }, 100);
});
</script>
{% endblock %}
