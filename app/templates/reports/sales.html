{% extends "base.html" %}

{% block title %}Sales Reports - Inventory Management System{% endblock %}

{% block extra_head %}
<!-- ApexCharts is now loaded globally in base.html -->
<script>
    // Simple ready check for ApexCharts
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            if (typeof ApexCharts !== 'undefined') {
                console.log('‚úÖ ApexCharts is ready!');
                console.log('üìä ApexCharts version:', ApexCharts.version || 'unknown');
            } else {
                console.error('‚ùå ApexCharts not available after DOM load');
            }
        }, 100);
    });
</script>
{% endblock %}

{% block content %}
<div class="space-y-4 animate-fade-in max-w-full overflow-x-hidden">
    <!-- Compact Header -->
    <div class="bg-gradient-to-r from-green-600 to-emerald-700 rounded-lg shadow-sm p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-chart-line text-white text-lg mr-3"></i>
                <div>
                    <h2 class="text-xl font-bold text-white">Sales Reports</h2>
                    <p class="text-green-100 text-xs">Revenue & performance analysis</p>
                </div>
            </div>
            <a href="/reports" class="inline-flex items-center px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded text-sm font-medium transition-all duration-200">
                <i class="fas fa-arrow-left mr-1"></i>Back
            </a>
        </div>
    </div>



    <!-- Compact Date Range Filter -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-3">
                <div class="flex items-center">
                    <i class="fas fa-calendar-day text-green-500 text-sm mr-2"></i>
                    <input type="date" id="fromDate" class="px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" onchange="onDateChange()">
                </div>
                <span class="text-gray-400">to</span>
                <div class="flex items-center">
                    <i class="fas fa-calendar-check text-green-500 text-sm mr-2"></i>
                    <input type="date" id="toDate" class="px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500" onchange="onDateChange()">
                </div>
                <select id="quickSelect" class="px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500">
                    <option value="">Custom Range</option>
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Compact Sales Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <!-- Total Revenue Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-money-bill-wave text-white text-sm"></i>
                </div>
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            </div>
            <div>
                <p class="text-xs font-medium text-gray-600 mb-1">Total Revenue</p>
                <p class="text-lg font-bold text-gray-900" id="totalRevenue">UGX 0</p>
                <p class="text-xs text-green-600">
                    <i class="fas fa-arrow-up mr-1"></i>Revenue earned
                </p>
            </div>
        </div>

        <!-- Total Orders Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-shopping-bag text-white text-sm"></i>
                </div>
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
            </div>
            <div>
                <p class="text-xs font-medium text-gray-600 mb-1">Total Orders</p>
                <p class="text-lg font-bold text-gray-900" id="totalOrders">0</p>
                <p class="text-xs text-blue-600">
                    <i class="fas fa-check-circle mr-1"></i>Completed orders
                </p>
            </div>
        </div>

        <!-- Average Order Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow duration-200">
            <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-chart-line text-white text-sm"></i>
                </div>
                <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
            </div>
            <div>
                <p class="text-xs font-medium text-gray-600 mb-1">Average Order</p>
                <p class="text-lg font-bold text-gray-900" id="avgOrder">UGX 0</p>
                <p class="text-xs text-purple-600">
                    <i class="fas fa-calculator mr-1"></i>Per transaction
                </p>
            </div>
        </div>

        <!-- Growth Rate Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow duration-200" title="Revenue growth compared to the previous period of the same duration">
            <div class="flex items-center justify-between mb-2">
                <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-trending-up text-white text-sm"></i>
                </div>
                <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
            </div>
            <div>
                <p class="text-xs font-medium text-gray-600 mb-1">Growth Rate</p>
                <p class="text-lg font-bold text-gray-900" id="growthRate">0%</p>
                <p class="text-xs text-orange-600">
                    <i class="fas fa-chart-bar mr-1"></i>vs previous period
                </p>
            </div>
        </div>
    </div>

    <!-- Enhanced Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Sales Trend Chart -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-shadow duration-300">
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-chart-line text-white text-sm"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900">Sales Trend</h3>
                    </div>
                    <span class="text-xs text-gray-500 bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full font-medium">Daily View</span>
                </div>
            </div>
            <div class="p-6">
                <div class="h-72 relative">
                    <div id="salesTrendChart" class="w-full h-full"></div>
                    <div id="salesTrendPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-50 to-blue-50 rounded border-2 border-dashed border-gray-200">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-chart-line text-blue-500 text-lg"></i>
                            </div>
                            <p class="text-gray-600 font-medium mb-1 text-sm">Sales Trend Chart</p>
                            <p class="text-xs text-gray-500">Generate a report to view daily trend data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products Chart -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-shadow duration-300">
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-chart-pie text-white text-sm"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900">Top Products</h3>
                    </div>
                    <span class="text-xs text-gray-500 bg-purple-50 text-purple-700 px-3 py-1.5 rounded-full font-medium">Top 10</span>
                </div>
            </div>
            <div class="p-6">
                <div class="h-72 relative">
                    <div id="topProductsChart" class="w-full h-full"></div>
                    <div id="topProductsPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-50 to-purple-50 rounded border-2 border-dashed border-gray-200">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                <i class="fas fa-chart-pie text-purple-500 text-lg"></i>
                            </div>
                            <p class="text-gray-600 font-medium mb-1 text-sm">Top Products Chart</p>
                            <p class="text-xs text-gray-500">Generate a report to view product data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compact Sales Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-4 py-3 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-table text-green-600 text-sm mr-2"></i>
                    <h3 class="text-sm font-semibold text-gray-900">Sales Details</h3>
                </div>
                <button onclick="exportSalesData()" class="inline-flex items-center px-3 py-1.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded text-xs font-medium transition-all duration-200">
                    <i class="fas fa-download mr-1"></i>Export CSV
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-calendar-alt mr-1 text-gray-400"></i>
                                Date
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-hashtag mr-1 text-gray-400"></i>
                                Order ID
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-1 text-gray-400"></i>
                                Customer
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-box mr-1 text-gray-400"></i>
                                Items
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-money-bill-wave mr-1 text-gray-400"></i>
                                Amount
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-1 text-gray-400"></i>
                                Status
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="salesTableBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center">
                            <div class="flex flex-col items-center">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                    <i class="fas fa-chart-bar text-gray-400 text-lg"></i>
                                </div>
                                <p class="text-gray-600 font-medium mb-1 text-sm">No Data Available</p>
                                <p class="text-xs text-gray-500">Generate a report to view sales data</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// ApexCharts instances
let salesTrendChart = null;
let topProductsChart = null;

// Auto-generate report when dates change
function onDateChange() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;

    // Only generate if both dates are set
    if (fromDate && toDate) {
        // Add a small delay to avoid rapid API calls if user is quickly changing dates
        clearTimeout(window.dateChangeTimeout);
        window.dateChangeTimeout = setTimeout(() => {
            console.log('üìÖ Dates changed, auto-generating report...');
            loadSalesData();
        }, 500);
    }
}

// Money formatting function
function formatMoney(value, showFull = false) {
    if (value === 0) return 'UGX 0';

    const absValue = Math.abs(value);
    const isNegative = value < 0;
    const prefix = isNegative ? '-UGX ' : 'UGX ';

    if (showFull) {
        // For tooltips, show full amount with commas
        return prefix + absValue.toLocaleString();
    }

    if (absValue >= 1000000000) {
        return prefix + (absValue / 1000000000).toFixed(1) + 'B';
    } else if (absValue >= 1000000) {
        return prefix + (absValue / 1000000).toFixed(1) + 'M';
    } else if (absValue >= 1000) {
        return prefix + (absValue / 1000).toFixed(1) + 'K';
    } else {
        return prefix + absValue.toLocaleString();
    }
}



async function loadSalesData() {
    console.log('üöÄ loadSalesData function called');

    const fromDateEl = document.getElementById('fromDate');
    const toDateEl = document.getElementById('toDate');

    if (!fromDateEl || !toDateEl) {
        console.error('‚ùå Date input elements not found in DOM');
        showToast('Page elements not loaded properly. Please refresh the page.', 'error');
        return;
    }

    const fromDate = fromDateEl.value;
    const toDate = toDateEl.value;

    console.log('üìÖ Date values:', { fromDate, toDate });

    if (!fromDate || !toDate) {
        console.log('‚ùå Missing dates');
        showToast('Please select both from and to dates', 'error');
        return;
    }

    if (new Date(fromDate) > new Date(toDate)) {
        console.log('‚ùå Invalid date range');
        showToast('From date cannot be later than to date', 'error');
        return;
    }

    // Show loading state
    console.log('‚è≥ Setting loading state');
    const totalRevenueEl = document.getElementById('totalRevenue');
    const totalOrdersEl = document.getElementById('totalOrders');
    const avgOrderEl = document.getElementById('avgOrder');
    const growthRateEl = document.getElementById('growthRate');

    if (totalRevenueEl) totalRevenueEl.textContent = 'Loading...';
    if (totalOrdersEl) totalOrdersEl.textContent = 'Loading...';
    if (avgOrderEl) avgOrderEl.textContent = 'Loading...';
    if (growthRateEl) growthRateEl.textContent = 'Loading...';

    try {
        const url = `/reports/api/sales-data?from_date=${fromDate}&to_date=${toDate}`;
        console.log('üîç Fetching sales data from:', url);
        console.log('üîç Current location:', window.location.href);

        const response = await fetch(url, {
            credentials: 'include'
        });

        console.log('üîç Response status:', response.status);
        console.log('üîç Response headers:', response.headers);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('üîç Response error:', errorText);
            throw new Error(`Failed to fetch sales data: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('üîç Received data:', data);
        console.log('üîç Data type:', typeof data);
        console.log('üîç Data.success:', data.success);

        if (data.success) {
            console.log('‚úÖ Data is valid, updating UI');

            // Update summary cards
            const totalRevenueEl = document.getElementById('totalRevenue');
            const totalOrdersEl = document.getElementById('totalOrders');
            const avgOrderEl = document.getElementById('avgOrder');
            const growthRateEl = document.getElementById('growthRate');

            if (totalRevenueEl) {
                totalRevenueEl.textContent = formatMoney(data.summary.total_revenue);
            }
            if (totalOrdersEl) {
                totalOrdersEl.textContent = data.summary.total_orders.toLocaleString();
            }
            if (avgOrderEl) {
                avgOrderEl.textContent = formatMoney(Math.round(data.summary.avg_order_value));
            }
            if (growthRateEl) {
                const growthRate = data.summary.growth_rate;
                const growthText = `${growthRate > 0 ? '+' : ''}${growthRate}%`;
                growthRateEl.textContent = growthText;

                // Update color based on growth rate
                const growthContainer = growthRateEl.closest('.bg-white');
                const growthIcon = growthContainer.querySelector('.fas');
                const growthSubtext = growthContainer.querySelector('.text-xs.text-orange-600');

                if (growthRate > 0) {
                    // Positive growth - green
                    growthRateEl.className = 'text-lg font-bold text-green-600';
                    if (growthIcon) {
                        growthIcon.className = 'fas fa-trending-up text-white text-sm';
                        growthIcon.parentElement.className = 'w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center';
                    }
                    if (growthSubtext) {
                        growthSubtext.className = 'text-xs text-green-600';
                        growthSubtext.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>vs previous period';
                    }
                } else if (growthRate < 0) {
                    // Negative growth - red
                    growthRateEl.className = 'text-lg font-bold text-red-600';
                    if (growthIcon) {
                        growthIcon.className = 'fas fa-trending-down text-white text-sm';
                        growthIcon.parentElement.className = 'w-8 h-8 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center';
                    }
                    if (growthSubtext) {
                        growthSubtext.className = 'text-xs text-red-600';
                        growthSubtext.innerHTML = '<i class="fas fa-arrow-down mr-1"></i>vs previous period';
                    }
                } else {
                    // No growth - gray
                    growthRateEl.className = 'text-lg font-bold text-gray-600';
                    if (growthIcon) {
                        growthIcon.className = 'fas fa-minus text-white text-sm';
                        growthIcon.parentElement.className = 'w-8 h-8 bg-gradient-to-br from-gray-500 to-gray-600 rounded-lg flex items-center justify-center';
                    }
                    if (growthSubtext) {
                        growthSubtext.className = 'text-xs text-gray-600';
                        growthSubtext.innerHTML = '<i class="fas fa-minus mr-1"></i>vs previous period';
                    }
                }
            }

            // Update sales table
            console.log('üîç Updating sales table with', data.sales_data.length, 'records');
            updateSalesTable(data.sales_data);

            // Update charts
            console.log('üîç Updating charts with:', data.chart_data);
            updateCharts(data.chart_data);

            console.log('‚úÖ UI update complete');
            showToast('Sales report generated successfully!', 'success');
        } else {
            console.log('‚ùå Data.success is false');
            throw new Error('Invalid response format - success is false');
        }

    } catch (error) {
        console.error('‚ùå Error loading sales data:', error);
        console.error('‚ùå Error stack:', error.stack);
        console.error('‚ùå Error message:', error.message);

        let errorMessage = 'Failed to load sales data. Please try again.';
        if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Network error: Unable to connect to server. Please check your connection.';
        } else if (error.message.includes('401')) {
            errorMessage = 'Authentication error: Please log in again.';
        } else if (error.message.includes('500')) {
            errorMessage = 'Server error: Please try again later.';
        }

        showToast(errorMessage, 'error');

        // Reset to default values safely
        const totalRevenueEl = document.getElementById('totalRevenue');
        const totalOrdersEl = document.getElementById('totalOrders');
        const avgOrderEl = document.getElementById('avgOrder');
        const growthRateEl = document.getElementById('growthRate');

        if (totalRevenueEl) totalRevenueEl.textContent = formatMoney(0);
        if (totalOrdersEl) totalOrdersEl.textContent = '0';
        if (avgOrderEl) avgOrderEl.textContent = formatMoney(0);
        if (growthRateEl) growthRateEl.textContent = '0%';

        // Show chart placeholders
        showChartPlaceholders();
    }
}

function showChartPlaceholders() {
    // Show placeholders and hide charts
    const salesPlaceholder = document.getElementById('salesTrendPlaceholder');
    const topProductsPlaceholder = document.getElementById('topProductsPlaceholder');

    if (salesPlaceholder) salesPlaceholder.style.display = 'flex';
    if (topProductsPlaceholder) topProductsPlaceholder.style.display = 'flex';



    // Destroy existing charts
    if (salesTrendChart) {
        salesTrendChart.destroy();
        salesTrendChart = null;
    }
    if (topProductsChart) {
        topProductsChart.destroy();
        topProductsChart = null;
    }
}



function updateSalesTable(salesData) {
    const tbody = document.getElementById('salesTableBody');

    if (!salesData || salesData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-gray-300 text-3xl mb-2"></i>
                    <p>No sales data found for the selected period</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = salesData.map((sale, index) => `
        <tr class="hover:bg-gradient-to-r hover:from-gray-50 hover:to-blue-50 transition-all duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                    <span class="text-sm text-gray-900 font-medium">${sale.date}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-receipt text-blue-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-semibold text-blue-600 hover:text-blue-800 cursor-pointer">${sale.order_id}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-gray-500 text-xs"></i>
                    </div>
                    <span class="text-sm text-gray-900">${sale.customer}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-purple-100 rounded-md flex items-center justify-center mr-2">
                        <span class="text-xs font-bold text-purple-600">${sale.items_count}</span>
                    </div>
                    <span class="text-sm text-gray-500">item${sale.items_count !== 1 ? 's' : ''}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                    <span class="text-sm font-bold text-green-600">${formatMoney(sale.amount, true)}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 border border-green-200">
                    <div class="w-1.5 h-1.5 bg-green-500 rounded-full mr-2"></div>
                    ${sale.status}
                </span>
            </td>
        </tr>
    `).join('');
}

function updateCharts(chartData) {
    console.log('üîç updateCharts called with:', chartData);

    try {
        if (!chartData) {
            console.error('‚ùå No chart data provided');
            return;
        }

        // ApexCharts should be available globally from base.html
        if (typeof ApexCharts === 'undefined') {
            console.error('‚ùå ApexCharts not available in updateCharts');
            showToast('Chart library not loaded. Please refresh the page.', 'error');
            return;
        }

        if (!chartData.sales_trend) {
            console.error('‚ùå No sales_trend data in chartData');
        } else {
            console.log('üìä Updating sales trend chart...');
            console.log('üìä Sales trend data:', chartData.sales_trend);
            updateSalesTrendChart(chartData.sales_trend);
        }

        if (!chartData.top_products) {
            console.error('‚ùå No top_products data in chartData');
        } else {
            console.log('üìä Updating top products chart...');
            console.log('üìä Top products data:', chartData.top_products);
            updateTopProductsChart(chartData.top_products);
        }

        console.log('‚úÖ Charts updated successfully');
    } catch (error) {
        console.error('‚ùå Error updating charts:', error);
        console.error('‚ùå Error stack:', error.stack);
        showToast('Error updating charts: ' + error.message, 'error');
    }
}

function updateSalesTrendChart(trendData) {
    try {
        console.log('üìä updateSalesTrendChart called with:', trendData);

        // ApexCharts is loaded globally, but double-check
        if (typeof ApexCharts === 'undefined') {
            console.error('‚ùå ApexCharts not available');
            showToast('Chart library not loaded', 'error');
            return;
        }

        const chartContainer = document.getElementById('salesTrendChart');
        const placeholder = document.getElementById('salesTrendPlaceholder');

        if (!chartContainer) {
            console.error('‚ùå Sales trend chart container not found');
            showToast('Chart container not found', 'error');
            return;
        }

        if (!placeholder) {
            console.error('‚ùå Sales trend chart placeholder not found');
            return;
        }

        // Validate trend data first
        if (!trendData || !trendData.labels || !trendData.revenue || !trendData.orders) {
            console.error('‚ùå Invalid trend data structure:', trendData);
            showToast('Invalid chart data received', 'error');
            return;
        }

        if (trendData.labels.length === 0) {
            console.log('‚ö†Ô∏è No data points to display');
            showToast('No data to display in chart', 'warning');
            return;
        }

        console.log('üìä Data validation passed, proceeding with chart creation');

        // Hide placeholder
        placeholder.style.display = 'none';

        // Destroy existing chart
        if (salesTrendChart) {
            console.log('üìä Destroying existing chart');
            salesTrendChart.destroy();
            salesTrendChart = null;
        }

        // Format labels for better display
        const formattedLabels = trendData.labels.map(label => {
            try {
                const date = new Date(label);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } catch (e) {
                console.warn('Error formatting date:', label, e);
                return label;
            }
        });

        console.log('üîç Chart will use:', {
            labels: formattedLabels,
            revenue: trendData.revenue,
            orders: trendData.orders
        });

        // Enhanced ApexCharts configuration with better styling
        const options = {
            series: [
                {
                    name: 'Revenue',
                    type: 'area',
                    data: trendData.revenue
                },
                {
                    name: 'Orders',
                    type: 'line',
                    data: trendData.orders
                }
            ],
            chart: {
                height: '100%',
                type: 'line',
                toolbar: {
                    show: false
                },
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1000
                },
                background: 'transparent',
                fontFamily: 'Inter, system-ui, sans-serif',
                parentHeightOffset: 0
            },
            colors: ['#10b981', '#3b82f6'],
            stroke: {
                width: [0, 3],
                curve: 'smooth',
                lineCap: 'round'
            },
            fill: {
                type: ['gradient', 'solid'],
                gradient: {
                    shade: 'light',
                    type: 'vertical',
                    shadeIntensity: 0.5,
                    gradientToColors: ['#34d399'],
                    inverseColors: false,
                    opacityFrom: 0.6,
                    opacityTo: 0.1,
                    stops: [0, 100]
                }
            },
            labels: formattedLabels,
            markers: {
                size: [0, 4],
                colors: ['#10b981', '#3b82f6'],
                strokeColors: '#fff',
                strokeWidth: 2,
                hover: {
                    size: 6
                }
            },
            xaxis: {
                type: 'category',
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                },
                labels: {
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px',
                        fontWeight: 500
                    }
                }
            },
            yaxis: [
                {
                    title: {
                        text: ''
                    },
                    labels: {
                        formatter: function (val) {
                            // Remove UGX prefix for chart labels
                            const formatted = formatMoney(val);
                            return formatted.replace('UGX ', '');
                        },
                        style: {
                            colors: '#6b7280',
                            fontSize: '11px'
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                {
                    opposite: true,
                    title: {
                        text: ''
                    },
                    labels: {
                        style: {
                            colors: '#6b7280',
                            fontSize: '11px'
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                }
            ],
            tooltip: {
                shared: true,
                intersect: false,
                theme: 'light',
                style: {
                    fontSize: '12px'
                },
                y: [
                    {
                        formatter: function (val) {
                            return formatMoney(val, true);
                        }
                    },
                    {
                        formatter: function (val) {
                            return val + ' orders';
                        }
                    }
                ]
            },
            legend: {
                show: false
            },
            grid: {
                show: true,
                borderColor: '#f3f4f6',
                strokeDashArray: 2,
                position: 'back',
                xaxis: {
                    lines: {
                        show: false
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                },
                padding: {
                    top: 0,
                    right: 15,
                    bottom: 5,
                    left: 5
                }
            }
        };

        // Create new chart
        console.log('üìä Creating ApexCharts instance with options:', options);
        salesTrendChart = new ApexCharts(chartContainer, options);

        console.log('üìä Rendering sales trend chart...');
        salesTrendChart.render().then(() => {
            console.log('‚úÖ Sales trend chart rendered successfully');
        }).catch((error) => {
            console.error('‚ùå Error rendering sales trend chart:', error);
        });

        console.log('‚úÖ Sales trend chart created successfully');

    } catch (error) {
        console.error('‚ùå Error creating sales trend chart:', error);

        // Show placeholder if chart creation fails
        const placeholder = document.getElementById('salesTrendPlaceholder');
        if (placeholder) {
            placeholder.style.display = 'flex';
        }
    }
}



function updateTopProductsChart(productsData) {
    try {
        console.log('üìä updateTopProductsChart called with:', productsData);

        // ApexCharts is loaded globally, but double-check
        if (typeof ApexCharts === 'undefined') {
            console.error('‚ùå ApexCharts not available');
            return;
        }

        const chartContainer = document.getElementById('topProductsChart');
        const placeholder = document.getElementById('topProductsPlaceholder');

        if (!chartContainer) {
            console.error('‚ùå Top products chart container not found');
            return;
        }

        if (!placeholder) {
            console.error('‚ùå Top products chart placeholder not found');
            return;
        }

        // Hide placeholder
        placeholder.style.display = 'none';

        // Destroy existing chart
        if (topProductsChart) {
            topProductsChart.destroy();
        }

        // Validate products data
        if (!productsData.labels || !productsData.revenue) {
            console.error('‚ùå Invalid products data structure:', productsData);
            return;
        }

        if (productsData.labels.length === 0) {
            console.log('‚ö†Ô∏è No products data to display');
            return;
        }

        console.log('üîç Top products chart will use:', productsData);

        // Enhanced ApexCharts configuration for donut chart
        const options = {
            series: productsData.revenue,
            chart: {
                type: 'donut',
                height: '100%',
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 1000
                },
                background: 'transparent',
                fontFamily: 'Inter, system-ui, sans-serif',
                parentHeightOffset: 0
            },
            labels: productsData.labels,
            colors: [
                '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b',
                '#ef4444', '#06b6d4', '#84cc16', '#f97316',
                '#ec4899', '#6366f1'
            ],
            plotOptions: {
                pie: {
                    donut: {
                        size: '70%',
                        labels: {
                            show: true,
                            name: {
                                show: true,
                                fontSize: '13px',
                                fontWeight: 600,
                                color: '#374151',
                                offsetY: -8,
                                formatter: function (val) {
                                    return val.length > 12 ? val.substring(0, 12) + '...' : val;
                                }
                            },
                            value: {
                                show: true,
                                fontSize: '14px',
                                fontWeight: 700,
                                color: '#1f2937',
                                offsetY: 8,
                                formatter: function (val) {
                                    return formatMoney(parseInt(val));
                                }
                            },
                            total: {
                                show: true,
                                showAlways: true,
                                label: 'Total Revenue',
                                fontSize: '11px',
                                fontWeight: 500,
                                color: '#6b7280',
                                formatter: function (w) {
                                    const total = w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    return formatMoney(total);
                                }
                            }
                        }
                    },
                    expandOnClick: true
                }
            },
            dataLabels: {
                enabled: false
            },
            legend: {
                position: 'bottom',
                horizontalAlign: 'center',
                fontSize: '10px',
                fontWeight: 500,
                markers: {
                    width: 8,
                    height: 8,
                    radius: 4
                },
                itemMargin: {
                    horizontal: 6,
                    vertical: 2
                },
                formatter: function(seriesName, opts) {
                    const value = opts.w.globals.series[opts.seriesIndex];
                    const shortName = seriesName.length > 15 ? seriesName.substring(0, 15) + '...' : seriesName;
                    return shortName + ': ' + formatMoney(value);
                }
            },
            tooltip: {
                theme: 'light',
                style: {
                    fontSize: '12px'
                },
                y: {
                    formatter: function (val) {
                        return formatMoney(val, true);
                    }
                }
            },
            states: {
                hover: {
                    filter: {
                        type: 'lighten',
                        value: 0.1
                    }
                },
                active: {
                    allowMultipleDataPointsSelection: false,
                    filter: {
                        type: 'darken',
                        value: 0.1
                    }
                }
            },
            responsive: [{
                breakpoint: 768,
                options: {
                    legend: {
                        position: 'bottom',
                        fontSize: '9px',
                        itemMargin: {
                            horizontal: 4,
                            vertical: 1
                        }
                    }
                }
            }]
        };

        // Create new chart
        console.log('üìä Creating top products ApexCharts instance with options:', options);
        topProductsChart = new ApexCharts(chartContainer, options);

        console.log('üìä Rendering top products chart...');
        topProductsChart.render().then(() => {
            console.log('‚úÖ Top products chart rendered successfully');
        }).catch((error) => {
            console.error('‚ùå Error rendering top products chart:', error);
        });

        console.log('‚úÖ Top products chart created successfully');

    } catch (error) {
        console.error('‚ùå Error creating top products chart:', error);

        // Show placeholder if chart creation fails
        const placeholder = document.getElementById('topProductsPlaceholder');
        if (placeholder) {
            placeholder.style.display = 'flex';
        }
    }
}

function exportSalesData() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;

    if (!fromDate || !toDate) {
        showToast('Please generate a report first before exporting', 'error');
        return;
    }

    // Create export URL and trigger download
    const exportUrl = `/api/orders/export?date_from=${fromDate}&date_to=${toDate}`;
    window.open(exportUrl, '_blank');
    showToast('Export started! Check your downloads.', 'success');
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;

    // Set color based on type
    switch(type) {
        case 'success':
            toast.classList.add('bg-green-500');
            break;
        case 'error':
            toast.classList.add('bg-red-500');
            break;
        case 'warning':
            toast.classList.add('bg-yellow-500');
            break;
        default:
            toast.classList.add('bg-blue-500');
    }

    toast.textContent = message;
    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}



// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM Content Loaded - Initializing sales page');

    // Check ApexCharts availability (loaded from base.html)
    if (typeof ApexCharts !== 'undefined') {
        console.log('‚úÖ ApexCharts is available on page load');
        console.log('üìä ApexCharts version:', ApexCharts.version || 'unknown');
    } else {
        console.error('‚ùå ApexCharts not available on page load - check base.html');
        showToast('Chart library not loaded. Please refresh the page.', 'error');
    }

    // Check chart containers exist
    const salesTrendContainer = document.getElementById('salesTrendChart');
    const topProductsContainer = document.getElementById('topProductsChart');
    const salesTrendPlaceholder = document.getElementById('salesTrendPlaceholder');
    const topProductsPlaceholder = document.getElementById('topProductsPlaceholder');

    console.log('üìä Chart containers check:', {
        salesTrendContainer: !!salesTrendContainer,
        topProductsContainer: !!topProductsContainer,
        salesTrendPlaceholder: !!salesTrendPlaceholder,
        topProductsPlaceholder: !!topProductsPlaceholder
    });

    // Check for URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const fromDateParam = urlParams.get('from_date');
    const toDateParam = urlParams.get('to_date');
    const periodParam = urlParams.get('period');

    const fromDateEl = document.getElementById('fromDate');
    const toDateEl = document.getElementById('toDate');
    const quickSelectEl = document.getElementById('quickSelect');

    if (fromDateEl && toDateEl) {
        if (fromDateParam && toDateParam) {
            // Use URL parameters
            fromDateEl.value = fromDateParam;
            toDateEl.value = toDateParam;

            // Set quick select based on period parameter
            if (periodParam && quickSelectEl) {
                switch(periodParam) {
                    case 'daily':
                        quickSelectEl.value = 'today';
                        break;
                    case 'weekly':
                        quickSelectEl.value = 'week';
                        break;
                    case 'monthly':
                        quickSelectEl.value = 'month';
                        break;
                    case 'yearly':
                        quickSelectEl.value = 'year';
                        break;
                }
            }

            console.log('üìÖ URL dates set:', { from: fromDateParam, to: toDateParam, period: periodParam });
        } else {
            // Set default dates (last 7 days)
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);

            fromDateEl.value = weekAgo.toISOString().split('T')[0];
            toDateEl.value = today.toISOString().split('T')[0];
            console.log('üìÖ Default dates set:', { from: fromDateEl.value, to: toDateEl.value });
        }

        // Load initial data with a small delay to ensure DOM is ready
        setTimeout(() => {
            console.log('‚è≥ Loading initial sales data...');
            loadSalesData();
        }, 100);
    } else {
        console.error('‚ùå Date input elements not found');
    }
});

// Quick select functionality
document.getElementById('quickSelect').addEventListener('change', function() {
    const value = this.value;
    const today = new Date();
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');

    toDate.value = today.toISOString().split('T')[0];

    switch(value) {
        case 'today':
            fromDate.value = today.toISOString().split('T')[0];
            break;
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            fromDate.value = yesterday.toISOString().split('T')[0];
            toDate.value = yesterday.toISOString().split('T')[0];
            break;
        case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            fromDate.value = weekStart.toISOString().split('T')[0];
            break;
        case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            fromDate.value = monthStart.toISOString().split('T')[0];
            break;
        case 'quarter':
            const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
            fromDate.value = quarterStart.toISOString().split('T')[0];
            break;
        case 'year':
            const yearStart = new Date(today.getFullYear(), 0, 1);
            fromDate.value = yearStart.toISOString().split('T')[0];
            break;
    }

    // Auto-load data when quick select is used
    if (value) {
        console.log('üìÖ Quick select used, auto-generating report...');
        setTimeout(loadSalesData, 100);
    }
});
</script>
{% endblock %}
