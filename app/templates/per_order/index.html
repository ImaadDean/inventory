{% extends "base.html" %}

{% block title %}
    {% if per_order %}
        Pre-order {{ per_order.order_number }} - Inventory Management System
    {% else %}
        Pre-orders - Inventory Management System
    {% endif %}
{% endblock %}

{% block content %}
{% if per_order %}
    {# Detail View #}
    <div class="space-y-6">
        <!-- Header with Back Button -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg rounded-xl p-6 text-white">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center space-x-3 mb-2">
                        <a href="/per-order" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200">
                            <i class="fas fa-arrow-left text-sm"></i>
                            <span class="font-medium">Back to Pre-orders</span>
                        </a>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-bold">Pre-order {{ per_order.order_number }}</h1>
                    <p class="text-blue-100 text-sm">Detailed pre-order management and tracking</p>
                </div>
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-3">
                    <!-- Status Badge -->
                    <div class="flex items-center space-x-2">
                        <span class="px-3 py-1 rounded-full text-xs font-medium
                            {% if per_order.status == 'delivered' %}bg-green-500 bg-opacity-20 text-green-100 border border-green-400{% endif %}
                            {% if per_order.status == 'pending' %}bg-yellow-500 bg-opacity-20 text-yellow-100 border border-yellow-400{% endif %}
                            {% if per_order.status == 'processing' %}bg-blue-500 bg-opacity-20 text-blue-100 border border-blue-400{% endif %}
                            {% if per_order.status == 'shipped' %}bg-purple-500 bg-opacity-20 text-purple-100 border border-purple-400{% endif %}
                            {% if per_order.status == 'cancelled' %}bg-red-500 bg-opacity-20 text-red-100 border border-red-400{% endif %}
                            {% if per_order.status == 'returned' %}bg-gray-500 bg-opacity-20 text-gray-100 border border-gray-400{% endif %}">
                            {{ per_order.status.title() }}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium
                            {% if per_order.payment_status == 'paid' %}bg-green-500 bg-opacity-20 text-green-100 border border-green-400{% endif %}
                            {% if per_order.payment_status == 'pending' %}bg-yellow-500 bg-opacity-20 text-yellow-100 border border-yellow-400{% endif %}
                            {% if per_order.payment_status == 'partially_paid' %}bg-orange-500 bg-opacity-20 text-orange-100 border border-orange-400{% endif %}
                            {% if per_order.payment_status == 'failed' %}bg-red-500 bg-opacity-20 text-red-100 border border-red-400{% endif %}">
                            {{ per_order.payment_status.replace('_', ' ').title() }}
                        </span>
                        <span class="px-3 py-1 rounded-full text-xs font-medium
                            {% if per_order.priority == 'urgent' %}bg-red-500 bg-opacity-20 text-red-100 border border-red-400{% endif %}
                            {% if per_order.priority == 'high' %}bg-orange-500 bg-opacity-20 text-orange-100 border border-orange-400{% endif %}
                            {% if per_order.priority == 'normal' %}bg-blue-500 bg-opacity-20 text-blue-100 border border-blue-400{% endif %}
                            {% if per_order.priority == 'low' %}bg-gray-500 bg-opacity-20 text-gray-100 border border-gray-400{% endif %}">
                            {{ per_order.priority.title() }} Priority
                        </span>
                    </div>
                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        <button onclick="printOrder()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200">
                            <i class="fas fa-print text-sm"></i>
                            <span class="font-medium">Print</span>
                        </button>
                        {% if per_order.status != 'delivered' and per_order.status != 'cancelled' and per_order.status != 'returned' %}
                        <button onclick="editPerOrder()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200">
                            <i class="fas fa-edit text-sm"></i>
                            <span class="font-medium">Edit</span>
                        </button>
                        {% endif %}
                        <button onclick="openPaymentMethodModal('{{ per_order._id }}')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200">
                            <i class="fas fa-check-circle text-sm"></i>
                            <span class="font-medium">Confirm Order</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Information Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Customer Information -->
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-user text-blue-500 mr-2"></i>
                    Customer Information
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm font-medium text-gray-600">Name</label>
                        <p class="text-gray-900 font-medium">{{ per_order.customer_name or 'Walk-in Customer' }}</p>
                        <p class="text-gray-900">{{ per_order.customer_phone }}</p>
                    </div>
                    {% if per_order.customer_email %}
                    <div>
                        <label class="text-sm font-medium text-gray-600">Email</label>
                        <p class="text-gray-900">{{ per_order.customer_email }}</p>
                    </div>
                    {% endif %}
                    {% if per_order.customer_phone %}
                    <div>
                        <label class="text-sm font-medium text-gray-600">Phone</label>
                        <p class="text-gray-900">{{ per_order.customer_phone }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Order Summary -->
            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-receipt text-green-500 mr-2"></i>
                    Order Summary
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Subtotal</span>
                        <span class="font-medium">UGX {{ "{:,.0f}".format(per_order.subtotal) }}</span>
                    </div>
                    {% if per_order.tax_total > 0 %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Tax</span>
                        <span class="font-medium">UGX {{ "{:,.0f}".format(per_order.tax_total) }}</span>
                    </div>
                    {% endif %}
                    {% if per_order.discount_total > 0 %}
                    <div class="flex justify-between text-red-600">
                        <span>Discount</span>
                        <span class="font-medium">-UGX {{ "{:,.0f}".format(per_order.discount_total) }}</span>
                    </div>
                    {% endif %}
                    <div class="border-t pt-2">
                        <div class="flex justify-between text-lg font-bold">
                            <span>Total</span>
                            <span>UGX {{ "{:,.0f}".format(per_order.total_amount) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="bg-white rounded-xl shadow-md border border-gray-200">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-shopping-cart text-indigo-500 mr-2"></i>
                    Order Items ({{ per_order.items|length }})
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in per_order.items %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">{{ item.product_name }}</div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">{{ item.quantity }}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">UGX {{ "{:,.0f}".format(item.unit_price) }}</td>
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">UGX {{ "{:,.0f}".format(item.total_price) }}</td>
                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    {% set total_discount = per_order.items | sum(attribute='discount_amount') or 0 %}
                                    {% set final_total = (per_order.items | sum(attribute='total_price') or 0) - total_discount %}
                                    <tfoot class="bg-gray-100 font-semibold">
                                        <tr>
                                            <td colspan="3" class="px-6 py-3 text-right text-gray-800">Total</td>
                                            <td class="px-6 py-3 text-red-600">UGX {{ "{:,.0f}".format(total_discount) }}</td>
                                            <td class="px-6 py-3 text-gray-900">UGX {{ "{:,.0f}".format(final_total) }}</td>
                                        </tr>
                                    </tfoot>
                                </table>            </div>
        </div>
    </div>
{% else %}
    {# List View #}
    <div class="space-y-4">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 shadow-lg rounded-xl p-4 text-white">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-2 md:mb-0">
                    <h1 class="text-xl md:text-2xl font-bold">Pre-order Management</h1>
                    <p class="text-purple-100 text-sm">Detailed order tracking and management</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="window.location.reload()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm">
                        <i class="fas fa-refresh text-xs"></i>
                        <span class="font-medium">Refresh</span>
                    </button>
                    <button onclick="openCreatePerOrderModal()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm">
                        <i class="fas fa-plus text-xs"></i>
                        <span class="font-medium">New Pre-order</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <!-- Total Orders -->
            <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-boxes text-white text-xs"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <dt class="text-xs font-medium text-gray-500 truncate">Total Orders</dt>
                            <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-orders">0</dd>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-2">
                    <div class="text-xs">
                        <span class="text-blue-700 font-medium">All time</span>
                    </div>
                </div>
            </div>

            <!-- Pending Orders -->
            <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-exclamation-triangle text-white text-xs"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <dt class="text-xs font-medium text-gray-500 truncate">Pending Orders</dt>
                            <dd class="text-base font-bold text-gray-900 mt-0.5" id="pending-orders">0</dd>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-yellow-50 to-orange-100 px-4 py-2">
                    <div class="text-xs">
                        <span class="text-orange-700 font-medium">Awaiting action</span>
                    </div>
                </div>
            </div>

            <!-- Delivered Orders -->
            <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-check-circle text-white text-xs"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <dt class="text-xs font-medium text-gray-500 truncate">Delivered Orders</dt>
                            <dd class="text-base font-bold text-gray-900 mt-0.5" id="delivered-orders">0</dd>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-2">
                    <div class="text-xs">
                        <span class="text-green-700 font-medium">Completed</span>
                    </div>
                </div>
            </div>

            <!-- Total Revenue -->
            <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                                <i class="fas fa-dollar-sign text-white text-xs"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <dt class="text-xs font-medium text-gray-500 truncate">Total Revenue</dt>
                            <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-revenue">UGX 0</dd>
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-purple-50 to-purple-100 px-4 py-2">
                    <div class="text-xs">
                        <span class="text-purple-700 font-medium">From all orders</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Per Orders Table -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300">
            <div class="px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-list text-white text-xs"></i>
                        </div>
                        <div>
                            <h3 class="text-base font-semibold text-gray-900">Pre-orders</h3>
                            <div class="text-xs text-gray-600">
                                <span id="orders-count">0 orders</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <div class="relative">
                            <input type="text" id="search-orders" placeholder="Search orders, clients..."
                                   class="pl-7 pr-3 py-1.5 w-full sm:w-40 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                            <i class="fas fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                        </div>
                        <select id="status-filter" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="returned">Returned</option>
                        </select>
                        <div class="flex items-center space-x-1">
                            <input type="date" id="date-from" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" title="From Date">
                            <span class="text-gray-400 text-xs">to</span>
                            <input type="date" id="date-to" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" title="To Date">
                        </div>
                        <button onclick="clearFilters()" class="px-2 py-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-all duration-200 flex items-center space-x-1" title="Clear Filters">
                            <i class="fas fa-times text-xs"></i>
                            <span class="text-xs">Clear</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Order #</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Client</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Items</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="per-orders-table-body" class="bg-white divide-y divide-gray-100">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="px-4 py-3 border-t border-gray-200 bg-gray-50">
                <div class="flex flex-col items-center space-y-2">
                    <!-- Pagination Info -->
                    <div class="text-xs text-gray-600 font-medium">
                        <span id="pagination-info">Page 1 of 1</span>
                    </div>

                    <div id="loading-message" class="text-center text-gray-500 py-1" style="display: none;">
                        <div class="flex items-center justify-center space-x-2">
                            <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-blue-500"></div>
                            <span class="text-xs">Loading more orders...</span>
                        </div>
                    </div>

                    <div id="end-message" class="text-center text-gray-500 py-2" style="display: none;">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mb-1">
                                <i class="fas fa-check text-gray-400 text-sm"></i>
                            </div>
                            <p class="text-xs font-medium">You've reached the end</p>
                            <p class="text-xs">All orders have been loaded</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Pre-order Modal -->
    <div id="create-per-order-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] transform transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-plus-circle text-white text-xs"></i>
                            </div>
                            <h3 class="text-base font-semibold text-white">Create New Pre-order</h3>
                        </div>
                        <button type="button" onclick="closeCreatePerOrderModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4 bg-gray-50" style="max-height: calc(90vh - 50px); overflow-y: auto;">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div class="lg:col-span-2 space-y-4">
                            <!-- Product Search -->
                            <div class="bg-white shadow-md rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300">
                                <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600">
                                    <div class="flex items-center">
                                        <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                                            <i class="fas fa-search text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-semibold text-white">Product Search</h3>
                                            <p class="text-blue-100 text-xs">Find products by name, SKU, or barcode</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div class="relative">
                                        <input type="text"
                                               id="modal-product-search"
                                               placeholder="Search by name, SKU, or barcode..."
                                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 pr-20">
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 space-x-2">
                                            <button type="button" id="modal-barcode-camera-btn"
                                                    class="p-1 text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-md transition-all duration-200"
                                                    title="Scan barcode with camera">
                                                <i class="fas fa-camera text-sm"></i>
                                            </button>
                                            <i class="fas fa-search text-gray-400 text-sm"></i>
                                        </div>
                                    </div>
                                    <div id="modal-search-results" class="mt-3 space-y-2 max-h-48 overflow-y-auto"></div>
                                </div>
                            </div>
                            <!-- Shopping Cart -->
                            <div class="bg-white shadow-md rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300">
                                <div class="px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-600">
                                    <div class="flex items-center">
                                        <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                                            <i class="fas fa-shopping-cart text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-semibold text-white">Order Items</h3>
                                            <p class="text-purple-100 text-xs">Review selected items</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div id="modal-cart-items" class="space-y-2">
                                        <div class="text-center py-6 text-gray-500">
                                            <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                                            <p class="text-sm">Cart is empty</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <!-- Client Info -->
                            <div class="bg-white shadow-md rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300">
                                <div class="px-4 py-3 bg-gradient-to-r from-teal-500 to-cyan-600">
                                    <div class="flex items-center">
                                        <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                                            <i class="fas fa-user text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-semibold text-white">Client Information</h3>
                                            <p class="text-teal-100 text-xs">Select or add customer</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <div class="flex gap-2">
                                        <input type="text" id="modal-client-search" placeholder="Search client by name or phone..." class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200">
                                        <button type="button"
                                                id="modal-add-client-btn"
                                                class="px-3 py-2 bg-gradient-to-r from-teal-500 to-cyan-600 text-white rounded-lg hover:from-teal-600 hover:to-cyan-700 text-sm font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300">
                                            New
                                        </button>
                                    </div>
                                    <div id="modal-client-results" class="mt-3 space-y-2 max-h-32 overflow-y-auto"></div>
                                    <div id="modal-selected-client" class="hidden mt-2 p-3 bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-lg"></div>
                                </div>
                            </div>
                            <!-- Order Summary -->
                            <div class="bg-white shadow-md rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300">
                                <div class="px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600">
                                    <div class="flex items-center">
                                        <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                                            <i class="fas fa-calculator text-white text-sm"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-sm font-semibold text-white">Order Summary</h3>
                                            <p class="text-orange-100 text-xs">Final totals for the order</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <!-- Discount Settings -->
                                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200 mb-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center">
                                                <div class="w-5 h-5 bg-gradient-to-r from-green-400 to-emerald-500 rounded-md flex items-center justify-center mr-2">
                                                    <i class="fas fa-percent text-white text-xs"></i>
                                                </div>
                                                <span class="text-sm font-semibold text-gray-800">Discount Settings</span>
                                            </div>
                                            <div class="flex items-center">
                                                <span id="modal-discount-toggle-status" class="text-xs text-gray-600 mr-2">Off</span>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" id="modal-discount-toggle" class="sr-only peer">
                                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                                                </label>
                                            </div>
                                        </div>
                                        <div id="modal-discount-controls" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3" style="display: none;">
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700 mb-1">Discount Type</label>
                                                <select id="modal-discount-type"
                                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                                                    <option value="fixed" selected>Fixed Amount (UGX)</option>
                                                    <option value="percentage">Percentage (%)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold text-gray-700 mb-1">Discount Value</label>
                                                <input type="number"
                                                       id="modal-discount-value"
                                                       step="1"
                                                       min="0"
                                                       placeholder="e.g. 5000"
                                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                                            </div>
                                        </div>
                                    </div>
                                    <div id="modal-summary" class="space-y-2 text-sm"></div>
                                    <button id="modal-create-btn" class="w-full mt-4 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-700 text-white rounded-lg hover:from-purple-700 hover:to-indigo-800 font-semibold text-sm shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300">
                                        <i class="fas fa-check-circle mr-2"></i>Create Pre-order
                                    </button>
                                    <button id="modal-update-btn" class="w-full mt-4 px-4 py-3 bg-gradient-to-r from-blue-600 to-sky-700 text-white rounded-lg hover:from-blue-700 hover:to-sky-800 font-semibold text-sm shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300 hidden">
                                        <i class="fas fa-save mr-2"></i>Update Pre-order
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Item Discount Modal -->
    <div id="item-discount-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-percent text-white text-xs"></i>
                            </div>
                            <h3 class="text-base font-semibold text-white">Item Discount</h3>
                        </div>
                        <button type="button" onclick="closeItemDiscountModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <div class="bg-gray-50 rounded-lg p-3 mb-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-box text-gray-500 mr-2"></i>
                                <span class="text-sm font-semibold text-gray-800" id="discount-item-name">Product Name</span>
                            </div>
                            <div class="text-xs text-gray-600 space-y-1">
                                <div>Quantity: <span id="discount-item-quantity" class="font-medium">1</span></div>
                                <div>Unit Price: UGX <span id="discount-item-price" class="font-medium">0</span></div>
                                <div>Subtotal: UGX <span id="discount-item-subtotal" class="font-medium">0</span></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">Discount Type</label>
                                <select id="item-discount-type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                                    <option value="fixed">Fixed Amount (UGX)</option>
                                    <option value="percentage">Percentage (%)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">Discount Value</label>
                                <input type="number" id="item-discount-value" step="1" min="0" placeholder="0"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-700">Discount Amount:</span>
                                <span class="font-bold text-green-600" id="calculated-discount">UGX 0</span>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-1">
                                <span class="text-gray-700">Final Price:</span>
                                <span class="font-bold text-gray-900" id="final-item-price">UGX 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="removeItemDiscount()" class="px-3 py-2 text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 rounded-lg transition-all duration-200">
                            <i class="fas fa-trash mr-1"></i>Remove Discount
                        </button>
                        <button type="button" onclick="closeItemDiscountModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                            <i class="fas fa-times mr-1"></i>Cancel
                        </button>
                        <button type="button" onclick="applyItemDiscount()" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-lg transition-all duration-200">
                            <i class="fas fa-check mr-1"></i>Apply Discount
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="add-client-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-teal-500 to-cyan-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-user-plus text-white text-xs"></i>
                            </div>
                            <h3 class="text-base font-semibold text-white">Add New Customer</h3>
                        </div>
                        <button type="button" id="close-client-modal" class="text-white hover:text-gray-200 transition-colors duration-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <form id="add-client-form" class="p-4 space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-user text-gray-400 mr-1"></i>Full Name *
                            </label>
                            <input type="text" id="client-name-input" required
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Enter customer's full name">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-phone text-gray-400 mr-1"></i>Phone Number *
                            </label>
                            <input type="tel" id="client-phone-input" required
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Enter phone number">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>Address
                        </label>
                        <textarea id="client-address-input" rows="2"
                                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                                  placeholder="Enter address (optional)"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-city text-gray-400 mr-1"></i>City
                            </label>
                            <input type="text" id="client-city-input"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Enter city">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                <i class="fas fa-flag text-gray-400 mr-1"></i>Country
                            </label>
                            <input type="text" id="client-country-input"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                                   placeholder="Enter country">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-sticky-note text-gray-400 mr-1"></i>Notes
                        </label>
                        <textarea id="client-notes-input" rows="2"
                                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent transition-all duration-200"
                                  placeholder="Additional notes (optional)"></textarea>
                    </div>
                    <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                        <button type="button" id="cancel-client" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                            Cancel
                        </button>
                        <button type="submit" id="submit-client" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                            <i class="fas fa-user-plus mr-1"></i>Add Customer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- View Pre-order Modal -->
    <div id="view-per-order-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div id="view-per-order-modal-content" class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] transform transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <h3 id="view-per-order-modal-title" class="text-base font-semibold text-white">Pre-order Details</h3>
                        <button type="button" onclick="closeViewPerOrderModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <div id="view-per-order-modal-body" class="p-6 bg-gray-50" style="max-height: calc(90vh - 110px); overflow-y: auto;">
                </div>
                <div id="view-per-order-modal-footer" class="p-4 bg-gray-100 rounded-b-xl border-t border-gray-200 flex justify-end space-x-3">
                </div>
            </div>
        </div>
    </div>
    <!-- Open New Bottle Confirmation Modal -->
    <div id="open-bottle-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                                <i class="fas fa-unlock text-white text-xs"></i>
                            </div>
                            <h3 class="text-base font-semibold text-white">Open New Bottle</h3>
                        </div>
                        <button type="button" onclick="closeOpenBottleModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex items-start mb-4">
                        <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-exclamation-triangle text-orange-600"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-semibold text-gray-900 mb-1">Confirm Opening New Bottle</h4>
                            <p class="text-xs text-gray-600 mb-2">No opened bottle available for decants. Opening a new bottle will:</p>
                            <ul class="text-xs text-gray-600 space-y-1 mb-3">
                                <li>• Reduce bottle stock by 1</li>
                                <li>• Make <span id="new-bottle-decants" class="font-semibold">0</span> decants available</li>
                                <li>• Add 1 decant to your cart</li>
                            </ul>
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-2">
                                <p class="text-xs text-orange-800">
                                    <strong>Product:</strong> <span id="bottle-product-name">-</span><br>
                                    <strong>Bottle Size:</strong> <span id="bottle-size">-</span>ml<br>
                                    <strong>Decant Size:</strong> <span id="decant-size">-</span>ml<br>
                                    <strong>Price per Decant:</strong> UGX <span id="decant-price">-</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" onclick="closeOpenBottleModal()" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                            <i class="fas fa-times mr-1"></i>Cancel
                        </button>
                        <button type="button" onclick="confirmAndOpenBottle()" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 rounded-lg transition-all duration-200">
                            <i class="fas fa-unlock mr-1"></i>Open Bottle & Add Decant
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Items Modal Template -->
    <div id="items-modal-template" class="hidden absolute z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-4 w-80">
        <div class="flex justify-between items-center mb-2">
            <h3 class="items-modal-title text-sm font-semibold text-gray-800">Order Items</h3>
            <button class="items-modal-close-btn text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <ul class="items-modal-list space-y-2">
            <!-- Items will be populated here -->
        </ul>
    </div>

    <!-- Payment Method Modal -->
    <div id="payment-method-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-white">Select Payment Method</h3>
                        <button type="button" onclick="closePaymentMethodModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="selectPaymentMethod('cash')" class="p-4 border rounded-lg hover:bg-gray-100">Cash</button>
                        <button onclick="selectPaymentMethod('card')" class="p-4 border rounded-lg hover:bg-gray-100">Card</button>
                        <button onclick="selectPaymentMethod('mobile_money')" class="p-4 border rounded-lg hover:bg-gray-100">Mobile Money</button>
                        <button onclick="selectPaymentMethod('not_paid')" class="p-4 border rounded-lg hover:bg-gray-100">Not Paid</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Order Modal -->
    <div id="confirm-order-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-white">Confirm Order</h3>
                        <button type="button" onclick="closeConfirmOrderModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <p class="text-sm text-gray-700 mb-4">Are you sure you want to confirm this order? This will create a final order and sale record, and update stock levels.</p>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeConfirmOrderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">Cancel</button>
                        <button type="button" id="confirm-order-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-all duration-200">
                            <i class="fas fa-check-circle mr-2"></i>Confirm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<script>
// Global variables
let cart = [];
let selectedClient = null;
let editingOrderId = null;
let perOrderIdToConfirm = null;
let modalClients = [];
let allOrders = [];
let currentPage = 1;
let totalPages = 1;
let isLoading = false;
let currentItemModalCell = null;
let pendingBottleData = null;
let currentDiscountItemId = null;
let selectedPaymentMethod = null;
let observer = null; // Global variable for IntersectionObserver

// Functions
function openCreatePerOrderModal() {
    document.getElementById('create-per-order-modal').classList.remove('hidden');
    document.getElementById('modal-product-search').addEventListener('input', searchProductsInModal);
    document.getElementById('modal-client-search').addEventListener('input', searchClientsInModal);
    document.getElementById('modal-create-btn').addEventListener('click', createPerOrderFromModal);
    document.getElementById('modal-add-client-btn').addEventListener('click', openAddClientModal);
    document.getElementById('close-client-modal').addEventListener('click', closeAddClientModal);
    document.getElementById('cancel-client').addEventListener('click', closeAddClientModal);
    document.getElementById('add-client-form').addEventListener('submit', addNewClient);
    document.getElementById('modal-discount-toggle').addEventListener('change', toggleModalDiscount);
    document.getElementById('modal-discount-type').addEventListener('change', updateModalSummary);
    document.getElementById('modal-discount-value').addEventListener('input', updateModalSummary);
}

function toggleModalDiscount() {
    const toggle = document.getElementById('modal-discount-toggle');
    const controls = document.getElementById('modal-discount-controls');
    const status = document.getElementById('modal-discount-toggle-status');

    if (toggle.checked) {
        controls.style.display = 'grid';
        status.textContent = 'On';
    } else {
        controls.style.display = 'none';
        status.textContent = 'Off';
        document.getElementById('modal-discount-value').value = '';
    }

    updateModalSummary();
}

function closeCreatePerOrderModal() {
    document.getElementById('create-per-order-modal').classList.add('hidden');
    cart = [];
    selectedClient = null;
    modalClients = [];
    updateModalCartDisplay();
    updateModalSummary();

    // Reset modal to create mode
    document.querySelector('#create-per-order-modal h3').textContent = 'Create New Pre-order';
    document.getElementById('modal-create-btn').classList.remove('hidden');
    document.getElementById('modal-update-btn').classList.add('hidden');
    document.getElementById('modal-update-btn').onclick = null;
    editingOrderId = null; // Reset global variable
}

function openAddClientModal() {
    document.getElementById('add-client-modal').classList.remove('hidden');
}

function closeAddClientModal() {
    document.getElementById('add-client-modal').classList.add('hidden');
    document.getElementById('add-client-form').reset();
}

async function addNewClient(event) {
    event.preventDefault();
    const name = document.getElementById('client-name-input').value.trim();
    const phone = document.getElementById('client-phone-input').value.trim();
    const address = document.getElementById('client-address-input').value.trim();
    const city = document.getElementById('client-city-input').value.trim();
    const country = document.getElementById('client-country-input').value.trim();
    const notes = document.getElementById('client-notes-input').value.trim();

    if (!name || !phone) {
        alert('Full Name and Phone Number are required.');
        return;
    }

    const clientData = { name, phone, address, city, country, notes };

    try {
        const response = await fetch('/api/pos/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(clientData)
        });

        if (response.ok) {
            const newClient = await response.json();
            alert('Customer added successfully!');
            closeAddClientModal();
            modalClients = [newClient];
            selectClientInModal(0);
        } else {
            const errorData = await response.json();
            alert(`Error: ${errorData.detail || 'Failed to add customer'}`);
        }
    } catch (error) {
        console.error('Error adding new client:', error);
        alert('An unexpected error occurred.');
    }
}

async function searchProductsInModal() {
    const query = document.getElementById('modal-product-search').value.trim();
    const resultsContainer = document.getElementById('modal-search-results');
    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        return;
    }
    resultsContainer.innerHTML = `
        <div class="space-y-2">
            <div class="flex items-center justify-center py-4 px-3">
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
                    <span class="text-sm text-gray-600 font-medium">Searching products...</span>
                </div>
            </div>
        </div>
    `;

    try {
        const response = await fetch(`/api/pos/products/search?query=${encodeURIComponent(query)}&limit=10`);
        if (response.ok) {
            const products = await response.json();
            displaySearchResultsInModal(products);
        } else {
            resultsContainer.innerHTML = '<div class="text-center py-4 px-3 text-red-500">Error searching products</div>';
        }
    } catch (error) {
        console.error('Product search error:', error);
        resultsContainer.innerHTML = '<div class="text-center py-4 px-3 text-red-500">Error searching products</div>';
    }
}

function displaySearchResultsInModal(products) {
    const resultsContainer = document.getElementById('modal-search-results');
    if (!products || products.length === 0) {
        resultsContainer.innerHTML = '<div class="text-center py-4 px-3 text-gray-500">No products found</div>';
        return;
    }

    resultsContainer.innerHTML = products.map(product => {
        if (product.is_perfume_with_decants && product.decant) {
            let decantOption = '';
            if (product.has_opened_bottle && product.opened_bottle_decants > 0) {
                decantOption = `
                    <div class="group bg-white hover:bg-purple-50 cursor-pointer border border-gray-200 rounded-lg p-2" onclick="addToCart('${product.id}', '${product.name.replace(/'/g, "\'") } (${product.decant.decant_size_ml}ml Decant)', ${product.decant.decant_price}, '${product.sku}-DECANT', ${product.opened_bottle_decants}, true)">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-vial text-purple-500 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Decant (${product.decant.decant_size_ml}ml)</p>
                                    <p class="text-xs text-green-600">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        ${product.opened_bottle_decants} decants from opened bottle
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-sm text-purple-600">UGX ${product.decant.decant_price.toLocaleString()}</p>
                                <button class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-2 py-1 rounded text-xs font-medium">
                                    <i class="fas fa-plus mr-1"></i>Add Decant
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (product.can_open_new_bottle) {
                decantOption = `
                    <div class="group bg-white hover:bg-orange-50 cursor-pointer border border-orange-200 rounded-lg p-2" onclick="confirmOpenNewBottle('${product.id}', '${product.name.replace(/'/g, "\'") }', ${product.bottle_size_ml}, ${product.decant.decant_size_ml}, ${product.decant.decant_price})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-unlock text-orange-500 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Open New Bottle for Decants</p>
                                    <p class="text-xs text-orange-600">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        No opened bottle
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-sm text-orange-600">UGX ${product.decant.decant_price.toLocaleString()}</p>
                                <button class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-2 py-1 rounded text-xs font-medium">
                                    <i class="fas fa-unlock mr-1"></i>Open & Add
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            let fullBottleOption = '';
            if (product.stock_quantity > 0) {
                fullBottleOption = `
                    <div class="group bg-white hover:bg-blue-50 cursor-pointer border border-gray-200 rounded-lg p-2" onclick='addToCart("${product.id}", "${product.name.replace(/'/g, "\'") } (Full Bottle)", ${product.price}, "${product.sku}", ${product.stock_quantity}, false)'>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-wine-bottle text-blue-500 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Full Bottle (${product.bottle_size_ml}ml)</p>
                                    <p class="text-xs text-gray-500">${product.stock_quantity} bottles available</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-sm text-blue-600">UGX ${product.price.toLocaleString()}</p>
                                <button class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-2 py-1 rounded text-xs font-medium">
                                    <i class="fas fa-plus mr-1"></i>Add Bottle
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                fullBottleOption = `
                    <div class="group bg-gray-100 border border-gray-200 rounded-lg p-2 opacity-50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-wine-bottle text-gray-400 mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Full Bottle (${product.bottle_size_ml}ml)</p>
                                    <p class="text-xs text-red-500">Out of Stock</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-gray-50 rounded-lg p-2 space-y-2">
                    <p class="font-semibold text-sm text-gray-900">${product.name}</p>
                    ${fullBottleOption}
                    ${decantOption}
                </div>
            `;
        }

        return `
            <div class="group bg-gray-50 hover:bg-blue-50 border border-gray-200 rounded-lg p-3 cursor-pointer" onclick='addToCart("${product.id}", "${product.name.replace(/'/g, "\'") }", ${product.price}, "${product.sku}", ${product.stock_quantity}, false)'>
                <div class="flex justify-between items-center">
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-gray-800 group-hover:text-blue-800">${product.name || 'Unnamed Product'}</p>
                        <p class="text-xs text-gray-500">${product.sku || ''}</p>
                        <p class="text-xs text-gray-500">${product.stock_quantity} ${product.unit || 'pcs'}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm text-blue-600 mb-1">UGX ${product.price.toLocaleString()}</p>
                        <button class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-3 py-1 rounded-lg text-xs font-medium shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105">
                            Add
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function searchClientsInModal() {
    const query = document.getElementById('modal-client-search').value.trim();
    const resultsContainer = document.getElementById('modal-client-results');
    if (query.length < 2) {
        resultsContainer.innerHTML = '';
        modalClients = [];
        return;
    }
    resultsContainer.innerHTML = `
        <div class="space-y-2">
            <!-- Skeleton loading items -->
            ${Array(2).fill(0).map(() => `
                <div class="bg-white border border-gray-200 rounded-lg p-3 animate-pulse">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gray-200 rounded-full"></div>
                        <div class="flex-1">
                            <div class="h-4 bg-gray-200 rounded w-3/4 mb-1"></div>
                            <div class="h-3 bg-gray-200 rounded w-1/2"></div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    const response = await fetch(`/api/pos/customers/search?query=${query}&limit=5`);
    const data = await response.json();
    modalClients = data.customers;
    resultsContainer.innerHTML = modalClients.map((c, index) => `
        <div class="group bg-gradient-to-r from-teal-50 to-cyan-50 hover:from-teal-100 hover:to-cyan-100 border border-teal-200 hover:border-teal-300 rounded-xl p-3 cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md transform hover:-translate-y-0.5" onclick='selectClientInModal(${index})'>
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-r from-teal-500 to-cyan-600 rounded-lg flex items-center justify-center mr-3 shadow-sm">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-sm text-gray-900 group-hover:text-teal-900 mb-1">${c.name}</p>
                    <div class="flex items-center text-xs text-gray-600">
                        ${c.phone ? `
                        <span class="flex items-center mr-3">
                            <i class="fas fa-phone text-gray-400 mr-1"></i>
                            ${c.phone}
                        </span>
                        ` : ''}
                    </div>
                </div>
                <div class="text-teal-600 group-hover:text-teal-700">
                    <i class="fas fa-chevron-right text-xs"></i>
                </div>
            </div>
        </div>
    `).join('');
}

function selectClientInModal(index) {
    const client = modalClients[index];
    selectedClient = client;
    document.getElementById('modal-selected-client').innerHTML = `
        <div class="flex justify-between items-center">
            <div>
                <p class="font-semibold text-teal-900 text-sm">${client.name}</p>
                <p class="text-xs text-teal-600">${client.phone || ''}</p>
            </div>
            <button type="button" onclick="unselectClient()" class="w-6 h-6 bg-teal-200 hover:bg-teal-300 rounded-md flex items-center justify-center text-teal-600 transition-colors duration-200">
                <i class="fas fa-times text-xs"></i>
            </button>
        </div>
    `;
    document.getElementById('modal-selected-client').classList.remove('hidden');
    document.getElementById('modal-client-results').innerHTML = '';
    document.getElementById('modal-client-search').value = '';
    modalClients = [];
}

function unselectClient() {
    selectedClient = null;
    document.getElementById('modal-selected-client').innerHTML = '';
    document.getElementById('modal-selected-client').classList.add('hidden');
}

function addToCart(id, name, price, sku, stock, isDecant) {
    const cartItemId = isDecant ? `${id}-DECANT` : id;
    const existingItem = cart.find(item => item.cartItemId === cartItemId);
    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({ id, name, price, sku, quantity: 1, stock, isDecant, cartItemId, discount_amount: 0, discount_type: 'fixed', discount_value: 0 });
    }
    updateModalCartDisplay();
    updateModalSummary();
}

function updateModalCartDisplay() {
    const cartContainer = document.getElementById('modal-cart-items');

    if (cart.length === 0) {
        cartContainer.innerHTML = `
            <div class="text-center py-6 text-gray-500">
                <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                <p class="text-sm">Cart is empty</p>
            </div>
        `;
        return;
    }

    cartContainer.innerHTML = cart.map(item => {
        const isDecant = item.isDecant || false;
        const iconClass = isDecant ? 'fas fa-vial' : 'fas fa-box';
        const bgColor = isDecant ? 'from-purple-500 to-pink-600' : 'from-blue-500 to-indigo-600';

        return `
        <div class="group bg-white hover:bg-gray-50 border border-gray-200 rounded-xl p-3 transition-all duration-200 shadow-sm">
            <div class="flex items-center justify-between">
                <div class="flex items-center flex-1 mr-3">
                    <div class="w-8 h-8 bg-gradient-to-r ${bgColor} rounded-lg flex items-center justify-center mr-3 shadow-sm">
                        <i class="${iconClass} text-white text-xs"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-gray-900 mb-1">${item.name}</p>
                        <div class="flex items-center space-x-3 text-xs text-gray-600">
                            <span class="flex items-center">
                                <i class="fas fa-tag text-gray-400 mr-1"></i>
                                UGX ${item.price.toLocaleString()}
                            </span>
                            ${isDecant ? '<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs">Decant</span>' : ''}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center bg-white rounded-lg border border-gray-300 shadow-sm">
                        <button onclick="updateQuantityInModal('${item.cartItemId}', ${item.quantity - 1})" class="w-7 h-7 text-gray-600 hover:bg-gray-100 rounded-l-lg text-xs font-medium transition-all duration-200 flex items-center justify-center"><i class="fas fa-minus"></i></button>
                        <span class="text-sm font-bold px-3 py-1 bg-white text-gray-900 min-w-[2rem] text-center">${item.quantity}</span>
                        <button onclick="updateQuantityInModal('${item.cartItemId}', ${item.quantity + 1})" class="w-7 h-7 text-gray-600 hover:bg-gray-100 rounded-r-lg text-xs font-medium transition-all duration-200 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                    </div>
                    <button onclick="removeFromCartInModal('${item.cartItemId}')" class="w-7 h-7 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-xs font-medium transition-all duration-200 flex items-center justify-center" title="Remove item"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <div class="mt-2 pt-2 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <button onclick="toggleItemDiscount('${item.cartItemId}')" class="text-xs px-2 py-1 rounded-md transition-all duration-200 ${item.discount_amount > 0 ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-gray-100 text-gray-600 border border-gray-300'} hover:bg-green-200">
                        <i class="fas fa-percent mr-1"></i>
                        ${item.discount_amount > 0 ? 'Edit Discount' : 'Add Discount'}
                    </button>
                    <div class="text-right">
                        ${item.discount_amount > 0 ? `
                        <div class="text-xs text-gray-500 line-through">UGX ${(item.price * item.quantity).toLocaleString()}</div>
                        <div class="text-sm font-bold text-gray-800">UGX ${((item.price * item.quantity) - item.discount_amount).toLocaleString()}</div>
                        ` : `
                        <div class="text-sm font-bold text-gray-800">UGX ${(item.price * item.quantity).toLocaleString()}</div>
                        `}
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function updateQuantityInModal(cartItemId, newQuantity) {
    if (newQuantity <= 0) {
        removeFromCartInModal(cartItemId);
        return;
    }
    const item = cart.find(item => item.cartItemId === cartItemId);
    if (item) {
        if (item.stock !== undefined && newQuantity > item.stock) {
            alert(`Cannot add more ${item.name}. Only ${item.stock} available.`);
            return;
        }
        item.quantity = newQuantity;
        updateModalCartDisplay();
        updateModalSummary();
    }
}

function removeFromCartInModal(cartItemId) {
    cart = cart.filter(item => item.cartItemId !== cartItemId);
    updateModalCartDisplay();
    updateModalSummary();
}

function updateModalSummary() {
    const summaryContainer = document.getElementById('modal-summary');
    const subtotal = cart.reduce((acc, item) => acc + item.price * item.quantity, 0);
    const itemDiscounts = cart.reduce((acc, item) => acc + (item.discount_amount || 0), 0);

    const discountToggle = document.getElementById('modal-discount-toggle');
    const discountType = document.getElementById('modal-discount-type').value;
    const discountValue = parseFloat(document.getElementById('modal-discount-value').value) || 0;

    let orderDiscount = 0;
    if (discountToggle.checked && discountValue > 0) {
        const discountableAmount = subtotal - itemDiscounts;
        if (discountType === 'percentage') {
            orderDiscount = (discountableAmount * discountValue) / 100;
        } else {
            orderDiscount = Math.min(discountValue, discountableAmount);
        }
    }

    const totalDiscount = itemDiscounts + orderDiscount;
    const total = subtotal - totalDiscount;

    summaryContainer.innerHTML = `
        <div class="space-y-3">
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                <span class="text-gray-600 text-sm font-medium">Subtotal:</span>
                <span class="font-semibold text-gray-900 text-sm">UGX ${subtotal.toLocaleString()}</span>
            </div>
            <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                <span class="text-gray-600 text-sm font-medium">Discount:</span>
                <span class="font-semibold text-green-600 text-sm">UGX ${totalDiscount.toLocaleString()}</span>
            </div>
            <div class="border-t border-gray-200 pt-3">
                <div class="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg">
                    <span class="text-base font-bold text-gray-900">Total:</span>
                    <span class="text-lg font-bold text-blue-600">UGX ${total.toLocaleString()}</span>
                </div>
            </div>
        </div>
    `;
}

async function createPerOrderFromModal() {
    if (cart.length === 0) {
        alert('Cart is empty');
        return;
    }

    const subtotal = cart.reduce((acc, item) => acc + item.price * item.quantity, 0);
    const itemDiscounts = cart.reduce((acc, item) => acc + (item.discount_amount || 0), 0);

    const discountToggle = document.getElementById('modal-discount-toggle');
    const discountType = document.getElementById('modal-discount-type').value;
    const discountValue = parseFloat(document.getElementById('modal-discount-value').value) || 0;

    let orderDiscount = 0;
    if (discountToggle.checked && discountValue > 0) {
        const discountableAmount = subtotal - itemDiscounts;
        if (discountType === 'percentage') {
            orderDiscount = (discountableAmount * discountValue) / 100;
        } else {
            orderDiscount = Math.min(discountValue, discountableAmount);
        }
    }

    const totalDiscount = itemDiscounts + orderDiscount;

    const perOrderData = {
        customer_id: selectedClient ? selectedClient.id : null,
        customer_name: selectedClient ? selectedClient.name : "Walk-in Customer",
        customer_phone: selectedClient ? selectedClient.phone : null,
        items: cart.map(item => ({
            product_id: item.id,
            product_name: item.name,
            product_sku: item.sku,
            quantity: item.quantity,
            unit_price: item.price,
            total_price: item.price * item.quantity,
            discount_amount: item.discount_amount || 0,
            tax_amount: 0,
            is_decant: item.isDecant
        })),
        shipping_cost: 0,
        discount_total: totalDiscount
    };

    const response = await fetch('/api/per-order/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(perOrderData)
    });

    if (response.ok) {
        const newPerOrder = await response.json();
        window.location.href = `/per-order/${newPerOrder.id}`;
    } else {
        alert('Failed to create pre-order');
    }
}

function printOrder() {
    window.print();
}

function editPerOrder() {
    window.location.href = '/per-order?edit={{ per_order._id }}';
}

function confirmOpenNewBottle(productId, productName, bottleSizeMl, decantSizeMl, decantPrice) {
    pendingBottleData = { productId, productName, bottleSizeMl, decantSizeMl, decantPrice };
    document.getElementById('bottle-product-name').textContent = productName;
    document.getElementById('bottle-size').textContent = bottleSizeMl;
    document.getElementById('decant-size').textContent = decantSizeMl;
    document.getElementById('decant-price').textContent = decantPrice.toLocaleString();
    document.getElementById('new-bottle-decants').textContent = Math.floor(bottleSizeMl / decantSizeMl);
    document.getElementById('open-bottle-modal').classList.remove('hidden');
}

function closeOpenBottleModal() {
    document.getElementById('open-bottle-modal').classList.add('hidden');
    pendingBottleData = null;
}

async function confirmAndOpenBottle() {
    if (!pendingBottleData) return; 
    
    const response = await fetch(`/api/products/${pendingBottleData.productId}/open-bottle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });

    if (response.ok) {
        const decantName = `${pendingBottleData.productName} (${pendingBottleData.decantSizeMl}ml Decant)`;
        const decantSku = `${pendingBottleData.productId}-DECANT`;
        const decantStock = Math.floor(pendingBottleData.bottleSizeMl / pendingBottleData.decantSizeMl);
        addToCart(pendingBottleData.productId, decantName, pendingBottleData.decantPrice, decantSku, decantStock, true);
        closeOpenBottleModal();
    } else {
        alert('Failed to open new bottle');
    }
    pendingBottleData = null;
}

function toggleItemDiscount(cartItemId) {
    const item = cart.find(item => item.cartItemId === cartItemId);
    if (!item) return;

    currentDiscountItemId = cartItemId;

    document.getElementById('discount-item-name').textContent = item.name;
    document.getElementById('discount-item-quantity').textContent = item.quantity;
    document.getElementById('discount-item-price').textContent = item.price.toLocaleString();
    document.getElementById('discount-item-subtotal').textContent = (item.price * item.quantity).toLocaleString();

    if (item.discount_value > 0) {
        document.getElementById('item-discount-type').value = item.discount_type || 'fixed';
        document.getElementById('item-discount-value').value = item.discount_value;
    } else {
        document.getElementById('item-discount-type').value = 'fixed';
        document.getElementById('item-discount-value').value = '';
    }

    document.getElementById('item-discount-type').addEventListener('change', calculateItemDiscount);
    document.getElementById('item-discount-value').addEventListener('input', calculateItemDiscount);

    calculateItemDiscount();

    document.getElementById('item-discount-modal').classList.remove('hidden');
}

function calculateItemDiscount() {
    if (!currentDiscountItemId) return;
    const item = cart.find(item => item.cartItemId === currentDiscountItemId);
    if (!item) return;

    const discountType = document.getElementById('item-discount-type').value;
    const discountValue = parseFloat(document.getElementById('item-discount-value').value) || 0;
    const itemSubtotal = item.price * item.quantity;

    let discountAmount = 0;
    if (discountValue > 0) {
        if (discountType === 'percentage') {
            discountAmount = Math.min((itemSubtotal * discountValue) / 100, itemSubtotal);
        } else {
            discountAmount = Math.min(discountValue, itemSubtotal);
        }
    }

    const finalPrice = itemSubtotal - discountAmount;

    document.getElementById('calculated-discount').textContent = `UGX ${Math.round(discountAmount).toLocaleString()}`;
    document.getElementById('final-item-price').textContent = `UGX ${Math.round(finalPrice).toLocaleString()}`;
}

function applyItemDiscount() {
    if (!currentDiscountItemId) return;
    const item = cart.find(item => item.cartItemId === currentDiscountItemId);
    if (!item) return;

    const discountType = document.getElementById('item-discount-type').value;
    const discountValue = parseFloat(document.getElementById('item-discount-value').value) || 0;
    const itemSubtotal = item.price * item.quantity;

    let discountAmount = 0;
    if (discountValue > 0) {
        if (discountType === 'percentage') {
            discountAmount = Math.min((itemSubtotal * discountValue) / 100, itemSubtotal);
        } else {
            discountAmount = Math.min(discountValue, itemSubtotal);
        }
    }

    item.discount_amount = discountAmount;

    updateModalCartDisplay();
    updateModalSummary();
    closeItemDiscountModal();
}

function removeItemDiscount() {
    if (!currentDiscountItemId) return;
    const item = cart.find(item => item.cartItemId === currentDiscountItemId);
    if (item) {
        item.discount_amount = 0;
        item.discount_type = 'fixed';
        item.discount_value = 0;
        updateModalCartDisplay();
        updateModalSummary();
    }
    closeItemDiscountModal();
}

function closeItemDiscountModal() {
    document.getElementById('item-discount-modal').classList.add('hidden');
    currentDiscountItemId = null;
    document.getElementById('item-discount-type').removeEventListener('change', calculateItemDiscount);
    document.getElementById('item-discount-value').removeEventListener('input', calculateItemDiscount);
    document.getElementById('item-discount-value').value = '';
    document.getElementById('calculated-discount').textContent = 'UGX 0';
    document.getElementById('final-item-price').textContent = 'UGX 0';
}

function openPaymentMethodModal(orderId) {
    perOrderIdToConfirm = orderId;
    document.getElementById('payment-method-modal').classList.remove('hidden');
}

function closePaymentMethodModal() {
    document.getElementById('payment-method-modal').classList.add('hidden');
}

function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    closePaymentMethodModal();
    openConfirmOrderModal();
}

function openConfirmOrderModal() {
    document.getElementById('confirm-order-modal').classList.remove('hidden');
    document.getElementById('confirm-order-btn').addEventListener('click', confirmOrder);
}

function closeConfirmOrderModal() {
    document.getElementById('confirm-order-modal').classList.add('hidden');
    document.getElementById('confirm-order-btn').removeEventListener('click', confirmOrder);
    perOrderIdToConfirm = null;
    selectedPaymentMethod = null;
}

async function confirmOrder() {
    console.log('confirmOrder function called'); // New log
    if (!perOrderIdToConfirm) {
        console.error('Error: perOrderIdToConfirm is not set.'); // New log
        alert('Error: No order selected for confirmation.');
        return;
    }
    console.log(`Confirming order with ID: ${perOrderIdToConfirm}`); // New log

    const data = {
        payment_method: selectedPaymentMethod
    };
    console.log('Sending data:', data); // New log

    try {
        // This endpoint is an assumption based on REST principles.
        const response = await fetch(`/api/per-order/${perOrderIdToConfirm}/confirm`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        console.log('Received response:', response); // New log

        if (response.ok) {
            console.log('Order confirmed successfully'); // New log
            alert('Order confirmed successfully!');
            window.location.reload();
        } else {
            const errorData = await response.json();
            console.error('Failed to confirm order:', errorData); // New log
            alert(`Error: ${errorData.detail || 'Failed to confirm order'}`);
        }
    } catch (error) {
        console.error('Error confirming order:', error);
        alert('An unexpected error occurred during confirmation.');
    } finally {
        console.log('Closing confirm order modal'); // New log
        closeConfirmOrderModal();
    }
}

function openEditPerOrderModal(orderId) {
    console.log(`DEBUG: openEditPerOrderModal called with orderId: ${orderId}`);
    const order = allOrders.find(o => o.id === orderId);
    if (!order) {
        console.error('Order not found for editing. Searching for ID:', orderId);
        alert('Order not found for editing.');
        return;
    }
    editingOrderId = order.id; // Set global for the update function

    closeViewPerOrderModal();

    // Populate cart
    cart = order.items.map(item => ({
        id: item.product_id,
        name: item.product_name,
        price: item.unit_price,
        sku: item.product_sku,
        quantity: item.quantity,
        stock: undefined, // Stock info is not available on the order object
        isDecant: item.product_name.includes('Decant'), // Infer from name
        cartItemId: item.product_name.includes('Decant') ? `${item.product_id}-DECANT` : item.product_id,
        discount_amount: item.discount_amount || 0,
        discount_type: item.discount_type || 'fixed',
        discount_value: item.discount_value || 0
    }));

    // Populate client
    if (order.customer_id) {
        selectedClient = {
            id: order.customer_id,
            name: order.customer_name,
            phone: order.customer_phone
        };
        const selectedClientDiv = document.getElementById('modal-selected-client');
        if (selectedClientDiv) {
            selectedClientDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-teal-900 text-sm">${selectedClient.name}</p>
                        <p class="text-xs text-teal-600">${selectedClient.phone || ''}</p>
                    </div>
                    <button type="button" onclick="unselectClient()" class="w-6 h-6 bg-teal-200 hover:bg-teal-300 rounded-md flex items-center justify-center text-teal-600 transition-colors duration-200">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `;
            selectedClientDiv.classList.remove('hidden');
        } else {
            alert("Debug Error: The 'modal-selected-client' element was not found.");
            return;
        }
    } else {
        selectedClient = null;
    }

    // Update modal for "Edit" mode
    const modalTitle = document.querySelector('#create-per-order-modal h3');
    if (modalTitle) {
        modalTitle.textContent = 'Edit Pre-order';
    } else {
        alert("Debug Error: The modal title element could not be found.");
        return;
    }

    const createBtn = document.getElementById('modal-create-btn');
    if (createBtn) {
        createBtn.classList.add('hidden');
    } else {
        alert("Debug Error: The 'modal-create-btn' element was not found.");
        return;
    }

    const updateButton = document.getElementById('modal-update-btn');
    if (updateButton) {
        updateButton.classList.remove('hidden');
        updateButton.dataset.orderId = orderId; // Store ID on the button
        updateButton.onclick = updatePerOrderFromModal; // Set handler without closure
    } else {
        alert("Debug Error: The 'modal-update-btn' element was not found.");
        return;
    }

    openCreatePerOrderModal();
    
    // Refresh displays
    updateModalCartDisplay();
    updateModalSummary();
}

async function updatePerOrderFromModal() {
    const updateButton = document.getElementById('modal-update-btn');
    const orderId = updateButton.dataset.orderId;

    if (!orderId) {
        alert('Error: Could not find Order ID to update.');
        return;
    }

    if (cart.length === 0) {
        alert('Cart cannot be empty');
        return;
    }

    const subtotal = cart.reduce((acc, item) => acc + item.price * item.quantity, 0);
    const itemDiscounts = cart.reduce((acc, item) => acc + (item.discount_amount || 0), 0);

    const discountToggle = document.getElementById('modal-discount-toggle');
    const discountType = document.getElementById('modal-discount-type').value;
    const discountValue = parseFloat(document.getElementById('modal-discount-value').value) || 0;

    let orderDiscount = 0;
    if (discountToggle.checked && discountValue > 0) {
        const discountableAmount = subtotal - itemDiscounts;
        if (discountType === 'percentage') {
            orderDiscount = (discountableAmount * discountValue) / 100;
        } else {
            orderDiscount = Math.min(discountValue, discountableAmount);
        }
    }

    const totalDiscount = itemDiscounts + orderDiscount;

    const perOrderData = {
        customer_name: selectedClient ? selectedClient.name : "Walk-in Customer",
        customer_phone: selectedClient ? selectedClient.phone : null,
        items: cart.map(item => ({
            product_id: item.id,
            product_name: item.name,
            product_sku: item.sku,
            quantity: item.quantity,
            unit_price: item.price,
            total_price: item.price * item.quantity,
            discount_amount: item.discount_amount || 0,
            tax_amount: 0
        })),
        order_discount: orderDiscount,
        shipping_cost: 0
    };

    const response = await fetch(`/api/per-order/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(perOrderData)
    });

    if (response.ok) {
        alert('Pre-order updated successfully!');
        window.location.reload();
    } else {
        alert('Failed to update pre-order');
    }
}

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

function clickOutsideHandler(event) {
    const modal = document.getElementById('items-modal-instance');
    // If the modal exists and the click was outside of it
    if (modal && !modal.contains(event.target)) {
        hideItemsModal();
    }
}

function showOrderLoadingIndicator(rows = 5) {
    const tableBody = document.querySelector('#per-orders-table-body');
    if (!tableBody) return;

    const skeletonRow = `
        <tr class="animate-pulse">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gray-300 rounded-lg mr-3"></div>
                    <div class="flex flex-col space-y-1">
                        <div class="h-4 bg-gray-300 rounded w-24"></div>
                        <div class="h-3 bg-gray-300 rounded w-16"></div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="space-y-1">
                    <div class="h-4 bg-gray-300 rounded w-32"></div>
                    <div class="h-3 bg-gray-300 rounded w-24"></div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="h-4 bg-gray-300 rounded w-16"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="h-4 bg-gray-300 rounded w-24 font-bold"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="h-6 bg-gray-300 rounded-full w-24"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="h-4 bg-gray-300 rounded w-24"></div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
                <div class="flex items-center justify-end space-x-2">
                    <div class="h-8 w-8 bg-gray-300 rounded-lg"></div>
                    <div class="h-8 w-8 bg-gray-300 rounded-lg"></div>
                    <div class="h-8 w-8 bg-gray-300 rounded-lg"></div>
                </div>
            </td>
        </tr>
    `;

    tableBody.innerHTML = skeletonRow.repeat(rows);
}

function loadOrders(page = 1, append = false) {
    if (isLoading) return;
    isLoading = true;

    if (!append) {
        // Disconnect observer on initial load or filter change
        if (observer) {
            observer.disconnect();
            observer = null;
        }
        showOrderLoadingIndicator();
    } else {
        const loadingMessage = document.querySelector('#loading-message');
        if (loadingMessage) {
            loadingMessage.style.display = 'block';
        }
    }

    const params = new URLSearchParams({
        page: page,
        size: 10
    });

    const search = document.getElementById('search-orders').value;
    const status = document.getElementById('status-filter').value;
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;

    if (search) params.append('search', search);
    if (status) params.append('status', status);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);

    fetch(`/api/per-order/?${params.toString()}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to load orders');
    })
    .then(data => {
        currentPage = data.page;
        totalPages = data.total_pages;

        if (append) {
            allOrders = [...allOrders, ...(data.orders || [])];
        } else {
            allOrders = data.orders || [];
        }

        displayOrders(allOrders, data.total, currentPage, totalPages);

        if (!append) {
            loadOrderStats();
        }
    })
    .catch(error => {
        console.error('Error loading orders:', error);
    })
    .finally(() => {
        isLoading = false;
        const loadingMessage = document.querySelector('#loading-message');
        const endMessage = document.querySelector('#end-message');

        if (loadingMessage) {
            loadingMessage.style.display = 'none';
        }
        if (endMessage) {
            endMessage.style.display = currentPage >= totalPages && allOrders.length > 0 ? 'block' : 'none';
        }
    });
}

function displayOrders(orders, total = 0, page = 1, totalPages = 1) {
    const tableBody = document.querySelector('#per-orders-table-body');
    const ordersCount = document.querySelector('#orders-count');
    const paginationInfo = document.querySelector('#pagination-info');

    if (!tableBody) return;

    // Clear table before rendering all accumulated orders
    tableBody.innerHTML = '';

    if (ordersCount) {
        ordersCount.textContent = `${total} order${total !== 1 ? 's' : ''} (showing ${orders.length})`;
    }

    if (paginationInfo) {
        paginationInfo.textContent = `Page ${page} of ${totalPages}`;
    }

    if (orders.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-shopping-cart text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No orders found</h3>
                        <p class="text-sm text-gray-500">Orders will appear here when created.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    const rowsHtml = orders.map(order => {
        return `
        <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-receipt text-white text-xs"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-semibold text-gray-900">${order.order_number}</span>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div>
                            <div class="text-sm font-semibold text-gray-900">${order.customer_name}</div>
                            ${order.customer_phone ? `<div class="text-xs text-gray-500"><a href="tel:${order.customer_phone}" class="text-blue-600 hover:underline">${order.customer_phone}</a></div>` : ''}                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="relative">
                    <button onclick="showItemsModal(event, '${order.id}')" class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded-lg">
                        <div class="w-6 h-6 bg-gray-100 rounded-md flex items-center justify-center mr-2">
                            <i class="fas fa-box text-gray-600 text-xs"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-900">${order.items.length} item${order.items.length !== 1 ? 's' : ''}</span>
                    </button>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm font-bold text-gray-900">UGX ${Math.round(order.total_amount).toLocaleString('en-UG')}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${getStatusClass(order.status)} w-fit">
                    ${getStatusText(order.status)}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="flex items-center">
                    <i class="fas fa-calendar text-gray-400 mr-2 text-xs"></i>
                    ${new Date(order.created_at).toLocaleDateString()}
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
                <div class="flex items-center justify-end space-x-2">
                    <button onclick="openViewPerOrderModal('${order._id}')" class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-all duration-200" title="View Order">
                        <i class="fas fa-eye text-sm"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
    tableBody.insertAdjacentHTML('beforeend', rowsHtml);

    // Disconnect previous observer if exists
    if (observer) {
        observer.disconnect();
    }

    // If there are more pages, observe the last item
    if (currentPage < totalPages) {
        const lastRow = tableBody.lastElementChild; // Get the last <tr>
        if (lastRow) {
            observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !isLoading) {
                    loadOrders(currentPage + 1, true);
                }
            }, {
                root: null, // Use the viewport as the root
                rootMargin: '0px',
                threshold: 0.1 // Trigger when 10% of the item is visible
            });
            observer.observe(lastRow);
        }
    }
}

function getStatusClass(status) {
    switch(status) {
        case 'delivered': return 'bg-green-100 text-green-800';
        case 'processing': return 'bg-blue-100 text-blue-800';
        case 'pending': return 'bg-yellow-100 text-yellow-800';
        case 'cancelled': return 'bg-red-100 text-red-800';
        case 'returned': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getStatusText(status) {
    return status.charAt(0).toUpperCase() + status.slice(1);
}

function openViewPerOrderModal(orderId) {
    const modal = document.getElementById('view-per-order-modal');
    const modalBody = document.getElementById('view-per-order-modal-body');
    const order = allOrders.find(o => String(o.id) === orderId);

    if (order) {
        console.log('DEBUG: Found order in openViewPerOrderModal:', order);
        document.getElementById('view-per-order-modal-title').textContent = `Per Order Details: ${order.order_number}`;

        let itemsHtml = '';
        for (const item of order.items) {
            const itemDiscount = item.discount_amount || 0;
            const finalPrice = item.total_price - itemDiscount;
            itemsHtml += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-gray-900">${item.product_name}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.quantity}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">UGX ${item.unit_price.toLocaleString()}</td>
                    <td class="px-6 py-4 text-sm text-red-600">UGX ${itemDiscount.toLocaleString()}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">UGX ${finalPrice.toLocaleString()}</td>
                </tr>
            `;
        }

        modalBody.innerHTML = `
            <div class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-user text-blue-500 mr-2"></i>
                            Customer Information
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Name</label>
                                <p class="text-gray-900 font-medium">${order.customer_name || 'Walk-in Customer'}</p>
                            </div>
                            ${order.customer_email ? `
                            <div>
                                <label class="text-sm font-medium text-gray-600">Email</label>
                                <p class="text-gray-900">${order.customer_email}</p>
                            </div>
                            ` : ''}
                            ${order.customer_phone ? `
                            <div>
                                <label class="text-sm font-medium text-gray-600">Phone</label>
                                <p class="text-gray-900">${order.customer_phone}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-receipt text-green-500 mr-2"></i>
                            Order Summary
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="font-medium">UGX ${order.subtotal.toLocaleString()}</span>
                            </div>
                            ${order.tax_total > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-gray-600">Tax</span>
                                <span class="font-medium">UGX ${order.tax_total.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            ${order.discount_total > 0 ? `
                            <div class="flex justify-between text-red-600">
                                <span>Discount</span>
                                <span class="font-medium">-UGX ${order.discount_total.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            <div class="border-t pt-2">
                                <div class="flex justify-between text-lg font-bold">
                                    <span>Total</span>
                                    <span>UGX ${order.total_amount.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-shopping-cart text-indigo-500 mr-2"></i>
                            Order Items (${order.items.length})
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${itemsHtml}
                            </tbody>
                            <tfoot class="bg-gray-100 font-semibold">
                                <tr>
                                    <td colspan="3" class="px-6 py-3 text-right text-gray-800">Total</td>
                                    <td class="px-6 py-3 text-red-600">UGX ${order.items.reduce((acc, item) => acc + (item.discount_amount || 0), 0).toLocaleString()}</td>
                                    <td class="px-6 py-3 text-gray-900">UGX ${(order.items.reduce((acc, item) => acc + item.total_price, 0) - order.items.reduce((acc, item) => acc + (item.discount_amount || 0), 0)).toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        `;

        const modalFooter = document.getElementById('view-per-order-modal-footer');
        const allowedToModify = ['pending', 'processing', 'shipped'];
        if (allowedToModify.includes(order.status)) {
            modalFooter.innerHTML = `
                <button type="button" onclick="openEditPerOrderModal('${order.id}')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg"><i class="fas fa-edit mr-2"></i>Edit</button>
                <button type="button" onclick="closeViewPerOrderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg">Close</button>
                <button type="button" onclick="openPaymentMethodModal('${order.id}')" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>Confirm Order
                </button>
            `;
        } else {
            modalFooter.innerHTML = `
                <button type="button" onclick="closeViewPerOrderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg">Close</button>
            `;
        }

        modal.classList.remove('hidden');
    } else {
        alert('Order not found!');
    }
}

function closeViewPerOrderModal() {
    const modal = document.getElementById('view-per-order-modal');
    modal.classList.add('hidden');
}

function showItemsModal(event, orderId) {
    event.stopPropagation();
    console.log(`DEBUG: showItemsModal called with orderId: ${orderId}`);

    // Hide any existing modal first
    hideItemsModal();

    const order = allOrders.find(o => String(o._id) === orderId);
    console.log('DEBUG: Found order in showItemsModal:', order);
    if (!order) return;
    const items = order.items;

    const template = document.getElementById('items-modal-template');
    if (!template) return;

    const modal = template.cloneNode(true);
    modal.id = 'items-modal-instance'; // Give it a unique ID
    modal.classList.remove('hidden');

    // Update modal title
    const titleElement = modal.querySelector('.items-modal-title');
    if (titleElement) {
        titleElement.textContent = `Order #${order.order_number}`;
    }

    const cell = event.currentTarget.closest('td');
    if (!cell) return;

    // Keep track of the cell and set its position
    currentItemModalCell = cell;
    cell.style.position = 'relative';
    cell.appendChild(modal);

    // Populate list
    const list = modal.querySelector('.items-modal-list'); // Select within the clone
    if (list) {
        list.innerHTML = '';
        if (items && items.length > 0) {
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm';
                const productName = item.product_name.length > 35 ? item.product_name.substring(0, 35) + '...' : item.product_name;
                li.innerHTML = `
                    <span class="text-gray-700" title="${item.product_name}">${productName}</span>
                    <span class="font-semibold text-gray-900">Qty: ${item.quantity}</span>
                `;
                list.appendChild(li);
            });
        } else {
            list.innerHTML = '<li class="text-gray-500 text-sm">No items in this order.</li>';
        }
    }

    // Position it
    modal.style.left = '100%';
    modal.style.top = '0';
    modal.style.marginLeft = '5px';

    // Add listeners
    modal.querySelector('.items-modal-close-btn').addEventListener('click', hideItemsModal);
    setTimeout(() => {
        document.addEventListener('click', clickOutsideHandler);
    }, 0);
}

function hideItemsModal() {
    const modal = document.getElementById('items-modal-instance');
    if (modal) {
        modal.remove();
    }
    if (currentItemModalCell) {
        currentItemModalCell.style.position = '';
        currentItemModalCell = null;
    }
    document.removeEventListener('click', clickOutsideHandler);
}

function loadOrderStats() {
    fetch('/api/per-order/stats', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to load order statistics');
    })
    .then(stats => {
        document.getElementById('total-orders').textContent = stats.total_orders.toLocaleString();
        document.getElementById('pending-orders').textContent = stats.pending_orders.toLocaleString();
        document.getElementById('delivered-orders').textContent = stats.delivered_orders.toLocaleString();
        document.getElementById('total-revenue').textContent = `UGX ${Math.round(stats.total_revenue).toLocaleString('en-UG')}`;
    })
    .catch(error => {
        console.error('Error loading order statistics:', error);
        document.getElementById('total-orders').textContent = '0';
        document.getElementById('pending-orders').textContent = '0';
        document.getElementById('delivered-orders').textContent = '0';
        document.getElementById('total-revenue').textContent = 'UGX 0';
    });
}

function clearFilters() {
    document.getElementById('search-orders').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    loadOrders();
}



document.addEventListener('DOMContentLoaded', () => {
    loadOrders(); // Initial load
});
</script>
<style>
@media print {
    .no-print { display: none !important; }
    body { background: white !important; }
    .bg-gradient-to-r { background: #3b82f6 !important; color: white !important; }
}
</style>
<!-- Confirm Order Modal -->
<div id="confirm-order-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-semibold text-white">Confirm Order</h3>
                    <button type="button" onclick="closeConfirmOrderModal()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-700 mb-4">Are you sure you want to confirm this order? This will create a final order and sale record, and update stock levels.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeConfirmOrderModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">Cancel</button>
                    <button type="button" id="confirm-order-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-all duration-200">
                        <i class="fas fa-check-circle mr-2"></i>Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}