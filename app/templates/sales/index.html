{% extends "base.html" %}

{% block title %}Sales Management - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-4 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg rounded-xl p-4 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="mb-2 md:mb-0">
                <h1 class="text-xl md:text-2xl font-bold">Sales Management</h1>
                <p class="text-blue-100 text-sm">Track and manage your sales transactions</p>
            </div>
            <button id="refresh-sales" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm">
                <i class="fas fa-sync-alt"></i>
                <span class="font-medium">Refresh</span>
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <!-- Total Sales -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-shopping-cart text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Total Sales</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-sales-count">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-green-700 font-medium">All transactions</span>
                </div>
            </div>
        </div>

        <!-- Completed Sales -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-check-circle text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Completed</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="completed-sales-count">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-blue-700 font-medium">Successful sales</span>
                </div>
            </div>
        </div>

        <!-- Total Revenue -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-400 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-money-bill-wave text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Total Revenue</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-revenue">UGX 0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-purple-700 font-medium">Gross income</span>
                </div>
            </div>
        </div>

        <!-- Total Profit -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-chart-line text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Total Profit</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-profit">UGX 0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-emerald-50 to-emerald-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-emerald-700 font-medium">Net earnings</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300">
        <!-- Table Header with Search & Filters -->
        <div class="px-4 py-3 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-table text-white text-xs"></i>
                    </div>
                    <h3 class="text-base font-semibold text-gray-900">Sales Transactions</h3>
                </div>

                <!-- Compact Search & Filter Controls -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search sales..."
                               class="pl-7 pr-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-40 text-xs transition-all duration-200">
                        <i class="fas fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                    </div>
                    <select id="status-filter" class="px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs transition-all duration-200">
                        <option value="">All Statuses</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="refunded">Refunded</option>
                    </select>
                    <input type="date" id="date-from" class="px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs transition-all duration-200">
                    <input type="date" id="date-to" class="px-2 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs transition-all duration-200">
                    <div class="flex space-x-1">
                        <button id="clear-filters" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1.5 rounded-lg flex items-center space-x-1 text-xs transition-all duration-200">
                            <i class="fas fa-times text-xs"></i>
                            <span>Clear</span>
                        </button>
                        <button onclick="exportSales()" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1.5 rounded-lg flex items-center space-x-1 text-xs transition-all duration-200">
                            <i class="fas fa-download text-xs"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200" id="sales-table">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sale Number</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Customer</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Items</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Profit</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Payment</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    <!-- Sales will be loaded here dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Sales Status Section -->
        <div id="sales-status-container" class="mt-4 px-4 py-3 bg-white border-t border-gray-200">
            <div class="flex flex-col items-center space-y-3">
                <!-- Results info -->
                <div class="text-sm text-gray-700">
                    Showing <span id="showing-sales-count" class="font-medium">0</span> of <span id="total-sales-display" class="font-medium">0</span> sales
                </div>

                

                <!-- End of results message -->
                <div id="end-of-sales" class="hidden text-center py-6">
                    <div class="inline-flex items-center justify-center space-x-3 px-6 py-3 bg-green-50 border border-green-200 rounded-lg text-green-700">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-500 text-lg"></i>
                        </div>
                        <div class="text-sm font-medium">
                            You've reached the end of all sales
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sales Detail Modal -->
<div id="saleDetailModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-receipt text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white" id="saleDetailModalLabel">Sale Details</h3>
                    </div>
                    <button type="button" id="close-modal" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <div class="p-4" id="sale-detail-content">
                <!-- Sale details will be loaded here -->
            </div>
            <div class="flex justify-end space-x-2 px-4 py-3 bg-gray-50 border-t border-gray-200 rounded-b-xl">
                <button type="button" id="close-modal-button" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Sales management JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        initializeSalesManagement();
        loadSalesStats();
        setupInfiniteScroll();
    });

    // Pagination state variables
    let currentPage = 1;
    let totalSales = 0;
    let loadedSalesCount = 0;
    let isLoading = false;
    let hasMoreSales = true;

    function initializeSalesManagement() {
        // Load initial sales
        loadSales(1, false);

        // Set up event listeners for filters
        const debouncedLoad = debounce(() => loadSales(1, false), 300);
        document.getElementById('search-input').addEventListener('input', debouncedLoad);
        document.getElementById('status-filter').addEventListener('change', () => loadSales(1, false));
        document.getElementById('date-from').addEventListener('change', () => loadSales(1, false));
        document.getElementById('date-to').addEventListener('change', () => loadSales(1, false));

        // Other event listeners
        document.getElementById('refresh-sales').addEventListener('click', () => {
            loadSales(1, false);
            loadSalesStats();
        });
        document.getElementById('clear-filters').addEventListener('click', clearFilters);
        document.getElementById('close-modal').addEventListener('click', closeSaleDetailModal);
        document.getElementById('close-modal-button').addEventListener('click', closeSaleDetailModal);

        // Event delegation for view buttons
        document.querySelector('#sales-table tbody').addEventListener('click', function(event) {
            const viewButton = event.target.closest('.view-sale');
            if (viewButton) {
                const saleId = viewButton.getAttribute('data-sale-id');
                viewSaleDetails(saleId);
            }
        });
    }

    function loadSalesStats() {
        fetch('/api/sales/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-sales-count').textContent = data.total_sales || 0;
                document.getElementById('completed-sales-count').textContent = data.completed_sales || 0;
                document.getElementById('total-revenue').textContent = `UGX ${(data.total_revenue || 0).toLocaleString()}`;
                document.getElementById('total-profit').textContent = `UGX ${(data.total_profit || 0).toLocaleString()}`;
            })
            .catch(error => console.error('Error loading sales stats:', error));
    }

    function loadSales(page = 1, append = false) {
        if (isLoading) return;
        isLoading = true;

        if (append) {
            showLoadingIndicator(3, true);
        } else {
            showLoadingIndicator(10, false);
            // Reset state for new searches/filters
            currentPage = 1;
            loadedSalesCount = 0;
            hasMoreSales = true;
        }

        const search = document.getElementById('search-input').value;
        const status = document.getElementById('status-filter').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;

        const params = new URLSearchParams({ page, size: 10 });
        if (search) params.append('search', search);
        if (status) params.append('status', status);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);

        fetch(`/api/sales/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                hideLoadingIndicator();
                totalSales = data.total || 0;
                const sales = data.sales || [];
                hasMoreSales = (loadedSalesCount + sales.length) < totalSales;
                currentPage = data.page;

                if (append) {
                    appendSales(sales);
                    loadedSalesCount += sales.length;
                } else {
                    displaySales(sales);
                    loadedSalesCount = sales.length;
                }

                updateScrollStatus();
            })
            .catch(error => {
                console.error('Error loading sales:', error);
                showToast('Failed to load sales.', 'error');
                hideLoadingIndicator();
            })
            .finally(() => {
                isLoading = false;
            });
    }

    function displaySales(sales) {
        const tbody = document.querySelector('#sales-table tbody');
        tbody.innerHTML = ''; // Clear for new display
        if (sales.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500"><div class="flex flex-col items-center"><i class="fas fa-inbox text-gray-300 text-3xl mb-2"></i><span>No sales found</span></div></td></tr>';
            return;
        }
        tbody.innerHTML = generateSaleRows(sales);
    }

    function appendSales(sales) {
        if (sales.length === 0) return;
        const tbody = document.querySelector('#sales-table tbody');
        tbody.insertAdjacentHTML('beforeend', generateSaleRows(sales));
    }

    function generateSaleRows(sales) {
        return sales.map(sale => `
            <tr class="hover:bg-gray-50 transition-colors duration-200">
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${sale.sale_number}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${sale.customer_name}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${new Date(sale.created_at).toLocaleDateString()}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${sale.items.length} items</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900 font-semibold">UGX ${sale.total_amount.toLocaleString()}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-green-600 font-semibold">UGX ${(sale.total_profit || 0).toLocaleString()}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm">
                    <span class="px-2 py-1 inline-flex text-xs leading-4 font-semibold rounded-full ${getStatusClasses(sale.status)}">
                        ${sale.status}
                    </span>
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${formatPaymentMethod(sale.payment_method)}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm font-medium">
                    <button class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-lg text-xs transition-all duration-200 view-sale shadow-sm hover:shadow-md" data-sale-id="${sale.id}">
                        <i class="fas fa-eye mr-1"></i> View
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    function formatPaymentMethod(method) {
        if (!method) return 'N/A';
        if (method === 'mobile_money') return 'Mobile Money';
        const words = method.split('_');
        return words.map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function getStatusClasses(status) {
        switch (status) {
            case 'completed': return 'bg-green-100 text-green-800';
            case 'pending': return 'bg-yellow-100 text-yellow-800';
            case 'cancelled': return 'bg-red-100 text-red-800';
            case 'refunded': return 'bg-gray-100 text-gray-800';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function showLoadingIndicator(rows = 5, append = false) {
        const tbody = document.querySelector('#sales-table tbody');
        if (!tbody) return;

        const skeletonRow = `
            <tr class="animate-pulse">
                <td class="px-3 py-3"><div class="h-4 bg-gray-200 rounded w-20"></div></td>
                <td class="px-3 py-3"><div class="h-4 bg-gray-200 rounded w-24"></div></td>
                <td class="px-3 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td>
                <td class="px-3 py-3"><div class="h-4 bg-gray-200 rounded w-12"></div></td>
                <td class="px-3 py-3"><div class="h-4 bg-gray-200 rounded w-20"></div></td>
                <td class="px-3 py-3"><div class="h-4 bg-gray-200 rounded w-20"></div></td>
                <td class="px-3 py-3"><div class="h-6 bg-gray-200 rounded-full w-24"></div></td>
                <td class="px-3 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td>
                <td class="px-3 py-3"><div class="h-8 bg-gray-200 rounded-lg w-20"></div></td>
            </tr>
        `;
        
        if (append) {
            tbody.insertAdjacentHTML('beforeend', skeletonRow.repeat(rows));
        } else {
            tbody.innerHTML = skeletonRow.repeat(rows);
        }
    }

    function hideLoadingIndicator() {
        const tbody = document.querySelector('#sales-table tbody');
        if (tbody) {
            const skeletonRows = tbody.querySelectorAll('.animate-pulse');
            skeletonRows.forEach(row => row.remove());
        }
    }

    

    function updateScrollStatus() {
        document.getElementById('showing-sales-count').textContent = loadedSalesCount;
        document.getElementById('total-sales-display').textContent = totalSales;
        const endOfSalesEl = document.getElementById('end-of-sales');
        if (hasMoreSales) {
            endOfSalesEl.classList.add('hidden');
        } else {
            endOfSalesEl.classList.remove('hidden');
        }
    }

    function setupInfiniteScroll() {
        const sentinel = document.createElement('div');
        sentinel.id = 'scroll-sentinel';
        sentinel.style.height = '1px';
        const endMessage = document.querySelector('#end-of-sales');
        if (endMessage) {
            endMessage.parentNode.insertBefore(sentinel, endMessage);
        } else {
            const container = document.querySelector('#sales-status-container');
            if (container) {
                container.appendChild(sentinel);
            }
        }

        const observer = new IntersectionObserver(entries => {
            if (entries[0].isIntersecting && !isLoading && hasMoreSales) {
                loadSales(currentPage + 1, true);
            }
        });
        observer.observe(sentinel);
    }

    function viewSaleDetails(saleId) {
        fetch(`/api/sales/${saleId}`)
            .then(response => response.json())
            .then(sale => {
                displaySaleDetails(sale);
                document.getElementById('saleDetailModal').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error loading sale details:', error);
                showToast('Failed to load sale details.', 'error');
            });
    }

    function displaySaleDetails(sale) {
        const modalLabel = document.getElementById('saleDetailModalLabel');
        modalLabel.innerHTML = `
            <div class="flex flex-col">
                <span class="text-base font-semibold text-white">Sale Details</span>
                <span class="text-xs text-blue-200">ID: ${sale.sale_number}</span>
            </div>
        `;

        const detailContent = document.getElementById('sale-detail-content');
        detailContent.innerHTML = `
            <!-- Summary -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200 mb-6 shadow-sm">
                <h6 class="text-base font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-receipt text-gray-500 mr-2"></i>Summary
                </h6>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-600">Subtotal</p>
                        <p class="text-lg font-semibold text-gray-900">UGX ${sale.subtotal.toLocaleString()}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Discount</p>
                        <p class="text-lg font-semibold text-red-600">- UGX ${(sale.discount_amount || 0).toLocaleString()}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Profit</p>
                        <p class="text-lg font-semibold text-green-600">UGX ${(sale.total_profit || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-blue-100 rounded-lg p-2 shadow-inner">
                        <p class="text-sm text-blue-800 font-bold">Total</p>
                        <p class="text-xl font-bold text-blue-900">UGX ${sale.total_amount.toLocaleString()}</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Customer Details -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <h6 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-user text-gray-500 mr-2"></i>Customer
                    </h6>
                    <div class="space-y-2 text-sm">
                        <p class="text-gray-800 font-medium text-base">${sale.customer_name}</p>
                        <div id="customer-phone-container">
                            <p class="text-gray-600"><i class="fas fa-phone fa-fw mr-1 text-gray-400"></i><span class="inline-block h-4 bg-gray-200 rounded w-24 animate-pulse"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Sale Info -->
                <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                    <h6 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-info-circle text-gray-500 mr-2"></i>Details
                    </h6>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-600">Status:</span><span class="px-2 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full ${getStatusClasses(sale.status)}">${sale.status}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Payment:</span><span class="font-medium text-gray-900">${formatPaymentMethod(sale.payment_method)}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Processed by:</span><span class="font-medium text-gray-900">${sale.cashier_name}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Date:</span><span class="font-medium text-gray-900">${new Date(sale.created_at).toLocaleString()}</span></div>
                    </div>
                </div>
            </div>

            <!-- Items Purchased -->
            <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
                <h6 class="text-base font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-shopping-bag text-gray-500 mr-2"></i>Items Purchased
                </h6>
                <div class="space-y-2">
                    ${sale.items.map(item => `
                        <div class="flex justify-between items-start p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors duration-200 border-b border-gray-200 last:border-b-0">
                            <div>
                                <p class="font-semibold text-sm text-gray-900">${item.product_name}</p>
                                <p class="text-xs text-gray-500">${item.quantity} x UGX ${item.unit_price.toLocaleString()}</p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                                <p class="text-sm font-semibold text-gray-900">UGX ${item.total_price.toLocaleString()}</p>
                                <p class="text-xs text-green-600 font-medium">Profit: UGX ${(item.profit || 0).toLocaleString()}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <!-- Notes -->
            ${sale.notes ? `
            <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-xl shadow-sm p-4">
                <div class="flex items-start">
                    <i class="fas fa-sticky-note text-yellow-600 mr-3 mt-1"></i>
                    <div>
                        <h6 class="text-sm font-semibold text-yellow-900">Notes:</h6>
                        <p class="text-sm text-yellow-800 mt-1">${sale.notes}</p>
                    </div>
                </div>
            </div>` : ''}
        `;

        if (sale.customer_id) {
            loadCustomerPhone(sale.customer_id);
        } else {
            const phoneContainer = document.getElementById('customer-phone-container');
            if(phoneContainer) {
                phoneContainer.innerHTML = `<p class="text-gray-600"><i class="fas fa-phone fa-fw mr-1 text-gray-400"></i>N/A</p>`;
            }
        }
    }

    async function loadCustomerPhone(customerId) {
        try {
            const response = await fetch(`/api/customers/${customerId}`);
            if (!response.ok) throw new Error('Customer not found');
            const customer = await response.json();
            const phoneContainer = document.getElementById('customer-phone-container');
            if (phoneContainer) {
                if (customer.phone) {
                    phoneContainer.innerHTML = `<a href="tel:${customer.phone}" class="text-blue-600 hover:underline"><i class="fas fa-phone fa-fw mr-1"></i>${customer.phone}</a>`;
                } else {
                    phoneContainer.innerHTML = `<p class="text-gray-600"><i class="fas fa-phone fa-fw mr-1 text-gray-400"></i>N/A</p>`;
                }
            }
        } catch (error) {
            console.error('Error fetching customer phone:', error);
            const phoneContainer = document.getElementById('customer-phone-container');
            if (phoneContainer) {
                phoneContainer.innerHTML = `<p class="text-gray-600"><i class="fas fa-phone fa-fw mr-1 text-gray-400"></i>N/A</p>`;
            }
        }
    }

    function closeSaleDetailModal() {
        document.getElementById('saleDetailModal').classList.add('hidden');
    }

    function clearFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('status-filter').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        loadSales(1, false);
    }

    function exportSales() {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        let exportUrl = '/api/sales/export';
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (params.toString()) {
            exportUrl += '?' + params.toString();
        }
        window.open(exportUrl, '_blank');
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function showToast(message, type = 'info') {
        // A simple toast implementation
        const toast = document.createElement('div');
        toast.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>
{% endblock %}