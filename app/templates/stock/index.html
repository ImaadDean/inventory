{% extends "base.html" %}

{% block title %}Stock Management - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-500 to-teal-600 shadow-lg rounded-xl p-4 text-white">
        <h1 class="text-xl md:text-2xl font-bold">Restock Products</h1>
        <p class="text-green-100 text-sm">Add new stock for multiple products and create a single expense.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Left side: Product search and cart -->
        <div class="lg:col-span-2 space-y-4">
            <!-- Product Search -->
            <div class="bg-white shadow-md rounded-xl">
                <div class="p-4">
                    <label for="product-search" class="block text-sm font-medium text-gray-700 mb-1">Search for products</label>
                    <input type="text" id="product-search" placeholder="Enter product name or barcode..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    <div id="search-results" class="mt-2 space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Restock Cart -->
            <div class="bg-white shadow-md rounded-xl">
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Products to Restock</h3>
                    <div id="restock-cart" class="space-y-2">
                        <!-- Cart items will be here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right side: Expense form -->
        <div class="lg:col-span-1 bg-white shadow-md rounded-xl p-4 space-y-4">
            <h3 class="text-lg font-semibold text-gray-800">Expense Details</h3>
            <form id="restock-form">
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <input type="text" id="expense-description" class="w-full mt-1 px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="expense-category" class="block text-sm font-medium text-gray-700">Category</label>
                    <input type="text" id="expense-category" value="Stock Purchase" class="w-full mt-1 px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="expense-amount" class="block text-sm font-medium text-gray-700">Total Amount</label>
                    <input type="number" id="expense-amount" class="w-full mt-1 px-3 py-2 border rounded-lg bg-gray-100" readonly required>
                </div>
                <div>
                    <label for="expense-date" class="block text-sm font-medium text-gray-700">Expense Date</label>
                    <input type="date" id="expense-date" class="w-full mt-1 px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label for="payment-method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                    <select id="payment-method" class="w-full mt-1 px-3 py-2 border rounded-lg">
                        <option value="cash">Cash</option>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>
                <div>
                    <label for="vendor" class="block text-sm font-medium text-gray-700">Vendor/Supplier</label>
                    <input type="text" id="vendor" class="w-full mt-1 px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="notes" rows="3" class="w-full mt-1 px-3 py-2 border rounded-lg"></textarea>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Submit Restock</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let restockCart = [];

    const productSearchInput = document.getElementById('product-search');
    const searchResultsContainer = document.getElementById('search-results');
    const cartContainer = document.getElementById('restock-cart');
    const amountInput = document.getElementById('expense-amount');
    const form = document.getElementById('restock-form');

    // Set today's date for expense date
    document.getElementById('expense-date').valueAsDate = new Date();

    productSearchInput.addEventListener('input', debounce(searchProducts, 300));

    async function searchProducts() {
        const query = productSearchInput.value.trim();
        if (query.length < 2) {
            searchResultsContainer.innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/api/products?search=${query}&size=10`);
            const data = await response.json();
            displaySearchResults(data.products);
        } catch (error) {
            console.error('Error searching products:', error);
            searchResultsContainer.innerHTML = '<p class="text-red-500">Error searching products.</p>';
        }
    }

    function displaySearchResults(products) {
        searchResultsContainer.innerHTML = '';
        if (!products || products.length === 0) {
            searchResultsContainer.innerHTML = '<p class="text-gray-500">No products found.</p>';
            return;
        }

        products.forEach(product => {
            const div = document.createElement('div');
            div.className = 'p-2 border-b hover:bg-gray-100 cursor-pointer';
            div.textContent = `${product.name} (Current Stock: ${product.stock_quantity})`;
            div.addEventListener('click', () => addProductToCart(product));
            searchResultsContainer.appendChild(div);
        });
    }

    function addProductToCart(product) {
        if (restockCart.find(item => item.product_id === product.id)) {
            alert('Product already in cart.');
            return;
        }

        const cartItem = {
            product_id: product.id,
            name: product.name,
            quantity: 1,
            cost_price: product.cost_price || 0
        };
        restockCart.push(cartItem);
        renderCart();
        productSearchInput.value = '';
        searchResultsContainer.innerHTML = '';
    }

    function renderCart() {
        cartContainer.innerHTML = '';
        let totalAmount = 0;

        restockCart.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 border rounded-lg';
            div.innerHTML = `
                <div>
                    <p class="font-semibold">${item.name}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="number" value="${item.quantity}" min="1" class="w-20 px-2 py-1 border rounded-lg" data-index="${index}" name="quantity">
                    <input type="number" value="${item.cost_price}" min="0" step="0.01" class="w-24 px-2 py-1 border rounded-lg" data-index="${index}" name="cost_price">
                    <button class="text-red-500" data-index="${index}" name="remove">Remove</button>
                </div>
            `;
            cartContainer.appendChild(div);
            totalAmount += item.quantity * item.cost_price;
        });

        amountInput.value = totalAmount.toFixed(2);
    }

    cartContainer.addEventListener('change', function(event) {
        if (event.target.name === 'quantity' || event.target.name === 'cost_price') {
            const index = event.target.dataset.index;
            restockCart[index][event.target.name] = parseFloat(event.target.value);
            renderCart();
        }
    });

    cartContainer.addEventListener('click', function(event) {
        if (event.target.name === 'remove') {
            const index = event.target.dataset.index;
            restockCart.splice(index, 1);
            renderCart();
        }
    });

    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const payload = {
            description: document.getElementById('expense-description').value,
            category: document.getElementById('expense-category').value,
            amount: parseFloat(amountInput.value),
            expense_date: document.getElementById('expense-date').value,
            payment_method: document.getElementById('payment-method').value,
            vendor: document.getElementById('vendor').value,
            notes: document.getElementById('notes').value,
            products: restockCart
        };

        try {
            const response = await fetch('/api/stock/restock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert('Restock successful!');
                restockCart = [];
                renderCart();
                form.reset();
                document.getElementById('expense-date').valueAsDate = new Date();
            } else {
                const error = await response.json();
                alert(`Error: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error submitting restock:', error);
            alert('An error occurred.');
        }
    });

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }
});
</script>
{% endblock %}
