{% extends "base.html" %}

{% block title %}Stock Management - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-4 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg rounded-xl p-4 text-white">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-boxes-stacked text-white text-sm"></i>
            </div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold">Restock Products</h1>
                <p class="text-blue-100 text-sm">Add new stock and record a single expense for the purchase.</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Left side: Product search and cart -->
        <div class="lg:col-span-2 space-y-4">
            <!-- Product Search -->
            <div class="bg-white shadow-md rounded-xl hover:shadow-lg transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-gray-700 to-gray-800 rounded-t-xl">
                    <div class="flex items-center">
                        <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                            <i class="fas fa-search text-white text-sm"></i>
                        </div>
                        <h3 class="text-sm font-semibold text-white">Search Products to Restock</h3>
                    </div>
                </div>
                <div class="p-4">
                    <div class="relative">
                        <input type="text" id="product-search" placeholder="Enter product name, SKU, or barcode..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-10">
                        <i class="fas fa-search text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i>
                    </div>
                    <div id="search-results" class="mt-3 space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Restock Cart -->
            <div class="bg-white shadow-md rounded-xl hover:shadow-lg transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                                <i class="fas fa-shopping-cart text-white text-sm"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-white">Products to Restock</h3>
                        </div>
                        <button id="clear-cart-btn" class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-medium">
                            <i class="fas fa-trash-alt mr-1"></i>Clear All
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div id="restock-cart" class="space-y-3">
                        <div class="text-center py-6 text-gray-500">
                            <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                            <p class="text-sm">No products added yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right side: Expense form -->
        <div class="lg:col-span-1 bg-white shadow-md rounded-xl hover:shadow-lg transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-xl">
                <div class="flex items-center">
                    <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                        <i class="fas fa-receipt text-white text-sm"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-white">Expense Details</h3>
                </div>
            </div>
            <form id="restock-form" class="p-4 space-y-4">
                <div>
                    <label for="expense-description" class="block text-xs font-semibold text-gray-700 mb-1">Description *</label>
                    <input type="text" id="expense-description" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                </div>
                <div>
                    <label for="expense-category" class="block text-xs font-semibold text-gray-700 mb-1">Category *</label>
                    <input type="text" id="expense-category" value="Stock Purchase" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-100" readonly required>
                </div>
                <div>
                    <label for="expense-amount" class="block text-xs font-semibold text-gray-700 mb-1">Total Amount</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-sm text-gray-500">UGX</span>
                        <input type="number" id="expense-amount" class="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg bg-gray-100 font-bold" readonly required>
                    </div>
                </div>
                <div>
                    <label for="expense-date" class="block text-xs font-semibold text-gray-700 mb-1">Expense Date *</label>
                    <input type="date" id="expense-date" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                </div>
                <div>
                    <label for="payment-method" class="block text-xs font-semibold text-gray-700 mb-1">Payment Method</label>
                    <select id="payment-method" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="cash">Cash</option>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="credit">Credit</option>
                    </select>
                </div>
                <div>
                    <label for="vendor" class="block text-xs font-semibold text-gray-700 mb-1">Vendor/Supplier</label>
                    <input type="text" id="vendor" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                <div>
                    <label for="notes" class="block text-xs font-semibold text-gray-700 mb-1">Notes</label>
                    <textarea id="notes" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
                </div>
                <button type="submit" id="submit-restock-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-2.5 rounded-lg hover:from-green-600 hover:to-emerald-700 font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-check-circle mr-2"></i>Submit Restock
                </button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let restockCart = [];

    const productSearchInput = document.getElementById('product-search');
    const searchResultsContainer = document.getElementById('search-results');
    const cartContainer = document.getElementById('restock-cart');
    const amountInput = document.getElementById('expense-amount');
    const form = document.getElementById('restock-form');
    const submitBtn = document.getElementById('submit-restock-btn');
    const clearCartBtn = document.getElementById('clear-cart-btn');

    document.getElementById('expense-date').valueAsDate = new Date();

    productSearchInput.addEventListener('input', debounce(searchProducts, 300));
    clearCartBtn.addEventListener('click', clearCart);

    async function searchProducts() {
        const query = productSearchInput.value.trim();
        if (query.length < 2) {
            searchResultsContainer.innerHTML = '';
            return;
        }
        searchResultsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500"></i><span class="ml-2 text-gray-600">Searching...</span></div>';

        try {
            const response = await fetch(`/api/products?search=${query}&size=10`);
            const data = await response.json();
            displaySearchResults(data.products);
        } catch (error) {
            console.error('Error searching products:', error);
            searchResultsContainer.innerHTML = '<p class="text-red-500 p-3 bg-red-50 rounded-lg">Error searching products.</p>';
        }
    }

    function displaySearchResults(products) {
        searchResultsContainer.innerHTML = '';
        if (!products || products.length === 0) {
            searchResultsContainer.innerHTML = '<p class="text-gray-500 text-center p-3 bg-gray-50 rounded-lg">No products found.</p>';
            return;
        }

        products.forEach(product => {
            const div = document.createElement('div');
            div.className = 'group bg-gray-50 hover:bg-blue-50 border border-gray-200 rounded-lg p-3 cursor-pointer transition-all duration-200 flex items-center justify-between';
            div.innerHTML = `
                <div>
                    <p class="font-semibold text-sm text-gray-800 group-hover:text-blue-800">${product.name}</p>
                    <p class="text-xs text-gray-500">SKU: ${product.sku || 'N/A'} | Stock: ${product.stock_quantity}</p>
                </div>
                <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-medium shadow-sm transform hover:scale-105 transition-transform">
                    <i class="fas fa-plus mr-1"></i>Add
                </button>
            `;
            div.addEventListener('click', () => addProductToCart(product));
            searchResultsContainer.appendChild(div);
        });
    }

    function addProductToCart(product) {
        if (restockCart.find(item => item.product_id === product.id)) {
            showToast('Product already in restock list.', 'error');
            return;
        }

        const cartItem = {
            product_id: product.id,
            name: product.name,
            quantity: 1,
            cost_price: product.cost_price || 0
        };
        restockCart.push(cartItem);
        renderCart();
        productSearchInput.value = '';
        searchResultsContainer.innerHTML = '';
        showToast(`Added ${product.name} to the list.`, 'success');
    }

    function renderCart() {
        cartContainer.innerHTML = '';
        if (restockCart.length === 0) {
            cartContainer.innerHTML = `
                <div class="text-center py-6 text-gray-500">
                    <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                    <p class="text-sm">No products added yet.</p>
                </div>`;
            clearCartBtn.classList.add('hidden');
            updateTotalAmount();
            return;
        }

        clearCartBtn.classList.remove('hidden');
        restockCart.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'bg-blue-50 border border-blue-200 rounded-xl p-3 space-y-3 animate-fade-in';
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <p class="font-semibold text-sm text-gray-900">${item.name}</p>
                    <button class="text-red-500 hover:text-red-700 text-xs font-medium" data-index="${index}" name="remove">
                        <i class="fas fa-trash mr-1"></i>Remove
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Quantity</label>
                        <input type="number" value="${item.quantity}" min="1" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" data-index="${index}" name="quantity">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cost Price (UGX)</label>
                        <input type="number" value="${item.cost_price}" min="0" step="100" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" data-index="${index}" name="cost_price">
                    </div>
                </div>
            `;
            cartContainer.appendChild(div);
        });
        updateTotalAmount();
    }
    
    function clearCart() {
        if (confirm('Are you sure you want to clear all items from the restock list?')) {
            restockCart = [];
            renderCart();
            showToast('Restock list cleared.', 'info');
        }
    }

    function updateTotalAmount() {
        const totalAmount = restockCart.reduce((sum, item) => sum + (item.quantity * item.cost_price), 0);
        amountInput.value = totalAmount.toFixed(0);
        
        // Auto-fill description
        const descriptionInput = document.getElementById('expense-description');
        if (restockCart.length > 0) {
            const productNames = restockCart.map(p => p.name).slice(0, 2).join(', ');
            const additional = restockCart.length > 2 ? ` and ${restockCart.length - 2} more items` : '';
            descriptionInput.value = `Restock of ${productNames}${additional}`;
        } else {
            descriptionInput.value = '';
        }
        
        // Enable/disable submit button
        submitBtn.disabled = restockCart.length === 0 || totalAmount <= 0;
    }

    cartContainer.addEventListener('change', function(event) {
        if (event.target.name === 'quantity' || event.target.name === 'cost_price') {
            const index = event.target.dataset.index;
            const value = parseFloat(event.target.value);
            if (value >= 0) {
                restockCart[index][event.target.name] = value;
                updateTotalAmount();
            }
        }
    });

    cartContainer.addEventListener('click', function(event) {
        const removeButton = event.target.closest('button[name="remove"]');
        if (removeButton) {
            const index = removeButton.dataset.index;
            restockCart.splice(index, 1);
            renderCart();
            showToast('Item removed from the list.', 'info');
        }
    });

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

        const payload = {
            description: document.getElementById('expense-description').value,
            category: document.getElementById('expense-category').value,
            amount: parseFloat(amountInput.value),
            expense_date: document.getElementById('expense-date').value,
            payment_method: document.getElementById('payment-method').value,
            vendor: document.getElementById('vendor').value,
            notes: document.getElementById('notes').value,
            products: restockCart
        };

        try {
            const response = await fetch('/api/stock/restock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                showToast('Restock successful!', 'success');
                restockCart = [];
                renderCart();
                form.reset();
                document.getElementById('expense-date').valueAsDate = new Date();
            } else {
                const error = await response.json();
                showToast(`Error: ${error.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error submitting restock:', error);
            showToast('An unexpected error occurred.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Submit Restock';
            updateTotalAmount();
        }
    });

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }
    
    // Initial state
    updateTotalAmount();
});
</script>
{% endblock %}