{% extends "base.html" %}

{% block title %}Stock Management - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-4 animate-fade-in">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg rounded-xl p-4 text-white">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-boxes-stacked text-white text-sm"></i>
            </div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold">Restock Products</h1>
                <p class="text-blue-100 text-sm">Add new stock and record a single expense for the purchase.</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Left side: Product search and cart -->
        <div class="lg:col-span-2 space-y-4">
            <!-- Product Search -->
            <div class="bg-white shadow-md rounded-xl hover:shadow-lg transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-gray-700 to-gray-800 rounded-t-xl">
                    <div class="flex items-center">
                        <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                            <i class="fas fa-search text-white text-sm"></i>
                        </div>
                        <h3 class="text-sm font-semibold text-white">Search Products to Restock</h3>
                    </div>
                </div>
                <div class="p-4">
                    <div class="relative">
                        <input type="text" id="product-search" placeholder="Enter product name, SKU, or barcode..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 pr-10">
                        <i class="fas fa-search text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i>
                    </div>
                    <div id="search-results" class="mt-3 space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Restock Cart -->
            <div class="bg-white shadow-md rounded-xl hover:shadow-lg transition-all duration-300">
                <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                                <i class="fas fa-shopping-cart text-white text-sm"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-white">Products to Restock</h3>
                        </div>
                        <button id="clear-cart-btn" class="hidden bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-medium">
                            <i class="fas fa-trash-alt mr-1"></i>Clear All
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <div id="restock-cart" class="space-y-3">
                        <div class="text-center py-6 text-gray-500">
                            <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                            <p class="text-sm">No products added yet.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right side: Expense form -->
        <div class="lg:col-span-1 bg-white shadow-md rounded-xl hover:shadow-lg transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-t-xl">
                <div class="flex items-center">
                    <div class="w-7 h-7 bg-white bg-opacity-20 rounded-md flex items-center justify-center mr-2">
                        <i class="fas fa-receipt text-white text-sm"></i>
                    </div>
                    <h3 class="text-sm font-semibold text-white">Expense Details</h3>
                </div>
            </div>
            <form id="restock-form" class="p-4 space-y-4">
                <div>
                    <label for="expense-description" class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-file-text text-gray-400 mr-1"></i>
                        Description *
                    </label>
                    <input type="text" id="expense-description" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" required>
                </div>
                
                <div>
                    <label for="expense-category" class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-folder text-gray-400 mr-1"></i>
                        Category *
                    </label>
                    <div class="relative">
                        <input type="text" id="expense-category" value="Stock Purchase" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-gray-50 text-gray-600 shadow-sm" readonly required>
                        <i class="fas fa-lock text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i>
                    </div>
                </div>
                
                <div>
                    <label for="expense-amount" class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-calculator text-gray-400 mr-1"></i>
                        Total Amount
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-sm text-gray-500 font-medium">UGX</span>
                        <input type="number" id="expense-amount" class="w-full pl-12 pr-3 py-2.5 text-sm border border-gray-300 rounded-lg bg-gray-50 font-bold text-green-600 shadow-sm" readonly required>
                        <i class="fas fa-lock text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i>
                    </div>
                </div>
                
                <div>
                    <label for="expense-date" class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-calendar text-gray-400 mr-1"></i>
                        Expense Date *
                    </label>
                    <input type="date" id="expense-date" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200" required>
                </div>
                
                <div>
                    <label for="payment-method" class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-credit-card text-gray-400 mr-1"></i>
                        Payment Method
                    </label>
                    <div class="relative">
                        <select id="payment-method" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200 appearance-none" required>
                            <option value="" disabled selected>Select a payment method</option>
                            <option value="cash">üíµ Cash</option>
                            <option value="mobile_money">üì± Mobile Money</option>
                            <option value="not_paid">‚ùå Not Paid</option>
                        </select>
                        <i class="fas fa-chevron-down text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                    </div>
                </div>
                
                <div>
                    <label for="vendor" class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-truck text-gray-400 mr-1"></i>
                        Vendor/Supplier <span class="text-red-500 ml-1">*</span>
                    </label>
                    <button type="button" id="select-supplier-btn" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200 text-left flex items-center justify-between hover:border-gray-400">
                        <span id="selected-supplier-text" class="text-gray-500">Click to select supplier</span>
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </button>
                    <input type="hidden" id="vendor" name="vendor" required>
                    <div id="vendor-error" class="text-red-500 text-xs mt-1 hidden">Please select a supplier.</div>
                </div>
                
                <div>
                    <label for="notes" class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-sticky-note text-gray-400 mr-1"></i>
                        Notes
                    </label>
                    <textarea id="notes" rows="3" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200 resize-none" placeholder="Additional notes or comments"></textarea>
                </div>
                
                <button type="submit" id="submit-restock-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-lg hover:from-green-600 hover:to-emerald-700 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-300 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-md">
                    <i class="fas fa-check-circle mr-2"></i>Submit Restock
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Supplier Selection Modal -->
<div id="supplier-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-truck text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Select Supplier</h3>
                    </div>
                    <button id="close-supplier-selection-modal" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <div class="relative mb-4">
                    <input type="text" id="supplier-search" placeholder="Search suppliers..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <i class="fas fa-search text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i>
                </div>
                <div id="supplier-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Suppliers will be loaded here -->
                </div>
                <div class="flex justify-between items-center pt-3 border-t border-gray-200 mt-4">
                    <button type="button" id="add-new-supplier-btn" class="text-xs font-medium text-blue-600 hover:text-blue-800 flex items-center">
                        <i class="fas fa-plus mr-1"></i>Add New Supplier
                    </button>
                    <button type="button" id="clear-supplier-btn" class="text-xs font-medium text-gray-600 hover:text-gray-800">
                        Clear Selection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add New Supplier Modal -->
<div id="add-supplier-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300">
            <div class="px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-white bg-opacity-20 rounded-lg flex items-center justify-center mr-2">
                            <i class="fas fa-plus text-white text-xs"></i>
                        </div>
                        <h3 class="text-base font-semibold text-white">Add New Supplier</h3>
                    </div>
                    <button id="close-supplier-modal" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
            <form id="add-supplier-form" class="p-4 space-y-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-building text-gray-400 mr-1"></i>Company Name
                    </label>
                    <input type="text" id="supplier-name" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Enter company name">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-user text-gray-400 mr-1"></i>Contact Person
                        </label>
                        <input type="text" id="supplier-contact" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Contact person name">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">
                            <i class="fas fa-phone text-gray-400 mr-1"></i>Phone Number
                        </label>
                        <input type="tel" id="supplier-phone" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Phone number">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-envelope text-gray-400 mr-1"></i>Email Address
                    </label>
                    <input type="email" id="supplier-email" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Email address">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>Address
                    </label>
                    <textarea id="supplier-address" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Full address"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">
                        <i class="fas fa-sticky-note text-gray-400 mr-1"></i>Notes
                    </label>
                    <textarea id="supplier-notes" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-all duration-200" placeholder="Additional notes"></textarea>
                </div>

                <div class="flex items-center p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <input type="checkbox" id="supplier-is-active" checked class="h-3 w-3 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                    <label class="ml-2 block text-xs font-medium text-orange-900">
                        <i class="fas fa-check-circle text-orange-600 mr-1"></i>Active Supplier
                    </label>
                    <span class="ml-2 text-xs text-orange-600">Supplier is available for orders</span>
                </div>

                <div class="flex justify-end space-x-2 pt-3 border-t border-gray-200">
                    <button type="button" id="cancel-supplier-btn" class="px-3 py-2 text-xs font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-200">
                        Cancel
                    </button>
                    <button type="submit" id="save-supplier-btn" class="px-3 py-2 text-xs font-medium text-white bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-plus mr-1"></i>Add Supplier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let restockCart = [];

    const productSearchInput = document.getElementById('product-search');
    const searchResultsContainer = document.getElementById('search-results');
    const cartContainer = document.getElementById('restock-cart');
    const amountInput = document.getElementById('expense-amount');
    const form = document.getElementById('restock-form');
    const submitBtn = document.getElementById('submit-restock-btn');
    const clearCartBtn = document.getElementById('clear-cart-btn');

    // Supplier search elements
    const supplierInput = document.getElementById('vendor');
    const selectSupplierBtn = document.getElementById('select-supplier-btn');
    const selectedSupplierText = document.getElementById('selected-supplier-text');
    
    // Modal elements
    const supplierModal = document.getElementById('add-supplier-modal');
    const supplierForm = document.getElementById('add-supplier-form');
    const closeModalBtn = document.getElementById('close-supplier-modal');
    const cancelModalBtn = document.getElementById('cancel-supplier-btn');
    
    // Supplier selection modal elements
    const supplierSelectionModal = document.getElementById('supplier-selection-modal');
    const supplierSearchInput = document.getElementById('supplier-search');
    const supplierList = document.getElementById('supplier-list');
    const closeSupplierSelectionBtn = document.getElementById('close-supplier-selection-modal');
    const addNewSupplierBtn = document.getElementById('add-new-supplier-btn');
    const clearSupplierBtn = document.getElementById('clear-supplier-btn');

    document.getElementById('expense-date').valueAsDate = new Date();

    productSearchInput.addEventListener('input', debounce(searchProducts, 300));
    selectSupplierBtn.addEventListener('click', openSupplierSelectionModal);
    clearCartBtn.addEventListener('click', clearCart);
    
    // Modal event listeners
    closeModalBtn.addEventListener('click', closeSupplierModal);
    cancelModalBtn.addEventListener('click', closeSupplierModal);
    supplierForm.addEventListener('submit', handleSupplierFormSubmit);
    
    // Supplier selection modal listeners
    closeSupplierSelectionBtn.addEventListener('click', closeSupplierSelectionModal);
    supplierSearchInput.addEventListener('input', debounce(searchSuppliersInModal, 300));
    addNewSupplierBtn.addEventListener('click', () => {
        closeSupplierSelectionModal();
        addNewSupplier('');
    });
    clearSupplierBtn.addEventListener('click', clearSelectedSupplier);

    async function searchProducts() {
        const query = productSearchInput.value.trim();
        if (query.length < 2) {
            searchResultsContainer.innerHTML = '';
            return;
        }
        searchResultsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500"></i><span class="ml-2 text-gray-600">Searching...</span></div>';

        try {
            const response = await fetch(`/api/products/?search=${query}&size=10`);
            const data = await response.json();
            displaySearchResults(data.products);
        } catch (error) {
            console.error('Error searching products:', error);
            searchResultsContainer.innerHTML = '<p class="text-red-500 p-3 bg-red-50 rounded-lg">Error searching products.</p>';
        }
    }

    function displaySearchResults(products) {
        searchResultsContainer.innerHTML = '';
        if (!products || products.length === 0) {
            searchResultsContainer.innerHTML = `
                <div class="text-center py-4 px-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl">
                    <div class="w-8 h-8 bg-gray-300 rounded-lg flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-search text-gray-500 text-sm"></i>
                    </div>
                    <p class="text-sm text-gray-600 font-medium">No products found</p>
                    <p class="text-xs text-gray-500">Try searching with different keywords</p>
                </div>
            `;
            return;
        }

        products.forEach(product => {
            const div = document.createElement('div');
            div.className = 'group bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 border border-blue-200 hover:border-blue-300 rounded-xl p-3 cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md transform hover:-translate-y-0.5';
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1 mr-3">
                        <div class="flex items-center mb-1">
                            <div class="w-4 h-4 bg-blue-500 rounded-md flex items-center justify-center mr-2">
                                <i class="fas fa-box text-white text-xs"></i>
                            </div>
                            <p class="font-semibold text-sm text-gray-900 group-hover:text-blue-900">${product.name}</p>
                        </div>
                        <div class="flex items-center space-x-3 text-xs text-gray-600">
                            <span class="flex items-center">
                                <i class="fas fa-tag text-gray-400 mr-1"></i>
                                ${product.brand || 'No Brand'}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-warehouse text-gray-400 mr-1"></i>
                                ${product.stock_quantity} ${product.unit}
                            </span>
                            ${product.decant && product.decant.is_decantable ? `
                            <span class="flex items-center text-purple-600">
                                <i class="fas fa-flask text-purple-400 mr-1"></i>
                                ${product.decant.decant_size_ml}ml decants | ${product.decant.opened_bottle_ml_left || 0}ml left | ${product.stock_quantity} bottles
                            </span>
                            ` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm text-blue-600 mb-1">UGX ${product.cost_price ? product.cost_price.toLocaleString() : '0'}</p>
                        <button class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white px-3 py-1 rounded-lg text-xs font-medium shadow-sm hover:shadow-md transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-plus mr-1"></i>Add
                        </button>
                    </div>
                </div>
            `;
            div.addEventListener('click', () => addProductToCart(product));
            searchResultsContainer.appendChild(div);
        });
    }

    function openSupplierSelectionModal() {
        supplierSelectionModal.classList.remove('hidden');
        loadSuppliersInModal();
        supplierSearchInput.focus();
    }

    function closeSupplierSelectionModal() {
        supplierSelectionModal.classList.add('hidden');
        supplierSearchInput.value = '';
        supplierList.innerHTML = '';
    }

    async function loadSuppliersInModal() {
        supplierList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-500"></i><span class="ml-2 text-gray-600">Loading suppliers...</span></div>';
        
        try {
            const response = await fetch('/api/suppliers/?size=50');
            const data = await response.json();
            displaySuppliersInModal(data.suppliers || []);
        } catch (error) {
            console.error('Error loading suppliers:', error);
            supplierList.innerHTML = '<p class="text-red-500 text-xs p-2">Error loading suppliers</p>';
        }
    }

    async function searchSuppliersInModal() {
        const query = supplierSearchInput.value.trim();
        if (query.length < 2) {
            loadSuppliersInModal();
            return;
        }

        supplierList.innerHTML = `
            <div class="space-y-2">
                <div class="animate-pulse bg-gray-200 rounded-lg p-2 flex items-center">
                    <div class="w-4 h-4 bg-gray-300 rounded-md mr-2"></div>
                    <div class="flex-1">
                        <div class="h-3 bg-gray-300 rounded w-3/4 mb-1"></div>
                        <div class="h-2 bg-gray-300 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        `;

        try {
            const response = await fetch(`/api/suppliers/?search=${query}&size=20`);
            const data = await response.json();
            displaySuppliersInModal(data.suppliers || []);
        } catch (error) {
            console.error('Error searching suppliers:', error);
            supplierList.innerHTML = '<p class="text-red-500 text-xs p-2">Error searching suppliers</p>';
        }
    }

    function displaySuppliersInModal(suppliers) {
        if (!suppliers || suppliers.length === 0) {
            supplierList.innerHTML = `
                <div class="text-center py-4 px-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-xl">
                    <div class="w-8 h-8 bg-gray-300 rounded-lg flex items-center justify-center mx-auto mb-2">
                        <i class="fas fa-truck text-gray-500 text-sm"></i>
                    </div>
                    <p class="text-sm text-gray-600 font-medium">No suppliers found</p>
                    <p class="text-xs text-gray-500">Try searching with different keywords</p>
                </div>
            `;
            return;
        }

        supplierList.innerHTML = suppliers.map(supplier => `
            <div class="bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-300 rounded-lg p-3 cursor-pointer transition-all duration-200" onclick="selectSupplierFromModal('${supplier.id}', '${supplier.name.replace(/'/g, "\\'")}')">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-blue-500 rounded-md flex items-center justify-center mr-2">
                            <i class="fas fa-building text-white text-xs"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${supplier.name}</p>
                            <p class="text-xs text-gray-500 flex items-center">
                                <i class="fas fa-phone text-gray-400 mr-1"></i>
                                ${supplier.phone || 'No phone'}
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${supplier.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${supplier.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function selectSupplierFromModal(supplierId, supplierName) {
        supplierInput.value = supplierName;
        selectedSupplierText.textContent = supplierName;
        selectedSupplierText.classList.remove('text-gray-500');
        selectedSupplierText.classList.add('text-gray-900', 'font-medium');
        
        // Remove error state
        const vendorError = document.getElementById('vendor-error');
        const selectSupplierBtn = document.getElementById('select-supplier-btn');
        vendorError.classList.add('hidden');
        selectSupplierBtn.classList.remove('border-red-500');

        closeSupplierSelectionModal();
    }

    // Make function globally accessible
    window.selectSupplierFromModal = selectSupplierFromModal;

    function clearSelectedSupplier() {
        supplierInput.value = '';
        selectedSupplierText.textContent = 'Click to select supplier';
        selectedSupplierText.classList.remove('text-gray-900', 'font-medium');
        selectedSupplierText.classList.add('text-gray-500');
        
        // It's cleared, so no error should show until submission is attempted
        const vendorError = document.getElementById('vendor-error');
        const selectSupplierBtn = document.getElementById('select-supplier-btn');
        vendorError.classList.add('hidden');
        selectSupplierBtn.classList.remove('border-red-500');

        closeSupplierSelectionModal();
    }

    function addNewSupplier(name) {
        document.getElementById('supplier-name').value = name.trim();
        openSupplierModal();
    }

    function openSupplierModal() {
        supplierModal.classList.remove('hidden');
        document.getElementById('supplier-name').focus();
    }

    function closeSupplierModal() {
        supplierModal.classList.add('hidden');
        supplierForm.reset();
    }

    async function handleSupplierFormSubmit(event) {
        event.preventDefault();
        
        const saveBtn = document.getElementById('save-supplier-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Saving...';

        const supplierData = {
            name: document.getElementById('supplier-name').value.trim(),
            contact_person: document.getElementById('supplier-contact').value.trim(),
            phone: document.getElementById('supplier-phone').value.trim(),
            email: document.getElementById('supplier-email').value.trim() || null,
            address: document.getElementById('supplier-address').value.trim() || null,
            notes: document.getElementById('supplier-notes').value.trim() || null,
            is_active: document.getElementById('supplier-is-active').checked
        };

        try {
            const response = await fetch('/api/suppliers/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(supplierData)
            });

            if (response.ok) {
                const newSupplier = await response.json();
                supplierInput.value = newSupplier.name;
                closeSupplierModal();
                showToast(`Supplier "${newSupplier.name}" added successfully!`, 'success');
            } else {
                const error = await response.json();
                showToast(`Error adding supplier: ${error.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error adding supplier:', error);
            showToast('Error adding supplier', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    function addProductToCart(product) {
        if (restockCart.find(item => item.product_id === product.id)) {
            showToast('Product already in restock list.', 'error');
            return;
        }

        const cartItem = {
            product_id: product.id,
            name: product.name,
            brand: product.brand,
            decant: product.decant,
            stock_quantity: product.stock_quantity,
            quantity: 1,
            cost_price: product.cost_price || 0
        };
        restockCart.push(cartItem);
        renderCart();
        productSearchInput.value = '';
        searchResultsContainer.innerHTML = '';
        showToast(`Added ${product.name} to the list.`, 'success');
    }

    function renderCart() {
        cartContainer.innerHTML = '';
        if (restockCart.length === 0) {
            cartContainer.innerHTML = `
                <div class="text-center py-6 text-gray-500">
                    <i class="fas fa-shopping-cart text-2xl mb-2"></i>
                    <p class="text-sm">No products added yet.</p>
                </div>`;
            clearCartBtn.classList.add('hidden');
            updateTotalAmount();
            return;
        }

        clearCartBtn.classList.remove('hidden');
        restockCart.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 hover:border-green-300 rounded-xl p-4 space-y-3 animate-fade-in shadow-sm hover:shadow-md transition-all duration-200';
            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-green-500 rounded-md flex items-center justify-center mr-2">
                            <i class="fas fa-box text-white text-xs"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-sm text-gray-900">${item.name}</p>
                            <p class="text-xs text-gray-500 flex items-center">
                                <i class="fas fa-tag text-gray-400 mr-1"></i>
                                ${item.brand || 'No Brand'}
                            </p>
                            ${item.decant && item.decant.is_decantable ? `
                            <p class="text-xs text-purple-600 flex items-center">
                                <i class="fas fa-flask text-purple-400 mr-1"></i>
                                ${item.decant.decant_size_ml}ml decants @ UGX ${item.decant.decant_price ? item.decant.decant_price.toLocaleString() : '0'} | ${item.decant.opened_bottle_ml_left || 0}ml left | ${item.stock_quantity} bottles
                            </p>
                            ` : ''}
                        </div>
                    </div>
                    <button class="bg-red-100 hover:bg-red-200 text-red-600 hover:text-red-700 px-2 py-1 rounded-lg text-xs font-medium transition-all duration-200 flex items-center" data-index="${index}" name="remove">
                        <i class="fas fa-trash mr-1"></i>Remove
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-hashtag text-gray-400 mr-1"></i>
                            Quantity
                        </label>
                        <input type="number" value="${item.quantity}" min="1" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm" data-index="${index}" name="quantity">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-2 flex items-center">
                            <i class="fas fa-money-bill text-gray-400 mr-1"></i>
                            Cost Price (UGX)
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-xs text-gray-500">UGX</span>
                            <input type="number" value="${item.cost_price}" min="0" step="100" class="w-full pl-10 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm" data-index="${index}" name="cost_price">
                        </div>
                    </div>
                </div>
                <div class="pt-2 border-t border-green-200">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-600">Subtotal:</span>
                        <span class="font-bold text-green-600">UGX ${(parseFloat(item.quantity) * parseFloat(item.cost_price)).toLocaleString()}</span>
                    </div>
                </div>
            `;
            cartContainer.appendChild(div);
        });
        updateTotalAmount();
    }
    
    function clearCart() {
        if (confirm('Are you sure you want to clear all items from the restock list?')) {
            restockCart = [];
            renderCart();
            showToast('Restock list cleared.', 'info');
        }
    }

    function updateTotalAmount() {
        const totalAmount = restockCart.reduce((sum, item) => sum + (parseFloat(item.quantity) * parseFloat(item.cost_price)), 0);
        amountInput.value = totalAmount.toFixed(0);
        
        // Auto-fill description
        const descriptionInput = document.getElementById('expense-description');
        if (restockCart.length > 0) {
            const productDescriptions = restockCart.map(p => `${p.name} (Qty: ${p.quantity})`).slice(0, 2);
            const additional = restockCart.length > 2 ? ` and ${restockCart.length - 2} more items` : '';
            descriptionInput.value = `Restock of ${productDescriptions.join(', ')}${additional}`;
        } else {
            descriptionInput.value = '';
        }
        
        // Enable/disable submit button
        submitBtn.disabled = restockCart.length === 0 || totalAmount <= 0;
    }

    cartContainer.addEventListener('change', function(event) {
        if (event.target.name === 'quantity' || event.target.name === 'cost_price') {
            const index = event.target.dataset.index;
            const value = parseFloat(event.target.value);
            if (value >= 0) {
                restockCart[index][event.target.name] = value;
                renderCart();
            }
        }
    });

    cartContainer.addEventListener('click', function(event) {
        const removeButton = event.target.closest('button[name="remove"]');
        if (removeButton) {
            const index = removeButton.dataset.index;
            restockCart.splice(index, 1);
            renderCart();
            showToast('Item removed from the list.', 'info');
        }
    });

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const vendorInput = document.getElementById('vendor');
        const vendorError = document.getElementById('vendor-error');
        const selectSupplierBtn = document.getElementById('select-supplier-btn');

        // Custom validation for supplier
        if (!vendorInput.value) {
            vendorError.classList.remove('hidden');
            selectSupplierBtn.classList.add('border-red-500');
            selectSupplierBtn.focus();
            showToast('Please select a supplier.', 'error');
            return;
        } else {
            vendorError.classList.add('hidden');
            selectSupplierBtn.classList.remove('border-red-500');
        }

        if (!form.reportValidity()) {
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

        const paymentMethod = document.getElementById('payment-method').value;
        const isPaid = ['cash', 'mobile_money'].includes(paymentMethod);
        
        const payload = {
            description: document.getElementById('expense-description').value,
            category: document.getElementById('expense-category').value,
            amount: parseFloat(amountInput.value),
            expense_date: document.getElementById('expense-date').value,
            payment_method: paymentMethod,
            status: isPaid ? 'paid' : 'not_paid',
            is_paid: isPaid,
            vendor: document.getElementById('vendor').value,
            notes: document.getElementById('notes').value,
            products: restockCart
        };

        try {
            const response = await fetch('/api/stock/restock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                showToast('Restock successful!', 'success');
                restockCart = [];
                renderCart();
                form.reset();
                document.getElementById('expense-date').valueAsDate = new Date();
                clearSelectedSupplier();
            } else {
                const error = await response.json();
                showToast(`Error: ${error.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error submitting restock:', error);
            showToast('An unexpected error occurred.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Submit Restock';
            updateTotalAmount();
        }
    });

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }
    
    // Initial state
    updateTotalAmount();

    // Close modal when clicking outside
    supplierModal.addEventListener('click', function(event) {
        if (event.target === supplierModal) {
            closeSupplierModal();
        }
    });

    // Close supplier selection modal when clicking outside
    supplierSelectionModal.addEventListener('click', function(event) {
        if (event.target === supplierSelectionModal) {
            closeSupplierSelectionModal();
        }
    });
});
</script>
{% endblock %}