{% extends "base.html" %}

{% block title %}Orders - Inventory Management System{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 shadow-lg rounded-xl p-4 text-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="mb-2 md:mb-0">
                <h1 class="text-xl md:text-2xl font-bold">Order Management</h1>
                <p class="text-blue-100 text-sm">Track and manage all your sales orders</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="loadOrders()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm">
                    <i class="fas fa-refresh text-xs"></i>
                    <span class="font-medium">Refresh</span>
                </button>
                <button onclick="exportOrders()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg flex items-center space-x-2 transition-all duration-200 text-sm">
                    <i class="fas fa-download text-xs"></i>
                    <span class="font-medium">Export</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
        <!-- Total Orders -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-shopping-cart text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Total Orders</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-orders">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-blue-700 font-medium">All orders</span>
                </div>
            </div>
        </div>

        <!-- Completed Orders -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-check-circle text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Completed</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="completed-orders">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-50 to-green-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-green-700 font-medium">Successfully fulfilled</span>
                </div>
            </div>
        </div>

        <!-- Pending Orders -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-clock text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Pending</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="pending-orders">0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-yellow-700 font-medium">Awaiting processing</span>
                </div>
            </div>
        </div>

        <!-- Total Revenue -->
        <div class="bg-white overflow-hidden shadow-md rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="p-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                            <i class="fas fa-dollar-sign text-white text-xs"></i>
                        </div>
                    </div>
                    <div class="ml-3 flex-1">
                        <dt class="text-xs font-medium text-gray-500 truncate">Total Revenue</dt>
                        <dd class="text-base font-bold text-gray-900 mt-0.5" id="total-revenue">UGX 0</dd>
                    </div>
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 px-4 py-2">
                <div class="text-xs">
                    <span class="text-purple-700 font-medium">Net revenue</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all duration-300">
        <div class="px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 lg:space-y-0">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-list text-white text-xs"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-semibold text-gray-900">Orders</h3>
                        <div class="text-xs text-gray-600">
                            <span id="orders-count">0 orders</span>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <div class="relative">
                        <input type="text" id="search-orders" placeholder="Search orders, clients..."
                               class="pl-7 pr-3 py-1.5 w-full sm:w-40 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                        <i class="fas fa-search absolute left-2 top-2 text-gray-400 text-xs"></i>
                    </div>
                    <select id="status-filter" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <div class="flex items-center space-x-1">
                        <input type="date" id="date-from" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" title="From Date">
                        <span class="text-gray-400 text-xs">to</span>
                        <input type="date" id="date-to" class="px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" title="To Date">
                    </div>
                    <button onclick="clearFilters()" class="px-2 py-1.5 text-gray-600 hover:text-gray-800 hover:bg-gray-200 rounded-lg transition-all duration-200 flex items-center space-x-1" title="Clear Filters">
                        <i class="fas fa-times text-xs"></i>
                        <span class="text-xs">Clear</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Order #</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Client</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Items</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Subtotal</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Discount</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body" class="bg-white divide-y divide-gray-100">
                    <!-- Orders will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="px-4 py-3 border-t border-gray-200 bg-gray-50">
            <div class="flex flex-col items-center space-y-2">
                <!-- Pagination Info -->
                <div class="text-xs text-gray-600 font-medium">
                    <span id="pagination-info">Page 1 of 1</span>
                </div>

                <div id="loading-message" class="text-center text-gray-500 py-1" style="display: none;">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-blue-500"></div>
                        <span class="text-xs">Loading more orders...</span>
                    </div>
                </div>

                <div id="end-message" class="text-center text-gray-500 py-2" style="display: none;">
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mb-1">
                            <i class="fas fa-check text-gray-400 text-sm"></i>
                        </div>
                        <p class="text-xs font-medium">You've reached the end</p>
                        <p class="text-xs">All orders have been loaded</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Orders management functionality
let currentPage = 1;
let totalPages = 1;
let isLoading = false;
let allOrders = [];

function loadOrders(page = 1, append = false) {
    if (isLoading) return;
    isLoading = true;

    // Show loading message for append operations
    if (append) {
        const loadingMessage = document.querySelector('#loading-message');
        if (loadingMessage) {
            loadingMessage.style.display = 'block';
        }
    }

    // Build query parameters
    const params = new URLSearchParams({
        page: page,
        size: 10
    });

    // Add filters
    const search = document.getElementById('search-orders').value;
    const status = document.getElementById('status-filter').value;
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;

    if (search) params.append('search', search);
    if (status) params.append('status', status);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);

    // Load orders from the API
    fetch(`/api/orders/?${params.toString()}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to load orders');
        })
        .then(data => {
            currentPage = data.page;
            totalPages = data.total_pages;

            if (append) {
                allOrders = [...allOrders, ...(data.orders || [])];
            } else {
                allOrders = data.orders || [];
            }

            displayOrders(allOrders, data.total, currentPage, totalPages);

            // Load stats separately on first load
            if (!append) {
                loadOrderStats();
            }

            if (!append) {
                showToast(`Loaded ${data.total || 0} orders`, 'success');
            }
        })
        .catch(error => {
            console.error('Error loading orders:', error);
            showToast('Failed to load orders', 'error');
        })
        .finally(() => {
            isLoading = false;
        });
}

function displayOrders(orders, total = 0, page = 1, totalPages = 1) {
    const tableBody = document.querySelector('#orders-table-body');
    const ordersCount = document.querySelector('#orders-count');
    const paginationInfo = document.querySelector('#pagination-info');
    const loadingMessage = document.querySelector('#loading-message');
    const endMessage = document.querySelector('#end-message');

    if (!tableBody) return;

    // Update orders count
    if (ordersCount) {
        ordersCount.textContent = `${total} order${total !== 1 ? 's' : ''} (showing ${orders.length})`;
    }

    // Update pagination info
    if (paginationInfo) {
        paginationInfo.textContent = `Page ${page} of ${totalPages}`;
    }

    // Show/hide loading and end messages
    if (loadingMessage) {
        loadingMessage.style.display = 'none';
    }
    if (endMessage) {
        endMessage.style.display = page >= totalPages && orders.length > 0 ? 'block' : 'none';
    }

    if (orders.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-shopping-cart text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No orders found</h3>
                        <p class="text-sm text-gray-500">Orders will appear here when created through POS</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = orders.map(order => {
        const subtotal = order.subtotal || order.total + (order.discount || 0);
        const discount = order.discount || 0;
        const hasDiscount = discount > 0;

        return `
        <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-receipt text-white text-xs"></i>
                    </div>
                    <span class="text-sm font-semibold text-gray-900">${order.order_number}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div>
                    <div class="text-sm font-semibold text-gray-900">${order.client_name}</div>
                    <div class="text-xs text-gray-500">${order.client_phone || 'No phone number'}</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-6 h-6 bg-gray-100 rounded-md flex items-center justify-center mr-2">
                        <i class="fas fa-box text-gray-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-900">${order.items.length} item${order.items.length !== 1 ? 's' : ''}</span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm font-medium text-gray-900">UGX ${Math.round(subtotal).toLocaleString('en-UG')}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                ${hasDiscount ?
                    `<div class="flex items-center">
                        <div class="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center mr-2">
                            <i class="fas fa-percent text-green-600 text-xs"></i>
                        </div>
                        <span class="text-sm font-semibold text-green-600">UGX ${Math.round(discount).toLocaleString('en-UG')}</span>
                    </div>` :
                    `<span class="text-sm text-gray-400">-</span>`
                }
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm font-bold text-gray-900">UGX ${Math.round(order.total).toLocaleString('en-UG')}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${getStatusClass(order.status)}">
                    ${getStatusText(order.status)}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="flex items-center">
                    <i class="fas fa-calendar text-gray-400 mr-2 text-xs"></i>
                    ${new Date(order.created_at).toLocaleDateString()}
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
                <div class="flex items-center justify-end space-x-2">
                    <button onclick="viewOrder('${order.id}')" class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg transition-all duration-200" title="View Order">
                        <i class="fas fa-eye text-sm"></i>
                    </button>
                    <button onclick="printOrder('${order.id}')" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-50 rounded-lg transition-all duration-200" title="Print Order">
                        <i class="fas fa-print text-sm"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
}

function getStatusClass(status) {
    switch(status) {
        case 'completed': return 'bg-green-100 text-green-800';
        case 'processing': return 'bg-blue-100 text-blue-800';
        case 'pending': return 'bg-yellow-100 text-yellow-800';
        case 'cancelled': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'completed': return 'Completed';
        case 'processing': return 'Processing';
        case 'pending': return 'Pending';
        case 'cancelled': return 'Cancelled';
        default: return 'Unknown';
    }
}

function loadOrderStats() {
    fetch('/api/orders/stats', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to load order statistics');
    })
    .then(stats => {
        document.getElementById('total-orders').textContent = stats.total_orders.toLocaleString();
        document.getElementById('completed-orders').textContent = stats.completed_orders.toLocaleString();
        document.getElementById('pending-orders').textContent = stats.pending_orders.toLocaleString();
        document.getElementById('total-revenue').textContent = `UGX ${Math.round(stats.total_revenue).toLocaleString('en-UG')}`;
    })
    .catch(error => {
        console.error('Error loading order statistics:', error);
        // Fallback to showing 0s
        document.getElementById('total-orders').textContent = '0';
        document.getElementById('completed-orders').textContent = '0';
        document.getElementById('pending-orders').textContent = '0';
        document.getElementById('total-revenue').textContent = 'UGX 0';
    });
}

function viewOrder(orderId) {
    // Fetch order details and show in modal
    fetch(`/api/orders/${orderId}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to fetch order details');
    })
    .then(order => {
        showViewOrderModal(order);
    })
    .catch(error => {
        console.error('Error fetching order:', error);
        showToast('Failed to load order details', 'error');
    });
}

function printOrder(orderId) {
    // Fetch order details and show receipt modal
    fetch(`/api/orders/${orderId}`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Failed to fetch order details');
    })
    .then(order => {
        showOrderReceipt(order);
    })
    .catch(error => {
        console.error('Error fetching order:', error);
        showToast('Failed to fetch order details for printing', 'error');
    });
}

function showOrderReceipt(order) {
    const receiptModal = document.getElementById('receipt-modal');
    const receiptContent = document.getElementById('receipt-content');

    // Generate receipt HTML
    const receiptHTML = generateOrderReceiptHTML(order);
    receiptContent.innerHTML = receiptHTML;

    // Show modal
    receiptModal.style.display = 'flex';
}

function exportOrders() {
    // Show export modal
    showExportModal();
}

function showExportModal() {
    const modal = document.getElementById('export-modal');

    // Set default dates (optional - you can remove this if you want them empty by default)
    const today = new Date().toISOString().split('T')[0];
    const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

    // Uncomment these lines if you want default date range
    // document.getElementById('export-date-from').value = oneWeekAgo;
    // document.getElementById('export-date-to').value = today;

    modal.style.display = 'flex';

    // Focus on the first input
    setTimeout(() => {
        document.getElementById('export-date-from').focus();
    }, 100);
}

function closeExportModal() {
    const modal = document.getElementById('export-modal');
    modal.style.display = 'none';

    // Clear the form
    document.getElementById('export-date-from').value = '';
    document.getElementById('export-date-to').value = '';
}

function performExport() {
    const dateFrom = document.getElementById('export-date-from').value;
    const dateTo = document.getElementById('export-date-to').value;
    const exportBtn = document.getElementById('export-confirm-btn');

    // Show loading state
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin text-sm"></i><span class="ml-2">Exporting...</span>';
    exportBtn.disabled = true;

    // Build URL with date parameters
    let exportUrl = '/api/orders/export';
    const params = new URLSearchParams();

    if (dateFrom) {
        params.append('date_from', dateFrom);
    }
    if (dateTo) {
        params.append('date_to', dateTo);
    }

    if (params.toString()) {
        exportUrl += '?' + params.toString();
    }

    // Create a temporary link to download the CSV
    fetch(exportUrl, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Failed to export orders');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        // Generate filename with date range
        let filename = 'orders_export';
        if (dateFrom && dateTo) {
            filename += `_${dateFrom}_to_${dateTo}`;
        } else if (dateFrom) {
            filename += `_from_${dateFrom}`;
        } else if (dateTo) {
            filename += `_until_${dateTo}`;
        } else {
            filename += `_${new Date().toISOString().split('T')[0]}`;
        }
        filename += '.csv';

        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        // Close modal and show success message
        closeExportModal();

        let message = 'Orders exported successfully';
        if (dateFrom && dateTo) {
            message += ` (${dateFrom} to ${dateTo})`;
        } else if (dateFrom) {
            message += ` (from ${dateFrom})`;
        } else if (dateTo) {
            message += ` (until ${dateTo})`;
        }

        showToast(message, 'success');
    })
    .catch(error => {
        console.error('Error exporting orders:', error);
        showToast('Failed to export orders', 'error');
    })
    .finally(() => {
        // Restore button state
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    });
}

function clearFilters() {
    document.getElementById('search-orders').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    currentPage = 1;
    allOrders = [];
    loadOrders();
    showToast('Filters cleared', 'success');
}

// Infinite scroll functionality
function setupInfiniteScroll() {
    // Create a sentinel element to observe
    const sentinel = document.createElement('div');
    sentinel.id = 'scroll-sentinel';
    sentinel.style.height = '1px';

    // Insert sentinel before the end message
    const endMessage = document.querySelector('#end-message');
    if (endMessage && endMessage.parentNode) {
        endMessage.parentNode.insertBefore(sentinel, endMessage);
    }

    // Use Intersection Observer for better performance
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && currentPage < totalPages && !isLoading) {
                loadOrders(currentPage + 1, true);
            }
        });
    }, {
        root: null,
        rootMargin: '100px', // Load when sentinel is 100px away from viewport
        threshold: 0
    });

    observer.observe(sentinel);

    // Fallback scroll detection for table container
    const tableContainer = document.querySelector('.overflow-x-auto');
    if (tableContainer) {
        tableContainer.addEventListener('scroll', function() {
            const { scrollTop, scrollHeight, clientHeight } = this;

            // Check if user has scrolled to near the bottom
            if (scrollTop + clientHeight >= scrollHeight - 100) {
                if (currentPage < totalPages && !isLoading) {
                    loadOrders(currentPage + 1, true);
                }
            }
        });
    }
}

function printOrderReceipt() {
    const receiptContent = document.getElementById('receipt-content').innerHTML;
    const printWindow = window.open('', '_blank');

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receipt - Order</title>
            <style>
                body {
                    font-family: 'Courier New', monospace;
                    font-size: 12px;
                    line-height: 1.4;
                    max-width: 300px;
                    margin: 0 auto;
                    padding: 10px;
                }
                .receipt-header h2 {
                    font-size: 16px;
                    margin: 0 0 5px 0;
                }
                .text-center { text-align: center; }
                .text-right { text-align: right; }
                .flex {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 2px;
                }
                .border-b {
                    border-bottom: 1px solid #000;
                    margin: 5px 0;
                }
                .font-bold { font-weight: bold; }
                .text-lg { font-size: 14px; }
                .mb-1 { margin-bottom: 2px; }
                .mb-2 { margin-bottom: 5px; }
                .mb-4 { margin-bottom: 10px; }
                .mt-4 { margin-top: 10px; }
                .pt-2 { padding-top: 5px; }
                .text-xs { font-size: 10px; }
                .text-sm { font-size: 11px; }
                .text-gray-500 { color: #666; }
                .text-gray-600 { color: #555; }
                .text-green-600 { color: #059669; }
                .flex-1 { flex: 1; }
                @media print {
                    body { margin: 0; padding: 5px; }
                }
            </style>
        </head>
        <body>
            ${receiptContent}
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();

    showToast('Receipt sent to printer', 'success');
}

function closeOrderReceipt() {
    document.getElementById('receipt-modal').style.display = 'none';
}

let currentOrderForModal = null;

function showViewOrderModal(order) {
    currentOrderForModal = order;
    const modal = document.getElementById('view-order-modal');
    const content = document.getElementById('order-details-content');

    // Generate order details HTML
    const orderDetailsHTML = generateOrderDetailsHTML(order);
    content.innerHTML = orderDetailsHTML;

    // Show modal
    modal.style.display = 'flex';
}

function closeViewOrder() {
    document.getElementById('view-order-modal').style.display = 'none';
    currentOrderForModal = null;
}

function printOrderFromModal() {
    if (currentOrderForModal) {
        showOrderReceipt(currentOrderForModal);
    }
}

function generateOrderReceiptHTML(order) {
    const orderDate = new Date(order.created_at);
    const receiptDate = orderDate.toLocaleDateString('en-UG', {
        timeZone: 'Africa/Kampala'
    });
    const receiptTime = orderDate.toLocaleTimeString('en-UG', {
        timeZone: 'Africa/Kampala',
        hour12: false
    });

    return `
        <div class="receipt-header text-center mb-4">
            <h2 class="text-xl font-bold">INVENTORY SYSTEM</h2>
            <p class="text-sm text-gray-600">Order Receipt</p>
            <div class="border-b border-gray-300 my-2"></div>
        </div>

        <div class="receipt-info text-sm mb-4">
            <div class="flex justify-between">
                <span>Date:</span>
                <span>${receiptDate}</span>
            </div>
            <div class="flex justify-between">
                <span>Time:</span>
                <span>${receiptTime}</span>
            </div>
            <div class="flex justify-between">
                <span>Order #:</span>
                <span>${order.order_number}</span>
            </div>
            <div class="flex justify-between">
                <span>Status:</span>
                <span>${getStatusText(order.status)}</span>
            </div>
            <div class="flex justify-between">
                <span>Processed by:</span>
                <span>${order.created_by_name || 'System'}</span>
            </div>
            ${order.client_name && order.client_name !== 'Walk-in Client' ? `
            <div class="flex justify-between">
                <span>Client:</span>
                <span>${order.client_name}</span>
            </div>
            ` : ''}
            ${order.client_phone ? `
            <div class="flex justify-between">
                <span>Phone:</span>
                <span>${order.client_phone}</span>
            </div>
            ` : ''}
            <div class="border-b border-gray-300 my-2"></div>
        </div>

        <div class="receipt-items mb-4">
            <div class="text-sm font-semibold mb-2">ITEMS:</div>
            ${order.items && order.items.length > 0 ? order.items.map(item => `
                <div class="text-sm mb-2">
                    <div class="flex justify-between">
                        <div class="flex-1">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.sku}</div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-1">
                        <div>${item.quantity} x UGX ${Math.round(item.price).toLocaleString('en-UG')}</div>
                        <div class="font-medium">UGX ${Math.round(item.total).toLocaleString('en-UG')}</div>
                    </div>
                </div>
            `).join('') : '<div class="text-sm text-gray-500">No items found</div>'}
            <div class="border-b border-gray-300 my-2"></div>
        </div>

        <div class="receipt-totals text-sm mb-4">
            <div class="flex justify-between">
                <span>Subtotal:</span>
                <span>UGX ${Math.round(order.subtotal || 0).toLocaleString('en-UG')}</span>
            </div>
            ${order.discount && order.discount > 0 ? `
            <div class="flex justify-between text-green-600">
                <span>Discount:</span>
                <span>-UGX ${Math.round(order.discount).toLocaleString('en-UG')}</span>
            </div>
            ` : ''}
            ${order.tax && order.tax > 0 ? `
            <div class="flex justify-between">
                <span>Tax:</span>
                <span>UGX ${Math.round(order.tax).toLocaleString('en-UG')}</span>
            </div>
            ` : ''}
            <div class="flex justify-between font-bold text-lg border-t border-gray-300 pt-2">
                <span>TOTAL:</span>
                <span>UGX ${Math.round(order.total || 0).toLocaleString('en-UG')}</span>
            </div>
        </div>

        <div class="receipt-payment text-sm mb-4">
            <div class="border-b border-gray-300 my-2"></div>
            <div class="flex justify-between">
                <span>Payment Method:</span>
                <span>${order.payment_method === 'cash' ? 'Cash' : order.payment_method === 'mobile_money' ? 'Mobile Money' : 'Card'}</span>
            </div>
            <div class="flex justify-between">
                <span>Payment Status:</span>
                <span>${order.payment_status === 'paid' ? 'Paid' : 'Pending'}</span>
            </div>
        </div>

        ${order.notes ? `
        <div class="receipt-notes text-sm mb-4">
            <div class="border-b border-gray-300 my-2"></div>
            <div class="text-xs font-semibold mb-1">NOTES:</div>
            <div class="text-xs">${order.notes}</div>
        </div>
        ` : ''}

        <div class="receipt-footer text-center text-xs text-gray-500 mt-4">
            <div class="border-b border-gray-300 my-2"></div>
            <p>Thank you for your business!</p>
            <p>Please keep this receipt for your records</p>
            <p class="mt-2">Order ID: ${order.id}</p>
        </div>
    `;
}

function generateOrderDetailsHTML(order) {
    const orderDate = new Date(order.created_at);
    const formattedDate = orderDate.toLocaleDateString('en-UG');
    const formattedTime = orderDate.toLocaleTimeString('en-UG');

    return `
        <!-- Order Header -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 sm:p-6 border border-blue-200">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                <div>
                    <h4 class="text-base sm:text-lg font-bold text-gray-900 mb-3">Order Information</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Order Number:</span>
                            <span class="text-sm font-bold text-gray-900">${order.order_number}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Date:</span>
                            <span class="text-sm text-gray-900">${formattedDate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Time:</span>
                            <span class="text-sm text-gray-900">${formattedTime}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Status:</span>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(order.status)}">
                                ${getStatusText(order.status)}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Processed by:</span>
                            <span class="text-sm text-gray-900">${order.created_by_name || 'System'}</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-base sm:text-lg font-bold text-gray-900 mb-3">Client Information</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Name:</span>
                            <span class="text-sm text-gray-900">${order.client_name}</span>
                        </div>
                        ${order.client_phone ? `
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Phone:</span>
                            <span class="text-sm text-gray-900">${order.client_phone}</span>
                        </div>
                        ` : ''}
                        ${order.client_email ? `
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Email:</span>
                            <span class="text-sm text-gray-900">${order.client_email}</span>
                        </div>
                        ` : ''}
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Payment Method:</span>
                            <span class="text-sm text-gray-900">${order.payment_method === 'cash' ? 'Cash' : order.payment_method === 'mobile_money' ? 'Mobile Money' : 'Card'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm font-medium text-gray-600">Payment Status:</span>
                            <span class="text-sm text-gray-900">${order.payment_status === 'paid' ? 'Paid' : 'Pending'}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="bg-white rounded-xl border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h4 class="text-lg font-bold text-gray-900">Order Items</h4>
            </div>
            <div class="p-6">
                ${order.items && order.items.length > 0 ? `
                <div class="space-y-4">
                    ${order.items.map(item => `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                        <i class="fas fa-box text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h5 class="font-semibold text-gray-900">${item.name}</h5>
                                        <p class="text-sm text-gray-500">SKU: ${item.sku}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">
                                    ${item.quantity} × UGX ${Math.round(item.price).toLocaleString('en-UG')}
                                </div>
                                <div class="font-semibold text-gray-900">
                                    UGX ${Math.round(item.total).toLocaleString('en-UG')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : '<p class="text-gray-500 text-center py-4">No items found</p>'}
            </div>
        </div>

        <!-- Order Totals -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200">
            <h4 class="text-lg font-bold text-gray-900 mb-4">Order Summary</h4>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-600">Subtotal:</span>
                    <span class="text-sm font-semibold text-gray-900">UGX ${Math.round(order.subtotal || 0).toLocaleString('en-UG')}</span>
                </div>
                ${order.discount && order.discount > 0 ? `
                <div class="flex justify-between text-green-600">
                    <span class="text-sm font-medium">Discount:</span>
                    <span class="text-sm font-semibold">-UGX ${Math.round(order.discount).toLocaleString('en-UG')}</span>
                </div>
                ` : ''}
                ${order.tax && order.tax > 0 ? `
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-600">Tax:</span>
                    <span class="text-sm font-semibold text-gray-900">UGX ${Math.round(order.tax).toLocaleString('en-UG')}</span>
                </div>
                ` : ''}
                <div class="border-t border-green-200 pt-3">
                    <div class="flex justify-between">
                        <span class="text-lg font-bold text-gray-900">Total:</span>
                        <span class="text-lg font-bold text-green-600">UGX ${Math.round(order.total || 0).toLocaleString('en-UG')}</span>
                    </div>
                </div>
            </div>
        </div>

        ${order.notes ? `
        <!-- Order Notes -->
        <div class="bg-yellow-50 rounded-xl p-6 border border-yellow-200">
            <h4 class="text-lg font-bold text-gray-900 mb-3">Order Notes</h4>
            <p class="text-sm text-gray-700">${order.notes}</p>
        </div>
        ` : ''}
    `;
}

// Load orders on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
    loadOrderStats();
    setupInfiniteScroll();

    // Add event listeners for filters
    document.getElementById('search-orders').addEventListener('input', debounce(function() {
        currentPage = 1;
        allOrders = [];
        loadOrders();
    }, 500));

    document.getElementById('status-filter').addEventListener('change', function() {
        currentPage = 1;
        allOrders = [];
        loadOrders();
    });

    document.getElementById('date-from').addEventListener('change', function() {
        currentPage = 1;
        allOrders = [];
        loadOrders();
    });

    document.getElementById('date-to').addEventListener('change', function() {
        currentPage = 1;
        allOrders = [];
        loadOrders();
    });

    // Check for success/error messages in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const successMessage = urlParams.get('success');
    const errorMessage = urlParams.get('error');

    if (successMessage) {
        showToast(successMessage, 'success');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    if (errorMessage) {
        showToast(errorMessage, 'error');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

// Debounce function for search input
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Keyboard event handling for modals
document.addEventListener('keydown', function(event) {
    // Close export modal with Escape key
    if (event.key === 'Escape') {
        const exportModal = document.getElementById('export-modal');
        if (exportModal && exportModal.style.display === 'flex') {
            closeExportModal();
        }
    }

    // Submit export with Enter key when modal is open
    if (event.key === 'Enter') {
        const exportModal = document.getElementById('export-modal');
        if (exportModal && exportModal.style.display === 'flex') {
            const exportBtn = document.getElementById('export-confirm-btn');
            if (exportBtn && !exportBtn.disabled) {
                performExport();
            }
        }
    }
});

// Click outside modal to close
document.addEventListener('click', function(event) {
    const exportModal = document.getElementById('export-modal');
    if (exportModal && exportModal.style.display === 'flex') {
        if (event.target === exportModal) {
            closeExportModal();
        }
    }
});
</script>

<!-- Export Orders Modal -->
<div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md">
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center mr-2">
                        <i class="fas fa-download text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-gray-900">Export Orders</h3>
                        <p class="text-xs text-gray-600">Select date range for export</p>
                    </div>
                </div>
                <button onclick="closeExportModal()" class="w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 hover:text-gray-700 transition-all duration-200">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>

            <div class="space-y-3">
                <div>
                    <label for="export-date-from" class="block text-xs font-medium text-gray-700 mb-1">From Date (Optional)</label>
                    <input type="date" id="export-date-from" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                    <p class="text-xs text-gray-500 mt-0.5">Leave empty to export from the beginning</p>
                </div>

                <div>
                    <label for="export-date-to" class="block text-xs font-medium text-gray-700 mb-1">To Date (Optional)</label>
                    <input type="date" id="export-date-to" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-200">
                    <p class="text-xs text-gray-500 mt-0.5">Leave empty to export until today</p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-2">
                    <div class="flex items-start">
                        <div class="w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center mr-2 mt-0.5 flex-shrink-0">
                            <i class="fas fa-info text-white text-xs"></i>
                        </div>
                        <div class="text-xs text-blue-800">
                            <p class="font-medium mb-1">Export Information</p>
                            <ul class="text-xs space-y-0.5">
                                <li>• Export includes detailed item information</li>
                                <li>• Date format: YYYY-MM-DD (e.g., 2025-07-29)</li>
                                <li>• Both dates are optional and inclusive</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex space-x-2 mt-4">
                <button onclick="closeExportModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-xs font-medium transition-all duration-200">
                    Cancel
                </button>
                <button onclick="performExport()" id="export-confirm-btn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-all duration-200 flex items-center justify-center space-x-1">
                    <i class="fas fa-download text-xs"></i>
                    <span>Export</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Order Modal -->
<div id="view-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-screen overflow-hidden flex flex-col">
        <div class="p-4 sm:p-6 flex-shrink-0">
            <div class="flex justify-between items-start mb-4 sm:mb-6">
                <div class="flex items-center flex-1 min-w-0">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-2 sm:mr-3 flex-shrink-0">
                        <i class="fas fa-eye text-white text-sm sm:text-lg"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h3 class="text-lg sm:text-xl font-bold text-gray-900 truncate">Order Details</h3>
                        <p class="text-xs sm:text-sm text-gray-600 hidden sm:block">Complete order information</p>
                    </div>
                </div>
                <button onclick="closeViewOrder()" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 hover:text-gray-700 transition-all duration-200 flex-shrink-0 ml-2">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-4 sm:px-6">
            <div id="order-details-content" class="space-y-4 sm:space-y-6 pb-4">
                <!-- Order details will be loaded here -->
            </div>
        </div>

        <div class="flex-shrink-0 p-4 sm:p-6 border-t border-gray-200 bg-gray-50">
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="printOrderFromModal()"
                        class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-4 sm:px-6 py-3 rounded-xl flex items-center justify-center space-x-2 transition-all duration-200 shadow-md hover:shadow-lg">
                    <i class="fas fa-print text-sm"></i>
                    <span class="font-medium">Print Receipt</span>
                </button>
                <button onclick="closeViewOrder()"
                        class="px-4 sm:px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl flex items-center justify-center space-x-2 transition-all duration-200">
                    <i class="fas fa-times text-sm"></i>
                    <span class="font-medium">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 max-h-screen overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-3">
                        <i class="fas fa-receipt text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Order Receipt</h3>
                        <p class="text-sm text-gray-600">Review and print receipt</p>
                    </div>
                </div>
                <button onclick="closeOrderReceipt()" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 hover:text-gray-700 transition-all duration-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="receipt-content" class="border-2 border-gray-200 rounded-xl p-6 bg-white font-mono text-sm shadow-inner">
                <!-- Receipt content will be generated here -->
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="printOrderReceipt()"
                        class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl flex items-center justify-center space-x-2 transition-all duration-200 shadow-md hover:shadow-lg">
                    <i class="fas fa-print text-sm"></i>
                    <span class="font-medium">Print Receipt</span>
                </button>
                <button onclick="closeOrderReceipt()"
                        class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl flex items-center justify-center space-x-2 transition-all duration-200">
                    <i class="fas fa-times text-sm"></i>
                    <span class="font-medium">Close</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
